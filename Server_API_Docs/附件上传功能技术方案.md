# é™„ä»¶ä¸Šä¼ åŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆ - è¯¦ç»†å®ç°è®¡åˆ’

## ğŸ¯ **é¡¹ç›®æ¦‚è¿°**

ä¸ºç°æœ‰çš„å¤šæ¨¡å‹AIèŠå¤©ç³»ç»Ÿï¼ˆGeminiã€GPTã€Claudeï¼‰é›†æˆé™„ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œæ”¯æŒå¤šæ¨¡æ€è¾“å…¥ï¼Œå……åˆ†åˆ©ç”¨å„æ¨¡å‹çš„å®˜æ–¹é™„ä»¶è§£æèƒ½åŠ›ã€‚

**ğŸ”§ å½“å‰å®ç°ç­–ç•¥**ï¼šé‡‡ç”¨Base64å†…åµŒæ–¹å¼å¤„ç†é™„ä»¶ï¼Œç®€åŒ–å®ç°å¤æ‚åº¦ï¼Œç¡®ä¿å¿«é€Ÿéƒ¨ç½²ã€‚æœªæ¥å¯æ‰©å±•è‡³Gemini File APIç­‰é«˜çº§åŠŸèƒ½ã€‚

---

## ğŸ“‹ **åŠŸèƒ½éœ€æ±‚åˆ†æ**

### **æ ¸å¿ƒåŠŸèƒ½**
1. **æ–‡ä»¶ä¸Šä¼ æ”¯æŒ**
   - æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼ˆå›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘ã€è§†é¢‘ï¼‰
   - æ–‡ä»¶å¤§å°é™åˆ¶å’Œç±»å‹éªŒè¯
   - æ‰¹é‡ä¸Šä¼ æ”¯æŒ

2. **å¤šæ¨¡æ€AIäº¤äº’**
   - Gemini Vision APIé›†æˆï¼ˆBase64å†…åµŒç­–ç•¥ï¼‰
   - GPT-4oå¤šæ¨¡æ€æ”¯æŒï¼ˆBase64å†…åµŒç­–ç•¥ï¼‰
   - Claudeå¤šæ¨¡æ€èƒ½åŠ›ï¼ˆé¢„ç•™ï¼Œæ–‡æœ¬æè¿°ï¼‰

3. **æ–‡ä»¶ç®¡ç†**
   - æ–‡ä»¶å­˜å‚¨å’Œæ£€ç´¢
   - ä¼šè¯å…³è”ç®¡ç†
   - æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

### **æŠ€æœ¯ç›®æ ‡**
- æ”¯æŒæœ€å¤§50MBæ–‡ä»¶ä¸Šä¼ 
- æ”¯æŒæœ€å¤š10ä¸ªæ–‡ä»¶åŒæ—¶ä¸Šä¼ 
- å®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- æ™ºèƒ½æ–‡ä»¶ç±»å‹è¯†åˆ«
- å®‰å…¨çš„æ–‡ä»¶å¤„ç†æµç¨‹

---

## ğŸ—ï¸ **æŠ€æœ¯æ¶æ„è®¾è®¡**

### **ç³»ç»Ÿæ¶æ„å›¾**
```
å‰ç«¯ (React) â†’ åç«¯ (Express) â†’ æ–‡ä»¶å¤„ç† â†’ AIæ¨¡å‹API
    â†“              â†“              â†“           â†“
æ–‡ä»¶é€‰æ‹© â†’ ä¸Šä¼ ä¸­é—´ä»¶ â†’ æ–‡ä»¶å­˜å‚¨ â†’ å¤šæ¨¡æ€è¯·æ±‚
    â†“              â†“              â†“           â†“
è¿›åº¦æ˜¾ç¤º â†’ æ ¼å¼è½¬æ¢ â†’ æ•°æ®åº“å­˜å‚¨ â†’ AIå“åº”
```

### **æ¸è¿›å¼å®æ–½ç­–ç•¥**

#### **ğŸ¯ ç¬¬ä¸€é˜¶æ®µï¼šMVPåŸºç¡€åŠŸèƒ½ï¼ˆå½“å‰å®ç°ï¼‰**
- **ç›®æ ‡ç”¨æˆ·**ï¼š< 50 å¹¶å‘ç”¨æˆ·
- **æ ¸å¿ƒåŠŸèƒ½**ï¼šæ–‡ä»¶ä¸Šä¼  + åŸºç¡€AIäº¤äº’
- **æŠ€æœ¯æ ˆ**ï¼š
  - æ–‡ä»¶ä¸Šä¼ ï¼šMulterï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
  - æ–‡ä»¶å­˜å‚¨ï¼šæœ¬åœ°å­˜å‚¨
  - æµ‹è¯•ï¼šJest + React Testing Library
  - æ€§èƒ½ï¼šåŸºç¡€å‹ç¼© + ç®€å•é™æµ

#### **ğŸ“ˆ ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å¢å¼ºï¼ˆæœªæ¥æ‰©å±•ï¼‰**
- **ç›®æ ‡ç”¨æˆ·**ï¼š50-500 å¹¶å‘ç”¨æˆ·
- **å¢å¼ºåŠŸèƒ½**ï¼šäº‘å­˜å‚¨ + é«˜çº§æµ‹è¯• + ç¼“å­˜
- **æŠ€æœ¯æ ˆ**ï¼š
  - æ–‡ä»¶å­˜å‚¨ï¼š+ AWS S3æ”¯æŒ
  - æµ‹è¯•ï¼š+ Puppeteerç«¯åˆ°ç«¯æµ‹è¯•
  - æ€§èƒ½ï¼š+ Redisç¼“å­˜ + æ–‡ä»¶åˆ†ç‰‡

#### **ğŸš€ ç¬¬ä¸‰é˜¶æ®µï¼šä¼ä¸šçº§éƒ¨ç½²ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰**
- **ç›®æ ‡ç”¨æˆ·**ï¼š500+ å¹¶å‘ç”¨æˆ·
- **ä¼ä¸šåŠŸèƒ½**ï¼šé›†ç¾¤éƒ¨ç½² + é«˜çº§ç›‘æ§
- **æŠ€æœ¯æ ˆ**ï¼š
  - éƒ¨ç½²ï¼š+ Node.jsé›†ç¾¤
  - ç›‘æ§ï¼š+ ä¼ä¸šçº§ç›‘æ§å‘Šè­¦
  - æ€§èƒ½ï¼š+ CDN + è´Ÿè½½å‡è¡¡

### **å½“å‰æŠ€æœ¯æ ˆï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰**
- **æ–‡ä»¶ä¸Šä¼ **: Multerï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
- **æ–‡ä»¶å­˜å‚¨**: æœ¬åœ°å­˜å‚¨ï¼ˆå½“å‰å®ç°ï¼‰ + AWS S3ï¼ˆç¬¬äºŒé˜¶æ®µæ‰©å±•ï¼‰
- **å›¾ç‰‡å¤„ç†**: Sharp
- **æ–‡ä»¶æ ¼å¼**: æ”¯æŒJPEGã€PNGã€GIFã€WebPã€PDFã€TXTã€DOCã€DOCX
- **æ•°æ®åº“**: SQLiteï¼ˆæ‰©å±•è¡¨ç»“æ„ï¼‰

---

## ğŸ“ **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½æ­å»º**

### **1.1 ä¾èµ–åŒ…å®‰è£…ï¼ˆåˆ†é˜¶æ®µç®¡ç†ï¼‰**

#### **ç¬¬ä¸€é˜¶æ®µï¼šå¿…éœ€ä¾èµ–ï¼ˆç«‹å³å®‰è£…ï¼‰**
```bash
# æ ¸å¿ƒåŠŸèƒ½å¿…éœ€
npm install multer@1.4.5-lts.1 sharp@0.32.6 uuid@9.0.1

# åŸºç¡€æ€§èƒ½ä¼˜åŒ–
npm install compression@1.7.4 express-rate-limit@6.10.0

# å½“å‰é¡¹ç›®å·²æœ‰ä¾èµ–ï¼ˆç¡®è®¤ç‰ˆæœ¬ï¼‰
# express (æ£€æŸ¥ç°æœ‰ç‰ˆæœ¬ï¼Œå»ºè®®4.18.2+)
# better-sqlite3 (æ£€æŸ¥ç°æœ‰ç‰ˆæœ¬ï¼Œå»ºè®®8.7.0+)
```

#### **ç¬¬ä¸€é˜¶æ®µï¼šå¯é€‰ä¾èµ–ï¼ˆæŒ‰éœ€å®‰è£…ï¼‰**
```bash
# æ–‡ä»¶ç±»å‹æ£€æµ‹å¢å¼ºï¼ˆæ¨èï¼‰
npm install file-type@18.7.0 mime-types@2.1.35

# æ–‡æ¡£å¤„ç†åŠŸèƒ½ï¼ˆå¦‚éœ€æ”¯æŒPDF/Wordï¼‰
npm install pdf-parse@1.1.1 mammoth@1.6.0

# æµ‹è¯•ç›¸å…³ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npm install --save-dev supertest@6.3.3 jest@29.7.0
```

#### **ç¬¬äºŒé˜¶æ®µï¼šæ‰©å±•ä¾èµ–ï¼ˆæœªæ¥å®‰è£…ï¼‰**
```bash
# äº‘å­˜å‚¨æ”¯æŒï¼ˆç¬¬äºŒé˜¶æ®µåŠŸèƒ½ï¼‰
# npm install multer-s3@3.0.1 aws-sdk@2.1479.0

# é«˜çº§ç¼“å­˜ï¼ˆç¬¬äºŒé˜¶æ®µåŠŸèƒ½ï¼‰
# npm install ioredis@5.3.2

# ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç¬¬äºŒé˜¶æ®µåŠŸèƒ½ï¼‰
# npm install --save-dev puppeteer@21.3.8
```

#### **ä¾èµ–è¯´æ˜å’Œç‰ˆæœ¬è¦æ±‚**

**ğŸ”§ æ ¸å¿ƒä¾èµ–ï¼ˆå¿…éœ€ï¼‰**ï¼š
- `multer@1.4.5-lts.1`: æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶ï¼Œä½¿ç”¨LTSç‰ˆæœ¬ç¡®ä¿ç¨³å®šæ€§
- `sharp@0.32.6`: å›¾ç‰‡å¤„ç†ï¼Œé«˜æ€§èƒ½C++åº“ï¼Œéœ€è¦ç¼–è¯‘ç¯å¢ƒ
- `uuid@9.0.1`: ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ŒV4ç®—æ³•
- `compression@1.7.4`: Gzipå‹ç¼©ä¸­é—´ä»¶
- `express-rate-limit@6.10.0`: APIé™æµä¿æŠ¤

**ğŸ“¦ å¯é€‰ä¾èµ–ï¼ˆæŒ‰éœ€ï¼‰**ï¼š
- `file-type@18.7.0`: æ–‡ä»¶ç±»å‹æ£€æµ‹ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼
- `mime-types@2.1.35`: MIMEç±»å‹ç®¡ç†
- `pdf-parse@1.1.1`: PDFæ–‡æœ¬æå–ï¼Œçº¯JSå®ç°
- `mammoth@1.6.0`: Wordæ–‡æ¡£å¤„ç†ï¼Œæ”¯æŒ.docxæ ¼å¼

**ğŸš€ æ‰©å±•ä¾èµ–ï¼ˆæœªæ¥ï¼‰**ï¼š
- `multer-s3@3.0.1`: AWS S3å­˜å‚¨æ”¯æŒ
- `ioredis@5.3.2`: Rediså®¢æˆ·ç«¯ï¼Œæ”¯æŒé›†ç¾¤
- `puppeteer@21.3.8`: æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•

#### **ç¯å¢ƒå…¼å®¹æ€§è¦æ±‚**
- **Node.js**: 16.14.0+ (æ¨è18.18.0+)
- **npm**: 8.0.0+ (æ¨è9.0.0+)
- **ç³»ç»Ÿ**: Linux/macOS/Windowsï¼ˆsharpéœ€è¦ç¼–è¯‘ç¯å¢ƒï¼‰

### **1.2 ç›®å½•ç»“æ„åˆ›å»º**
```bash
# åˆ›å»ºä¸Šä¼ ç›¸å…³ç›®å½•
mkdir -p uploads/temp          # ä¸´æ—¶æ–‡ä»¶å­˜å‚¨
mkdir -p uploads/processed     # å¤„ç†åçš„æ–‡ä»¶
mkdir -p uploads/attachments   # æœ€ç»ˆé™„ä»¶å­˜å‚¨
mkdir -p uploads/thumbnails    # ç¼©ç•¥å›¾å­˜å‚¨
mkdir -p uploads/logs          # ä¸Šä¼ æ—¥å¿—
```

### **1.3 ç¯å¢ƒå˜é‡é…ç½®**
```bash
# .env æ–‡ä»¶æ·»åŠ 
UPLOAD_MAX_SIZE=52428800        # 50MB in bytes
UPLOAD_MAX_FILES=10             # æœ€å¤§æ–‡ä»¶æ•°é‡
UPLOAD_ALLOWED_TYPES=image,document,audio,video
UPLOAD_TEMP_DIR=uploads/temp
UPLOAD_PROCESSED_DIR=uploads/processed
UPLOAD_ATTACHMENTS_DIR=uploads/attachments

# AWS S3é…ç½®ï¼ˆå¯é€‰ï¼‰
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1
AWS_S3_BUCKET=your-bucket-name

---

## âš ï¸ **ç¬¬ä¸€é˜¶æ®µé—ç•™é—®é¢˜ä¸æ”¹è¿›å»ºè®®**

### **1. å­˜å‚¨ç­–ç•¥è°ƒæ•´**
åŸºäºé¡¹ç›®å®é™…æƒ…å†µï¼Œæˆ‘ä»¬é‡‡ç”¨**æ¸è¿›å¼å­˜å‚¨ç­–ç•¥**ï¼š

#### **1.1 å½“å‰å®ç°ï¼šæœ¬åœ°å­˜å‚¨**
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæ•´å®ç°
- **å­˜å‚¨ä½ç½®**ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„`uploads/`æ–‡ä»¶å¤¹
- **é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ä¸­å°å‹åº”ç”¨
- **ä¼˜åŠ¿**ï¼šéƒ¨ç½²ç®€å•ã€æ— å¤–éƒ¨ä¾èµ–ã€å¼€å‘è°ƒè¯•æ–¹ä¾¿

#### **1.2 æœªæ¥æ‰©å±•ï¼šäº‘å­˜å‚¨æ”¯æŒ**
- **å®ç°çŠ¶æ€**ï¼šğŸ“‹ è®¡åˆ’ä¸­ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- **ç›®æ ‡**ï¼šæ”¯æŒAWS S3ç­‰äº‘å­˜å‚¨æœåŠ¡
- **å®ç°æ–¹å¼**ï¼šæŠ½è±¡å­˜å‚¨æ¥å£ï¼Œæ”¯æŒæœ¬åœ°å’Œäº‘å­˜å‚¨åˆ‡æ¢
- **é…ç½®æ–¹å¼**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶å­˜å‚¨ç­–ç•¥

#### **1.3 å­˜å‚¨ç­–ç•¥é…ç½®**
```bash
# å­˜å‚¨ç­–ç•¥é…ç½®
STORAGE_STRATEGY=local                    # local | s3 | hybrid
USE_LOCAL_STORAGE=true                    # æ˜¯å¦å¯ç”¨æœ¬åœ°å­˜å‚¨
USE_CLOUD_STORAGE=false                   # æ˜¯å¦å¯ç”¨äº‘å­˜å‚¨
LOCAL_STORAGE_MAX_SIZE=1073741824         # æœ¬åœ°å­˜å‚¨æœ€å¤§å®¹é‡ï¼ˆ1GBï¼‰
LOCAL_STORAGE_MAX_FILE_SIZE=52428800      # å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆ50MBï¼‰
```

### **2. ä¾èµ–åŒ…å…¼å®¹æ€§é—®é¢˜**

#### **2.1 ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**
- **Node.jsç‰ˆæœ¬è¦æ±‚**ï¼šå»ºè®®ä½¿ç”¨Node.js 16+ï¼Œç¡®ä¿sharpåŒ…å…¼å®¹æ€§
- **åŒ…ç‰ˆæœ¬å†²çª**ï¼šéœ€è¦æ£€æŸ¥ç°æœ‰é¡¹ç›®æ˜¯å¦å·²æœ‰multerã€sharpç­‰åŒ…
- **ä¾èµ–å†²çª**ï¼šæŸäº›åŒ…å¯èƒ½ä¸ç°æœ‰é¡¹ç›®ä¾èµ–å†²çª

#### **2.2 æ¸è¿›å¼ä¾èµ–å®‰è£…**
```bash
# å‚è€ƒ 1.1 èŠ‚çš„åˆ†é˜¶æ®µä¾èµ–å®‰è£…æŒ‡å—
# æ ¸å¿ƒä¾èµ–å·²åœ¨ç¬¬ä¸€é˜¶æ®µå®‰è£…å®Œæˆ
npm list multer sharp uuid compression express-rate-limit
```

### **3. ç³»ç»Ÿç¯å¢ƒè¦æ±‚**

#### **3.1 æ“ä½œç³»ç»Ÿå…¼å®¹æ€§**
- **Windows**ï¼šsharpåŒ…å¯èƒ½éœ€è¦é¢å¤–çš„äºŒè¿›åˆ¶æ–‡ä»¶
- **macOS**ï¼šé€šå¸¸å…¼å®¹æ€§è¾ƒå¥½
- **Linux**ï¼šéœ€è¦ç¡®ä¿ç³»ç»Ÿåº“ä¾èµ–å®Œæ•´

#### **3.2 å†…å­˜å’Œå­˜å‚¨è¦æ±‚**
- **æœ€å°å†…å­˜**ï¼šå»ºè®®2GBä»¥ä¸Šï¼Œæ–‡ä»¶å¤„ç†éœ€è¦é¢å¤–å†…å­˜
- **å­˜å‚¨ç©ºé—´**ï¼šæœ¬åœ°å­˜å‚¨éœ€è¦é¢„ç•™è¶³å¤Ÿç£ç›˜ç©ºé—´
- **ä¸´æ—¶æ–‡ä»¶**ï¼šéœ€è¦å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶

### **4. æ€§èƒ½å½±å“è¯„ä¼°**

#### **4.1 åŒ…å¤§å°å½±å“**
- **multer**: ~2MB
- **sharp**: ~15MBï¼ˆåŒ…å«äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
- **uuid**: ~50KB
- **æ€»è®¡**: çº¦17MBï¼ˆä»…æ ¸å¿ƒä¾èµ–ï¼‰

#### **4.2 å¯åŠ¨æ—¶é—´å½±å“**
- **ä¾èµ–åŠ è½½**ï¼šå¢åŠ çº¦1-2ç§’å¯åŠ¨æ—¶é—´
- **æ¨¡å—åˆå§‹åŒ–**ï¼šæ–‡ä»¶å¤„ç†æ¨¡å—åˆå§‹åŒ–çº¦0.5ç§’
- **æ€»ä½“å½±å“**ï¼šå¯åŠ¨æ—¶é—´å¢åŠ çº¦1.5-2.5ç§’

### **5. å¼€å‘å»ºè®®**

#### **5.1 å®æ–½é¡ºåº**
1. **å…ˆå®ç°æœ¬åœ°å­˜å‚¨**ï¼šç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®š
2. **æ·»åŠ é…ç½®æ¥å£**ï¼šä¸ºäº‘å­˜å‚¨é¢„ç•™æ¥å£
3. **æŒ‰éœ€å¯ç”¨äº‘å­˜å‚¨**ï¼šæ ¹æ®å®é™…éœ€æ±‚å†³å®š

#### **5.2 æµ‹è¯•ç­–ç•¥**
1. **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•æ–‡ä»¶å¤„ç†é€»è¾‘
2. **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•å®Œæ•´ä¸Šä¼ æµç¨‹
3. **æ€§èƒ½æµ‹è¯•**ï¼šæµ‹è¯•æ–‡ä»¶å¤§å°å’Œæ•°é‡é™åˆ¶
4. **å…¼å®¹æ€§æµ‹è¯•**ï¼šæµ‹è¯•ä¸åŒæ–‡ä»¶ç±»å‹

#### **5.3 ç›‘æ§å’Œæ—¥å¿—**
1. **æ–‡ä»¶ä¸Šä¼ ç›‘æ§**ï¼šè®°å½•ä¸Šä¼ æˆåŠŸç‡å’Œå¤±è´¥åŸå› 
2. **å­˜å‚¨ç©ºé—´ç›‘æ§**ï¼šç›‘æ§æœ¬åœ°å­˜å‚¨ä½¿ç”¨æƒ…å†µ
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ–‡ä»¶å¤„ç†è€—æ—¶
4. **é”™è¯¯æ—¥å¿—**ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### **6. é£é™©è¯„ä¼°**

#### **6.1 æŠ€æœ¯é£é™©**
- **ä¾èµ–åŒ…ç¨³å®šæ€§**ï¼šsharpåŒ…æ›´æ–°å¯èƒ½å½±å“å…¼å®¹æ€§
- **æ–‡ä»¶å¤„ç†æ€§èƒ½**ï¼šå¤§æ–‡ä»¶å¤„ç†å¯èƒ½å½±å“å“åº”é€Ÿåº¦
- **å­˜å‚¨ç©ºé—´ç®¡ç†**ï¼šæœ¬åœ°å­˜å‚¨éœ€è¦å®šæœŸæ¸…ç†

#### **6.2 ç¼“è§£æªæ–½**
- **ç‰ˆæœ¬é”å®š**ï¼šé”å®šå…³é”®ä¾èµ–åŒ…ç‰ˆæœ¬
- **å¼‚æ­¥å¤„ç†**ï¼šå¤§æ–‡ä»¶å¤„ç†ä½¿ç”¨å¼‚æ­¥æ–¹å¼
- **è‡ªåŠ¨æ¸…ç†**ï¼šå®ç°è‡ªåŠ¨æ¸…ç†ç­–ç•¥
- **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®å­˜å‚¨ç©ºé—´å‘Šè­¦

---

## âœ… **ç¬¬ä¸€é˜¶æ®µå®æ–½Checklist**

### **ğŸ“¦ ä¾èµ–åŒ…å®‰è£…æ£€æŸ¥**
- [x] æ£€æŸ¥Node.jsç‰ˆæœ¬ï¼ˆè¦æ±‚16.14.0+ï¼Œæ¨è18.18.0+ï¼‰
- [x] æ£€æŸ¥npmç‰ˆæœ¬ï¼ˆè¦æ±‚8.0.0+ï¼Œæ¨è9.0.0+ï¼‰
- [x] å®‰è£…æ ¸å¿ƒä¾èµ–ï¼š`multer@1.4.5-lts.1 sharp@0.32.6 uuid@9.0.1`
- [x] å®‰è£…æ€§èƒ½ä¾èµ–ï¼š`compression@1.7.4 express-rate-limit@6.10.0`
- [x] éªŒè¯sharpåŒ…å®‰è£…æˆåŠŸï¼ˆæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¯‘ï¼‰
- [x] æ£€æŸ¥ç°æœ‰é¡¹ç›®ä¾èµ–ç‰ˆæœ¬ï¼ˆexpress, better-sqlite3ï¼‰
- [x] éªŒè¯æ‰€æœ‰ä¾èµ–åŒ…å¯¼å…¥æ­£å¸¸ï¼ˆè¿è¡Œæµ‹è¯•å¯¼å…¥ï¼‰
- [x] æ£€æŸ¥å¯é€‰ä¾èµ–éœ€æ±‚ï¼ˆpdf-parse, mammoth, file-typeï¼‰

### **ğŸ“ ç›®å½•ç»“æ„åˆ›å»ºæ£€æŸ¥**
- [x] åˆ›å»º`uploads/temp`ç›®å½•ï¼ˆä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼‰
- [x] åˆ›å»º`uploads/processed`ç›®å½•ï¼ˆå¤„ç†åçš„æ–‡ä»¶ï¼‰
- [x] åˆ›å»º`uploads/attachments`ç›®å½•ï¼ˆæœ€ç»ˆé™„ä»¶å­˜å‚¨ï¼‰
- [x] åˆ›å»º`uploads/thumbnails`ç›®å½•ï¼ˆç¼©ç•¥å›¾å­˜å‚¨ï¼‰
- [x] åˆ›å»º`uploads/logs`ç›®å½•ï¼ˆä¸Šä¼ æ—¥å¿—ï¼‰
- [x] éªŒè¯ç›®å½•æƒé™è®¾ç½®æ­£ç¡®
- [x] æµ‹è¯•ç›®å½•å†™å…¥æƒé™

### **âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®æ£€æŸ¥**
- [x] è®¾ç½®`STORAGE_STRATEGY=local`
- [x] è®¾ç½®`USE_LOCAL_STORAGE=true`
- [x] è®¾ç½®`USE_CLOUD_STORAGE=false`
- [x] è®¾ç½®`LOCAL_STORAGE_MAX_SIZE=1073741824`ï¼ˆ1GBï¼‰
- [x] è®¾ç½®`LOCAL_STORAGE_MAX_FILE_SIZE=52428800`ï¼ˆ50MBï¼‰
- [x] è®¾ç½®`UPLOAD_MAX_FILES=10`
- [x] éªŒè¯ç¯å¢ƒå˜é‡è¯»å–æ­£å¸¸

### **ğŸ”§ åŸºç¡€åŠŸèƒ½æµ‹è¯•æ£€æŸ¥**
- [x] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶é…ç½®
- [x] æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯åŠŸèƒ½
- [x] æµ‹è¯•æ–‡ä»¶å¤§å°é™åˆ¶åŠŸèƒ½
- [x] æµ‹è¯•æ–‡ä»¶æ•°é‡é™åˆ¶åŠŸèƒ½
- [x] æµ‹è¯•æ–‡ä»¶å­˜å‚¨è·¯å¾„ç”Ÿæˆ
- [x] æµ‹è¯•ä¸´æ—¶æ–‡ä»¶æ¸…ç†åŠŸèƒ½

### **ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•**
- [x] æµ‹è¯•å°æ–‡ä»¶ï¼ˆ<1MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•ä¸­ç­‰æ–‡ä»¶ï¼ˆ1-10MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•æ‰¹é‡æ–‡ä»¶ä¸Šä¼ æ€§èƒ½
- [x] è®°å½•å„åœºæ™¯ä¸‹çš„å“åº”æ—¶é—´
- [x] éªŒè¯å†…å­˜ä½¿ç”¨æƒ…å†µ

### **ğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥**
- [x] éªŒè¯æ–‡ä»¶ç±»å‹ç™½åå•æœºåˆ¶
- [x] æµ‹è¯•æ¶æ„æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤
- [x] éªŒè¯æ–‡ä»¶è·¯å¾„å®‰å…¨ï¼ˆé˜²æ­¢ç›®å½•éå†ï¼‰
- [x] æµ‹è¯•æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦ç”Ÿæ•ˆ
- [x] éªŒè¯ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶

### **ğŸ“ æ—¥å¿—å’Œç›‘æ§æ£€æŸ¥**
- [x] éªŒè¯æ–‡ä»¶ä¸Šä¼ æ—¥å¿—è®°å½•
- [x] éªŒè¯é”™è¯¯æ—¥å¿—è®°å½•
- [x] æµ‹è¯•å­˜å‚¨ç©ºé—´ç›‘æ§
- [x] éªŒè¯æ€§èƒ½ç›‘æ§æ•°æ®
- [x] æµ‹è¯•å‘Šè­¦æœºåˆ¶ï¼ˆå¦‚éœ€è¦ï¼‰

### **ğŸ”„ å…¼å®¹æ€§æµ‹è¯•**
- [x] æµ‹è¯•ä¸åŒæ“ä½œç³»ç»Ÿå…¼å®¹æ€§
- [x] æµ‹è¯•ä¸åŒæµè§ˆå™¨å…¼å®¹æ€§
- [x] æµ‹è¯•ä¸åŒæ–‡ä»¶ç±»å‹å…¼å®¹æ€§
- [x] éªŒè¯ä¸­æ–‡æ–‡ä»¶åæ”¯æŒ
- [x] æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶åå¤„ç†

### **ğŸ“š æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥**
- [x] æ›´æ–°READMEæ–‡æ¡£
- [x] æ·»åŠ ç¯å¢ƒå˜é‡è¯´æ˜
- [x] æ·»åŠ APIä½¿ç”¨è¯´æ˜
- [x] æ·»åŠ æ•…éšœæ’é™¤æŒ‡å—
- [x] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§

### **ğŸš€ éƒ¨ç½²å‡†å¤‡æ£€æŸ¥**
- [x] éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®
- [x] æµ‹è¯•ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶æƒé™
- [x] éªŒè¯å­˜å‚¨ç©ºé—´å……è¶³
- [x] æµ‹è¯•æœåŠ¡é‡å¯ååŠŸèƒ½æ­£å¸¸
- [x] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

## ğŸ“Š **ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“ç»“æ„æ‰©å±•**
```

---

## ğŸ“Š **ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“ç»“æ„æ‰©å±•**

### **2.1 æ–°å¢æ•°æ®åº“è¡¨**

#### **é™„ä»¶è¡¨ (attachments)**
```sql
CREATE TABLE IF NOT EXISTS attachments (
  id TEXT PRIMARY KEY,                    -- å”¯ä¸€æ ‡è¯†ç¬¦
  session_id TEXT NOT NULL,              -- å…³è”ä¼šè¯ID
  message_id INTEGER NOT NULL,           -- å…³è”æ¶ˆæ¯ID
  filename TEXT NOT NULL,                -- å­˜å‚¨æ–‡ä»¶å
  original_name TEXT NOT NULL,           -- åŸå§‹æ–‡ä»¶å
  file_path TEXT NOT NULL,               -- æ–‡ä»¶å­˜å‚¨è·¯å¾„
  file_size INTEGER NOT NULL,            -- æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  mime_type TEXT NOT NULL,               -- MIMEç±»å‹
  file_type TEXT NOT NULL,               -- æ–‡ä»¶åˆ†ç±»ï¼ˆimage/document/audio/videoï¼‰
  width INTEGER,                         -- å›¾ç‰‡å®½åº¦ï¼ˆä»…å›¾ç‰‡ï¼‰
  height INTEGER,                        -- å›¾ç‰‡é«˜åº¦ï¼ˆä»…å›¾ç‰‡ï¼‰
  duration INTEGER,                      -- éŸ³é¢‘/è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
  thumbnail_path TEXT,                   -- ç¼©ç•¥å›¾è·¯å¾„
  metadata TEXT,                         -- é¢å¤–å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
);
```

#### **æ‰©å±•æ¶ˆæ¯è¡¨ (messages)**
```sql
-- ä¸ºç°æœ‰messagesè¡¨æ·»åŠ é™„ä»¶æ”¯æŒå­—æ®µ
ALTER TABLE messages ADD COLUMN has_attachments BOOLEAN DEFAULT FALSE;
ALTER TABLE messages ADD COLUMN attachment_ids TEXT; -- JSONæ•°ç»„å­˜å‚¨é™„ä»¶ID
ALTER TABLE messages ADD COLUMN multimodal_content BOOLEAN DEFAULT FALSE; -- æ˜¯å¦åŒ…å«å¤šæ¨¡æ€å†…å®¹
```

#### **æ–‡ä»¶å¤„ç†æ—¥å¿—è¡¨ (file_processing_logs)**
```sql
CREATE TABLE IF NOT EXISTS file_processing_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  attachment_id TEXT NOT NULL,
  process_type TEXT NOT NULL,            -- å¤„ç†ç±»å‹ï¼ˆupload/compress/convert/errorï¼‰
  status TEXT NOT NULL,                  -- å¤„ç†çŠ¶æ€ï¼ˆsuccess/failed/processingï¼‰
  error_message TEXT,                    -- é”™è¯¯ä¿¡æ¯
  processing_time INTEGER,               -- å¤„ç†è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (attachment_id) REFERENCES attachments(id) ON DELETE CASCADE
);
```

### **2.2 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_attachments_session_id ON attachments(session_id);
CREATE INDEX IF NOT EXISTS idx_attachments_message_id ON attachments(message_id);
CREATE INDEX IF NOT EXISTS idx_attachments_file_type ON attachments(file_type);
CREATE INDEX IF NOT EXISTS idx_attachments_created_at ON attachments(created_at);
CREATE INDEX IF NOT EXISTS idx_file_logs_attachment_id ON file_processing_logs(attachment_id);
CREATE INDEX IF NOT EXISTS idx_file_logs_status ON file_processing_logs(status);
```

---

## âš ï¸ **ç¬¬äºŒé˜¶æ®µé—ç•™é—®é¢˜ä¸æ”¹è¿›å»ºè®®**

### **1. æ•°æ®åº“å…¼å®¹æ€§é—®é¢˜**

#### **1.1 SQLiteç‰ˆæœ¬å…¼å®¹æ€§**
- **JSONå­—æ®µæ”¯æŒ**ï¼šattachment_idsä½¿ç”¨JSONæ•°ç»„ï¼Œéœ€è¦SQLite 3.38+ç‰ˆæœ¬
- **ALTER TABLEæ”¯æŒ**ï¼šmessagesè¡¨æ‰©å±•éœ€è¦ç¡®è®¤ç°æœ‰SQLiteç‰ˆæœ¬
- **å¤–é”®çº¦æŸ**ï¼šéœ€è¦ç¡®è®¤å¤–é”®çº¦æŸæ˜¯å¦å·²å¯ç”¨

#### **1.2 ç°æœ‰æ•°æ®å…¼å®¹æ€§**
- **æ•°æ®è¿ç§»ç­–ç•¥**ï¼šå¦‚ä½•å®‰å…¨åœ°ä¸ºç°æœ‰messagesè¡¨æ·»åŠ æ–°å­—æ®µ
- **é»˜è®¤å€¼å¤„ç†**ï¼šæ–°å­—æ®µçš„é»˜è®¤å€¼æ˜¯å¦ä¼šå½±å“ç°æœ‰æŸ¥è¯¢
- **æ€§èƒ½å½±å“**ï¼šALTER TABLEæ“ä½œå¯¹ç°æœ‰æ•°æ®çš„å½±å“

### **2. è¡¨ç»“æ„è®¾è®¡é—®é¢˜**

#### **2.1 å­—æ®µç±»å‹é€‰æ‹©**
- **TEXT vs VARCHAR**ï¼šidå­—æ®µä½¿ç”¨TEXTï¼Œæ˜¯å¦åº”è¯¥é™åˆ¶é•¿åº¦
- **JSON vs å…³ç³»è¡¨**ï¼šattachment_idsä½¿ç”¨JSONï¼Œæ˜¯å¦åº”è¯¥è®¾è®¡ä¸ºå…³ç³»è¡¨
- **æ—¶é—´å­—æ®µç²¾åº¦**ï¼šDATETIMEçš„ç²¾åº¦æ˜¯å¦è¶³å¤Ÿ

#### **2.2 ç´¢å¼•è®¾è®¡ä¼˜åŒ–**
- **å¤åˆç´¢å¼•è€ƒè™‘**ï¼šæ˜¯å¦éœ€è¦(session_id, created_at)çš„å¤åˆç´¢å¼•
- **éƒ¨åˆ†ç´¢å¼•**ï¼šæ˜¯å¦éœ€è¦å¯¹ç‰¹å®šçŠ¶æ€åˆ›å»ºéƒ¨åˆ†ç´¢å¼•
- **ç´¢å¼•ç»´æŠ¤æˆæœ¬**ï¼šç´¢å¼•å¯¹INSERT/UPDATEæ€§èƒ½çš„å½±å“

### **3. æ•°æ®ä¸€è‡´æ€§é—®é¢˜**

#### **3.1 å¤–é”®çº¦æŸ**
- **çº§è”åˆ é™¤ç­–ç•¥**ï¼šCASCADEåˆ é™¤æ˜¯å¦åˆé€‚ï¼Œæ˜¯å¦éœ€è¦RESTRICT
- **çº¦æŸæ£€æŸ¥**ï¼šæ˜¯å¦éœ€è¦æ·»åŠ CHECKçº¦æŸéªŒè¯æ•°æ®å®Œæ•´æ€§
- **äº‹åŠ¡å¤„ç†**ï¼šæ–‡ä»¶ä¸Šä¼ å’Œæ•°æ®åº“æ“ä½œçš„äº‹åŠ¡ä¸€è‡´æ€§

#### **3.2 æ•°æ®éªŒè¯**
- **æ–‡ä»¶å¤§å°éªŒè¯**ï¼šæ•°æ®åº“ä¸­çš„file_sizeæ˜¯å¦ä¸ç‰©ç†æ–‡ä»¶ä¸€è‡´
- **è·¯å¾„æœ‰æ•ˆæ€§**ï¼šfile_pathæ˜¯å¦å§‹ç»ˆæœ‰æ•ˆ
- **å…ƒæ•°æ®å®Œæ•´æ€§**ï¼šmetadata JSONå­—æ®µçš„æ ¼å¼éªŒè¯

### **4. æ€§èƒ½è€ƒè™‘**

#### **4.1 æŸ¥è¯¢æ€§èƒ½**
- **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼šå¤§é‡é™„ä»¶æ—¶çš„åˆ†é¡µæ€§èƒ½
- **èšåˆæŸ¥è¯¢**ï¼šæŒ‰ç±»å‹ã€å¤§å°ç­‰ç»´åº¦çš„ç»Ÿè®¡æŸ¥è¯¢
- **å…¨æ–‡æœç´¢**ï¼šæ˜¯å¦éœ€è¦å¯¹æ–‡ä»¶åå’Œå†…å®¹è¿›è¡Œå…¨æ–‡æœç´¢

#### **4.2 å­˜å‚¨ä¼˜åŒ–**
- **æ•°æ®å‹ç¼©**ï¼šå¤§æ–‡æœ¬å­—æ®µçš„å‹ç¼©ç­–ç•¥
- **åˆ†åŒºç­–ç•¥**ï¼šæ˜¯å¦æŒ‰æ—¶é—´æˆ–ç±»å‹è¿›è¡Œè¡¨åˆ†åŒº
- **å½’æ¡£ç­–ç•¥**ï¼šæ—§é™„ä»¶çš„å½’æ¡£å’Œæ¸…ç†ç­–ç•¥

### **5. æ‰©å±•æ€§è®¾è®¡**

#### **5.1 æœªæ¥åŠŸèƒ½é¢„ç•™**
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ–‡ä»¶ç‰ˆæœ¬ç®¡ç†
- **æƒé™æ§åˆ¶**ï¼šæ˜¯å¦éœ€è¦ç»†ç²’åº¦çš„æ–‡ä»¶è®¿é—®æƒé™
- **æ ‡ç­¾ç³»ç»Ÿ**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ–‡ä»¶æ ‡ç­¾å’Œåˆ†ç±»

#### **5.2 å¤šç§Ÿæˆ·æ”¯æŒ**
- **ç”¨æˆ·éš”ç¦»**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒå¤šç”¨æˆ·æ–‡ä»¶éš”ç¦»
- **ç©ºé—´é…é¢**ï¼šæ˜¯å¦éœ€è¦ç”¨æˆ·çº§åˆ«çš„å­˜å‚¨ç©ºé—´é™åˆ¶
- **å…±äº«æœºåˆ¶**ï¼šæ˜¯å¦éœ€è¦æ–‡ä»¶å…±äº«åŠŸèƒ½

---

## âœ… **ç¬¬äºŒé˜¶æ®µå®æ–½Checklist**

### **ğŸ—„ï¸ æ•°æ®åº“ç¯å¢ƒæ£€æŸ¥**
- [x] æ£€æŸ¥SQLiteç‰ˆæœ¬ï¼ˆå»ºè®®3.38+ï¼‰
- [x] ç¡®è®¤å¤–é”®çº¦æŸå·²å¯ç”¨
- [ ] éªŒè¯æ•°æ®åº“æ–‡ä»¶æƒé™
- [x] æ£€æŸ¥ç°æœ‰è¡¨ç»“æ„
- [ ] å¤‡ä»½ç°æœ‰æ•°æ®

### **ğŸ“‹ è¡¨ç»“æ„åˆ›å»ºæ£€æŸ¥**
- [x] åˆ›å»ºattachmentsè¡¨
- [x] æ‰©å±•messagesè¡¨ï¼ˆæ·»åŠ æ–°å­—æ®µï¼‰
- [x] åˆ›å»ºfile_processing_logsè¡¨
- [x] éªŒè¯è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
- [x] æ£€æŸ¥å­—æ®µç±»å‹å’Œçº¦æŸ

### **ğŸ”— å¤–é”®å…³ç³»æ£€æŸ¥**
- [x] éªŒè¯session_idå¤–é”®çº¦æŸ
- [x] éªŒè¯message_idå¤–é”®çº¦æŸ
- [x] æµ‹è¯•çº§è”åˆ é™¤åŠŸèƒ½
- [x] éªŒè¯æ•°æ®å®Œæ•´æ€§
- [x] æ£€æŸ¥çº¦æŸåç§°å†²çª

### **ğŸ“Š ç´¢å¼•åˆ›å»ºæ£€æŸ¥**
- [x] åˆ›å»ºsession_idç´¢å¼•
- [x] åˆ›å»ºmessage_idç´¢å¼•
- [x] åˆ›å»ºfile_typeç´¢å¼•
- [x] åˆ›å»ºcreated_atç´¢å¼•
- [x] åˆ›å»ºæ—¥å¿—è¡¨ç›¸å…³ç´¢å¼•
- [x] éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ

### **ğŸ§ª æ•°æ®æ“ä½œæµ‹è¯•**
- [x] æµ‹è¯•INSERTæ“ä½œï¼ˆå„ç§æ–‡ä»¶ç±»å‹ï¼‰
- [x] æµ‹è¯•SELECTæŸ¥è¯¢ï¼ˆå•æ¡ã€æ‰¹é‡ã€æ¡ä»¶æŸ¥è¯¢ï¼‰
- [x] æµ‹è¯•UPDATEæ“ä½œï¼ˆæ–‡ä»¶ä¿¡æ¯æ›´æ–°ï¼‰
- [x] æµ‹è¯•DELETEæ“ä½œï¼ˆçº§è”åˆ é™¤ï¼‰
- [x] æµ‹è¯•äº‹åŠ¡å›æ»š

### **ğŸ“ˆ æ€§èƒ½æµ‹è¯•æ£€æŸ¥**
- [x] æµ‹è¯•å°æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½
- [x] æµ‹è¯•å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½
- [x] æµ‹è¯•ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- [â­ï¸] æµ‹è¯•å¹¶å‘è®¿é—®æ€§èƒ½ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] è®°å½•æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*

### **ğŸ”„ æ•°æ®è¿ç§»æµ‹è¯•**
- [â­ï¸] æµ‹è¯•ç°æœ‰æ•°æ®å…¼å®¹æ€§ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯æ–°å­—æ®µé»˜è®¤å€¼ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æµ‹è¯•æ•°æ®å®Œæ•´æ€§ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯æŸ¥è¯¢ç»“æœä¸€è‡´æ€§ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] å‡†å¤‡å›æ»šæ–¹æ¡ˆ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*

### **ğŸ“ æ—¥å¿—å’Œç›‘æ§æ£€æŸ¥**
- [â­ï¸] éªŒè¯æ•°æ®åº“æ“ä½œæ—¥å¿— *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯æ€§èƒ½ç›‘æ§æ•°æ® *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç† *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*

### **ğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥**
- [â­ï¸] éªŒè¯SQLæ³¨å…¥é˜²æŠ¤ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æµ‹è¯•æƒé™æ§åˆ¶æœºåˆ¶ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯æ•°æ®è®¿é—®æ§åˆ¶ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æµ‹è¯•æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯å®¡è®¡æ—¥å¿—è®°å½• *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*

### **ğŸ“š æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥**
- [â­ï¸] æ›´æ–°æ•°æ®åº“è®¾è®¡æ–‡æ¡£ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æ·»åŠ è¡¨ç»“æ„è¯´æ˜ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æ·»åŠ ç´¢å¼•ä½¿ç”¨æŒ‡å— *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] æ·»åŠ æ€§èƒ½ä¼˜åŒ–å»ºè®® *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*
- [â­ï¸] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§ *(æš‚ç¼“ - æœ¬åœ°æ•°æ®åº“)*

> **ğŸ“ è¯´æ˜**: ä»¥ä¸Šæ ‡è®°ä¸º `[â­ï¸]` çš„é¡¹ç›®å·²æš‚ç¼“ï¼ŒåŸå› æ˜¯å½“å‰æ•°æ®åº“å‡åœ¨æœ¬åœ°ç¯å¢ƒï¼Œè¿™äº›æµ‹è¯•é¡¹ç›®ä¸»è¦é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒæˆ–åˆ†å¸ƒå¼æ•°æ®åº“åœºæ™¯ã€‚åœ¨æœ¬åœ°å¼€å‘é˜¶æ®µï¼Œæ ¸å¿ƒåŠŸèƒ½éªŒè¯å·²å®Œæˆï¼Œåç»­éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶å†æ‰§è¡Œè¿™äº›æµ‹è¯•ã€‚

### **ğŸ¯ ç¬¬äºŒé˜¶æ®µæ€»ç»“**

**âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… æ•°æ®åº“è¡¨ç»“æ„åˆ›å»ºï¼ˆattachmentsã€file_processing_logsã€messagesæ‰©å±•ï¼‰
- âœ… å¤–é”®çº¦æŸå’Œç´¢å¼•åˆ›å»º
- âœ… æ•°æ®è®¿é—®å±‚å®ç°ï¼ˆRepositoryæ¨¡å¼ï¼‰
- âœ… åŸºç¡€CRUDæ“ä½œæµ‹è¯•
- âœ… çº§è”åˆ é™¤åŠŸèƒ½éªŒè¯
- âœ… äº‹åŠ¡å›æ»šæœºåˆ¶éªŒè¯
- âœ… å°æ•°æ®é‡å’Œå¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

**â­ï¸ æš‚ç¼“çš„æµ‹è¯•é¡¹ç›®ï¼š**
- å¹¶å‘è®¿é—®æ€§èƒ½æµ‹è¯•
- æ•°æ®è¿ç§»æµ‹è¯•
- é«˜çº§æ—¥å¿—å’Œç›‘æ§æ£€æŸ¥
- ç”Ÿäº§çº§å®‰å…¨æ€§æ£€æŸ¥
- å®Œæ•´æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥

**ğŸ“‹ æš‚ç¼“åŸå› ï¼š**
å½“å‰æ•°æ®åº“å‡åœ¨æœ¬åœ°ç¯å¢ƒï¼Œæš‚ç¼“çš„æµ‹è¯•é¡¹ç›®ä¸»è¦é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒæˆ–åˆ†å¸ƒå¼æ•°æ®åº“åœºæ™¯ã€‚æ ¸å¿ƒåŠŸèƒ½éªŒè¯å·²å®Œæˆï¼Œä¸ºåç»­å¼€å‘æä¾›äº†åšå®çš„åŸºç¡€ã€‚

---

## ğŸ”§ **ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯APIå¼€å‘**

### **3.1 æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶é…ç½®**

#### **Multeré…ç½®**
```javascript
// æ ¸å¿ƒä¾èµ–ï¼ˆéœ€è¦åœ¨ç¬¬ä¸€é˜¶æ®µå®‰è£…ï¼‰
const multer = require('multer');           // v1.4.5-lts.1
const path = require('path');               // Node.jså†…ç½®
const fs = require('fs');                   // Node.jså†…ç½®
const { v4: uuidv4 } = require('uuid');     // v9.0.1

// æ–‡ä»¶å­˜å‚¨é…ç½®
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = process.env.UPLOAD_TEMP_DIR || 'uploads/temp';
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼šæ—¶é—´æˆ³-UUID-åŸå§‹æ‰©å±•å
    const timestamp = Date.now();
    const uuid = uuidv4();
    const ext = path.extname(file.originalname);
    const uniqueName = `${timestamp}-${uuid}${ext}`;
    cb(null, uniqueName);
  }
});

// æ–‡ä»¶è¿‡æ»¤å™¨
const fileFilter = (req, file, cb) => {
  // å…è®¸çš„æ–‡ä»¶ç±»å‹é…ç½®
  const allowedMimeTypes = {
    // å›¾ç‰‡ç±»å‹
    'image/jpeg': 'image',
    'image/png': 'image',
    'image/gif': 'image',
    'image/webp': 'image',
    'image/svg+xml': 'image',
    
    // æ–‡æ¡£ç±»å‹
    'application/pdf': 'document',
    'text/plain': 'document',
    'text/markdown': 'document',
    'application/msword': 'document',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'document',
    'application/vnd.ms-excel': 'document',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'document',
    
    // éŸ³é¢‘ç±»å‹
    'audio/mpeg': 'audio',
    'audio/wav': 'audio',
    'audio/ogg': 'audio',
    'audio/m4a': 'audio',
    
    // è§†é¢‘ç±»å‹
    'video/mp4': 'video',
    'video/avi': 'video',
    'video/mov': 'video',
    'video/webm': 'video'
  };
  
  if (allowedMimeTypes[file.mimetype]) {
    // æ·»åŠ æ–‡ä»¶ç±»å‹ä¿¡æ¯åˆ°reqå¯¹è±¡
    if (!req.fileTypes) req.fileTypes = [];
    req.fileTypes.push({
      originalName: file.originalname,
      mimeType: file.mimetype,
      fileType: allowedMimeTypes[file.mimetype]
    });
    cb(null, true);
  } else {
    cb(new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.mimetype}`), false);
  }
};

// åˆ›å»ºmulterå®ä¾‹
const upload = multer({
  storage,
  limits: {
    fileSize: parseInt(process.env.UPLOAD_MAX_SIZE) || 50 * 1024 * 1024, // 50MB
    files: parseInt(process.env.UPLOAD_MAX_FILES) || 10, // æœ€å¤š10ä¸ªæ–‡ä»¶
    fieldSize: 1024 * 1024 // 1MBå­—æ®µå¤§å°é™åˆ¶
  },
  fileFilter
});

module.exports = { upload, fileFilter };
```

### **3.2 æ–‡ä»¶å¤„ç†å·¥å…·å‡½æ•°**

#### **æ–‡ä»¶ç±»å‹æ£€æµ‹å’Œå¤„ç†**
```javascript
// å›¾ç‰‡å¤„ç†ä¾èµ–ï¼ˆéœ€è¦åœ¨ç¬¬ä¸€é˜¶æ®µå®‰è£…ï¼‰
const sharp = require('sharp');                    // v0.32.6
const fs = require('fs').promises;                 // Node.jså†…ç½®
const path = require('path');                      // Node.jså†…ç½®
const { fileTypeFromFile } = require('file-type'); // v18.7.0ï¼ˆå¯é€‰ä¾èµ–ï¼‰

/**
 * æ–‡ä»¶å¤„ç†å·¥å…·ç±»
 */
class FileProcessor {
  /**
   * å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
   */
  static async processFile(filePath, originalName, mimeType, fileType) {
    try {
      const stats = await fs.stat(filePath);
      const fileSize = stats.size;
      
      let processedData = {
        width: null,
        height: null,
        duration: null,
        thumbnailPath: null,
        metadata: {}
      };
      
      // æ ¹æ®æ–‡ä»¶ç±»å‹è¿›è¡Œç‰¹å®šå¤„ç†
      switch (fileType) {
        case 'image':
          processedData = await this.processImage(filePath, mimeType);
          break;
        case 'document':
          processedData = await this.processDocument(filePath, mimeType);
          break;
        case 'audio':
          processedData = await this.processAudio(filePath, mimeType);
          break;
        case 'video':
          processedData = await this.processVideo(filePath, mimeType);
          break;
      }
      
      return {
        fileSize,
        ...processedData
      };
      
    } catch (error) {
      console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
      throw new Error(`æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * å¤„ç†å›¾ç‰‡æ–‡ä»¶
   */
  static async processImage(filePath, mimeType) {
    try {
      const image = sharp(filePath);
      const metadata = await image.metadata();
      
      // ç”Ÿæˆç¼©ç•¥å›¾
      const thumbnailPath = await this.generateThumbnail(filePath, metadata);
      
      return {
        width: metadata.width,
        height: metadata.height,
        thumbnailPath,
        metadata: {
          format: metadata.format,
          space: metadata.space,
          channels: metadata.channels,
          depth: metadata.depth
        }
      };
    } catch (error) {
      console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * ç”Ÿæˆç¼©ç•¥å›¾
   */
  static async generateThumbnail(filePath, metadata) {
    try {
      const thumbnailDir = process.env.UPLOAD_THUMBNAILS_DIR || 'uploads/thumbnails';
      if (!fs.existsSync(thumbnailDir)) {
        await fs.mkdir(path.dirname(thumbnailDir), { recursive: true });
      }
      
      const thumbnailName = `thumb_${path.basename(filePath, path.extname(filePath))}.webp`;
      const thumbnailPath = path.join(thumbnailDir, thumbnailName);
      
      await sharp(filePath)
        .resize(200, 200, { fit: 'inside', withoutEnlargement: true })
        .webp({ quality: 80 })
        .toFile(thumbnailPath);
      
      return thumbnailPath;
    } catch (error) {
      console.error('ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥:', error);
      return null;
    }
  }
  
  /**
   * å¤„ç†æ–‡æ¡£æ–‡ä»¶
   */
  static async processDocument(filePath, mimeType) {
    // æ–‡æ¡£æ–‡ä»¶é€šå¸¸ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
    return {
      metadata: {
        mimeType,
        extension: path.extname(filePath)
      }
    };
  }
  
  /**
   * å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼ˆé¢„ç•™ï¼‰
   */
  static async processAudio(filePath, mimeType) {
    // éŸ³é¢‘å¤„ç†åŠŸèƒ½é¢„ç•™
    return {
      metadata: {
        mimeType,
        extension: path.extname(filePath)
      }
    };
  }
  
  /**
   * å¤„ç†è§†é¢‘æ–‡ä»¶ï¼ˆé¢„ç•™ï¼‰
   */
  static async processVideo(filePath, mimeType) {
    // è§†é¢‘å¤„ç†åŠŸèƒ½é¢„ç•™
    return {
      metadata: {
        mimeType,
        extension: path.extname(filePath)
      }
    };
  }
}

module.exports = FileProcessor;
```

---

## ğŸš€ **ä¸‹ä¸€æ­¥ï¼šåç«¯APIå¼€å‘**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘åç«¯APIç›¸å…³åŠŸèƒ½ã€‚

---

## ğŸ“‹ **å·²å®Œæˆæ¨¡å—è¯¦ç»†Checklist**

### **âœ… æ¨¡å—1ï¼šé¡¹ç›®æ¦‚è¿°å’Œéœ€æ±‚åˆ†æ**

#### **1.1 é¡¹ç›®æ¦‚è¿°**
- [x] æ˜ç¡®é¡¹ç›®ç›®æ ‡ï¼šä¸ºå¤šæ¨¡å‹AIèŠå¤©ç³»ç»Ÿé›†æˆé™„ä»¶ä¸Šä¼ åŠŸèƒ½
- [x] ç¡®å®šæ”¯æŒæ¨¡å‹ï¼šGeminiã€GPTã€Claude
- [x] å®šä¹‰æ ¸å¿ƒä»·å€¼ï¼šæ”¯æŒå¤šæ¨¡æ€è¾“å…¥ï¼Œå……åˆ†åˆ©ç”¨æ¨¡å‹å®˜æ–¹èƒ½åŠ›

#### **1.2 åŠŸèƒ½éœ€æ±‚åˆ†æ**
- [x] æ–‡ä»¶ä¸Šä¼ æ”¯æŒï¼ˆå¤šç§æ–‡ä»¶ç±»å‹ã€å¤§å°é™åˆ¶ã€æ‰¹é‡ä¸Šä¼ ï¼‰
- [x] å¤šæ¨¡æ€AIäº¤äº’ï¼ˆVision APIã€å¤šæ¨¡æ€æ”¯æŒï¼‰
- [x] æ–‡ä»¶ç®¡ç†ï¼ˆå­˜å‚¨ã€æ£€ç´¢ã€ä¼šè¯å…³è”ã€ç”Ÿå‘½å‘¨æœŸï¼‰

#### **1.3 æŠ€æœ¯ç›®æ ‡è®¾å®š**
- [x] æ–‡ä»¶å¤§å°é™åˆ¶ï¼š50MB
- [x] æ–‡ä»¶æ•°é‡é™åˆ¶ï¼šæœ€å¤š10ä¸ª
- [x] å®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- [x] æ™ºèƒ½æ–‡ä»¶ç±»å‹è¯†åˆ«
- [x] å®‰å…¨çš„æ–‡ä»¶å¤„ç†æµç¨‹

### **âœ… æ¨¡å—2ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡**

#### **2.1 ç³»ç»Ÿæ¶æ„è®¾è®¡**
- [x] ç»˜åˆ¶ç³»ç»Ÿæ¶æ„å›¾
- [x] å®šä¹‰æ•°æ®æµå‘ï¼šå‰ç«¯â†’åç«¯â†’æ–‡ä»¶å¤„ç†â†’AIæ¨¡å‹API
- [x] ç¡®å®šå„ç»„ä»¶èŒè´£åˆ†å·¥

#### **2.2 æŠ€æœ¯æ ˆé€‰æ‹©**
- [x] æ–‡ä»¶ä¸Šä¼ ï¼šMulterï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
- [x] æ–‡ä»¶å­˜å‚¨ï¼šæœ¬åœ°å­˜å‚¨ï¼ˆå½“å‰å®ç°ï¼‰ + AWS S3ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- [x] å›¾ç‰‡å¤„ç†ï¼šSharp
- [x] æ–‡ä»¶æ ¼å¼ï¼šJPEGã€PNGã€GIFã€WebPã€PDFã€TXTã€DOCã€DOCX
- [x] æ•°æ®åº“ï¼šSQLiteï¼ˆæ‰©å±•è¡¨ç»“æ„ï¼‰

### **âœ… æ¨¡å—3ï¼šåŸºç¡€è®¾æ–½æ­å»º**

#### **3.1 ä¾èµ–åŒ…å®‰è£…**
- [x] æ ¸å¿ƒä¾èµ–ï¼šmulterã€sharpã€uuidï¼ˆå½“å‰å®ç°ï¼‰
- [x] å¯é€‰ä¾èµ–ï¼šfile-typeã€mime-typesã€image-size
- [x] ä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§ç¡®è®¤

#### **3.2 ç›®å½•ç»“æ„åˆ›å»º**
- [x] uploads/tempï¼ˆä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼‰
- [x] uploads/processedï¼ˆå¤„ç†åçš„æ–‡ä»¶ï¼‰
- [x] uploads/attachmentsï¼ˆæœ€ç»ˆé™„ä»¶å­˜å‚¨ï¼‰
- [x] uploads/thumbnailsï¼ˆç¼©ç•¥å›¾å­˜å‚¨ï¼‰
- [x] uploads/logsï¼ˆä¸Šä¼ æ—¥å¿—ï¼‰

#### **3.3 ç¯å¢ƒå˜é‡é…ç½®**
- [x] UPLOAD_MAX_SIZEï¼ˆ50MBï¼‰
- [x] UPLOAD_MAX_FILESï¼ˆ10ä¸ªï¼‰
- [x] UPLOAD_ALLOWED_TYPESï¼ˆimage,document,audio,videoï¼‰
- [x] ç›®å½•è·¯å¾„é…ç½®
- [x] AWS S3é…ç½®ï¼ˆå¯é€‰ï¼‰

### **âœ… æ¨¡å—4ï¼šæ•°æ®åº“ç»“æ„æ‰©å±•**

#### **4.1 æ–°å¢æ•°æ®åº“è¡¨**
- [x] é™„ä»¶è¡¨ï¼ˆattachmentsï¼‰- å®Œæ•´å­—æ®µè®¾è®¡
- [x] æ‰©å±•æ¶ˆæ¯è¡¨ï¼ˆmessagesï¼‰- æ·»åŠ é™„ä»¶æ”¯æŒå­—æ®µ
- [x] æ–‡ä»¶å¤„ç†æ—¥å¿—è¡¨ï¼ˆfile_processing_logsï¼‰- å¤„ç†çŠ¶æ€è·Ÿè¸ª

#### **4.2 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
- [x] ä¼šè¯IDç´¢å¼•ï¼ˆidx_attachments_session_idï¼‰
- [x] æ¶ˆæ¯IDç´¢å¼•ï¼ˆidx_attachments_message_idï¼‰
- [x] æ–‡ä»¶ç±»å‹ç´¢å¼•ï¼ˆidx_attachments_file_typeï¼‰
- [x] åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼ˆidx_attachments_created_atï¼‰
- [x] æ—¥å¿—è¡¨ç´¢å¼•ä¼˜åŒ–

#### **4.3 å¤–é”®çº¦æŸè®¾è®¡**
- [x] é™„ä»¶è¡¨ä¸ä¼šè¯è¡¨å…³è”
- [x] é™„ä»¶è¡¨ä¸æ¶ˆæ¯è¡¨å…³è”
- [x] çº§è”åˆ é™¤è®¾ç½®

### **âœ… æ¨¡å—5ï¼šåç«¯APIå¼€å‘ï¼ˆ50%å®Œæˆï¼‰**

#### **5.1 æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶é…ç½®**
- [x] Multerå­˜å‚¨é…ç½®ï¼ˆç£ç›˜å­˜å‚¨ï¼‰
- [x] æ–‡ä»¶è¿‡æ»¤å™¨ï¼ˆMIMEç±»å‹éªŒè¯ï¼‰
- [x] æ–‡ä»¶å¤§å°å’Œæ•°é‡é™åˆ¶
- [x] å”¯ä¸€æ–‡ä»¶åç”Ÿæˆç­–ç•¥

#### **5.2 æ–‡ä»¶å¤„ç†å·¥å…·å‡½æ•°**
- [x] FileProcessorç±»è®¾è®¡
- [x] å›¾ç‰‡å¤„ç†ï¼ˆå°ºå¯¸è·å–ã€ç¼©ç•¥å›¾ç”Ÿæˆï¼‰
- [x] æ–‡æ¡£å¤„ç†ï¼ˆå…ƒæ•°æ®æå–ï¼‰
- [x] éŸ³é¢‘/è§†é¢‘å¤„ç†ï¼ˆé¢„ç•™ï¼‰
- [x] é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

#### **5.3 å¾…å®Œæˆéƒ¨åˆ†**
- [ ] é™„ä»¶ä¸Šä¼ APIç«¯ç‚¹
- [ ] æ–‡ä»¶å­˜å‚¨ç®¡ç†
- [ ] å¤šæ¨¡æ€AIé›†æˆ
- [ ] å‰ç«¯ç»„ä»¶å¼€å‘
- [ ] æµ‹è¯•å’Œä¼˜åŒ–

---

## ğŸš€ **ä¸‹ä¸€æ­¥ï¼šç»§ç»­å¼€å‘å‰©ä½™æ¨¡å—**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘é™„ä»¶ä¸Šä¼ APIç«¯ç‚¹ã€‚

---

## ğŸ”§ **ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯APIå¼€å‘ï¼ˆç»­ï¼‰**

### **3.3 é™„ä»¶ä¸Šä¼ APIç«¯ç‚¹**

#### **3.3.1 æ–‡ä»¶ä¸Šä¼ ä¸»ç«¯ç‚¹**
```javascript
// é™„ä»¶ä¸Šä¼ ä¸»ç«¯ç‚¹
app.post('/api/attachments/upload', upload.array('files', 10), async (req, res) => {
  try {
    const { sessionId, messageId } = req.body;
    const files = req.files;
    
    if (!files || files.length === 0) {
      return res.status(400).json({ 
        error: 'æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ',
        code: 'NO_FILES_UPLOADED'
      });
    }
    
    if (!sessionId) {
      return res.status(400).json({ 
        error: 'ä¼šè¯IDä¸èƒ½ä¸ºç©º',
        code: 'MISSING_SESSION_ID'
      });
    }
    
    console.log(`ğŸ“¤ å¼€å§‹å¤„ç†æ–‡ä»¶ä¸Šä¼ : ${files.length} ä¸ªæ–‡ä»¶, ä¼šè¯: ${sessionId}`);
    
    const uploadResults = [];
    const errors = [];
    
    // å¹¶è¡Œå¤„ç†æ‰€æœ‰æ–‡ä»¶
    const processPromises = files.map(async (file, index) => {
      try {
        console.log(`ğŸ”„ å¤„ç†æ–‡ä»¶ ${index + 1}/${files.length}: ${file.originalname}`);
        
        // è·å–æ–‡ä»¶ç±»å‹ä¿¡æ¯
        const fileTypeInfo = req.fileTypes[index];
        if (!fileTypeInfo) {
          throw new Error('æ–‡ä»¶ç±»å‹ä¿¡æ¯ç¼ºå¤±');
        }
        
        // å¤„ç†æ–‡ä»¶
        const processedData = await FileProcessor.processFile(
          file.path,
          file.originalname,
          fileTypeInfo.mimeType,
          fileTypeInfo.fileType
        );
        
        // ç”Ÿæˆå”¯ä¸€é™„ä»¶ID
        const attachmentId = `att_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // ç§»åŠ¨æ–‡ä»¶åˆ°æœ€ç»ˆå­˜å‚¨ä½ç½®
        const finalPath = await moveFileToStorage(file.path, attachmentId, fileTypeInfo.fileType);
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        const attachment = await saveAttachmentToDatabase({
          id: attachmentId,
          sessionId,
          messageId: messageId || null,
          filename: path.basename(finalPath),
          originalName: file.originalname,
          filePath: finalPath,
          fileSize: processedData.fileSize,
          mimeType: fileTypeInfo.mimeType,
          fileType: fileTypeInfo.fileType,
          width: processedData.width,
          height: processedData.height,
          duration: processedData.duration,
          thumbnailPath: processedData.thumbnailPath,
          metadata: JSON.stringify(processedData.metadata)
        });
        
        // è®°å½•å¤„ç†æ—¥å¿—
        await logFileProcessing(attachmentId, 'upload', 'success', null, Date.now());
        
        uploadResults.push({
          id: attachmentId,
          originalName: file.originalname,
          fileType: fileTypeInfo.fileType,
          fileSize: processedData.fileSize,
          thumbnailUrl: processedData.thumbnailPath ? `/api/attachments/thumbnail/${attachmentId}` : null,
          downloadUrl: `/api/attachments/download/${attachmentId}`,
          status: 'success'
        });
        
        console.log(`âœ… æ–‡ä»¶å¤„ç†æˆåŠŸ: ${file.originalname} -> ${attachmentId}`);
        
      } catch (error) {
        console.error(`âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${file.originalname}`, error);
        
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        try {
          await fs.unlink(file.path);
        } catch (cleanupError) {
          console.warn('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', cleanupError);
        }
        
        errors.push({
          originalName: file.originalname,
          error: error.message,
          status: 'failed'
        });
        
        // è®°å½•é”™è¯¯æ—¥å¿—
        if (req.fileTypes[index]) {
          const tempAttachmentId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          await logFileProcessing(tempAttachmentId, 'upload', 'failed', error.message, Date.now());
        }
      }
    });
    
    // ç­‰å¾…æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
    await Promise.all(processPromises);
    
    // è¿”å›ç»“æœ
    res.json({
      success: true,
      message: `æ–‡ä»¶ä¸Šä¼ å®Œæˆ: ${uploadResults.length} æˆåŠŸ, ${errors.length} å¤±è´¥`,
      results: {
        successful: uploadResults,
        failed: errors
      },
      summary: {
        totalFiles: files.length,
        successfulUploads: uploadResults.length,
        failedUploads: errors.length,
        sessionId,
        messageId
      }
    });
    
  } catch (error) {
    console.error('æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'æ–‡ä»¶ä¸Šä¼ å¤„ç†å¤±è´¥',
      details: error.message,
      code: 'UPLOAD_PROCESSING_ERROR'
    });
  }
});
```

#### **3.3.2 æ–‡ä»¶ä¸‹è½½ç«¯ç‚¹**
```javascript
// æ–‡ä»¶ä¸‹è½½ç«¯ç‚¹
app.get('/api/attachments/download/:attachmentId', async (req, res) => {
  try {
    const { attachmentId } = req.params;
    
    // ä»æ•°æ®åº“è·å–é™„ä»¶ä¿¡æ¯
    const attachment = await getAttachmentById(attachmentId);
    if (!attachment) {
      return res.status(404).json({ 
        error: 'é™„ä»¶ä¸å­˜åœ¨',
        code: 'ATTACHMENT_NOT_FOUND'
      });
    }
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(attachment.file_path)) {
      console.error(`æ–‡ä»¶ä¸å­˜åœ¨: ${attachment.file_path}`);
      return res.status(404).json({ 
        error: 'æ–‡ä»¶ä¸å­˜åœ¨',
        code: 'FILE_NOT_FOUND'
      });
    }
    
    // è®¾ç½®å“åº”å¤´
    res.setHeader('Content-Type', attachment.mime_type);
    res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(attachment.original_name)}"`);
    res.setHeader('Content-Length', attachment.file_size);
    res.setHeader('Cache-Control', 'public, max-age=3600'); // 1å°æ—¶ç¼“å­˜
    
    // æµå¼å‘é€æ–‡ä»¶
    const fileStream = fs.createReadStream(attachment.file_path);
    fileStream.pipe(res);
    
    // è®°å½•ä¸‹è½½æ—¥å¿—
    await logFileProcessing(attachmentId, 'download', 'success', null, Date.now());
    
  } catch (error) {
    console.error('æ–‡ä»¶ä¸‹è½½é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'æ–‡ä»¶ä¸‹è½½å¤±è´¥',
      details: error.message,
      code: 'DOWNLOAD_ERROR'
    });
  }
});
```

#### **3.3.3 ç¼©ç•¥å›¾ç«¯ç‚¹**
```javascript
// ç¼©ç•¥å›¾ç«¯ç‚¹
app.get('/api/attachments/thumbnail/:attachmentId', async (req, res) => {
  try {
    const { attachmentId } = req.params;
    
    // ä»æ•°æ®åº“è·å–é™„ä»¶ä¿¡æ¯
    const attachment = await getAttachmentById(attachmentId);
    if (!attachment) {
      return res.status(404).json({ 
        error: 'é™„ä»¶ä¸å­˜åœ¨',
        code: 'ATTACHMENT_NOT_FOUND'
      });
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼©ç•¥å›¾
    if (!attachment.thumbnail_path || !fs.existsSync(attachment.thumbnail_path)) {
      // å¦‚æœæ²¡æœ‰ç¼©ç•¥å›¾ï¼Œå°è¯•ç”Ÿæˆä¸€ä¸ª
      if (attachment.file_type === 'image') {
        try {
          const thumbnailPath = await FileProcessor.generateThumbnail(
            attachment.file_path,
            { width: attachment.width, height: attachment.height }
          );
          
          if (thumbnailPath) {
            // æ›´æ–°æ•°æ®åº“ä¸­çš„ç¼©ç•¥å›¾è·¯å¾„
            await updateAttachmentThumbnail(attachmentId, thumbnailPath);
            attachment.thumbnail_path = thumbnailPath;
          }
        } catch (thumbnailError) {
          console.warn('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', thumbnailError);
        }
      }
      
      // å¦‚æœä»ç„¶æ²¡æœ‰ç¼©ç•¥å›¾ï¼Œè¿”å›åŸå›¾
      if (!attachment.thumbnail_path || !fs.existsSync(attachment.thumbnail_path)) {
        return res.redirect(`/api/attachments/download/${attachmentId}`);
      }
    }
    
    // è®¾ç½®å“åº”å¤´
    res.setHeader('Content-Type', 'image/webp');
    res.setHeader('Cache-Control', 'public, max-age=86400'); // 24å°æ—¶ç¼“å­˜
    
    // å‘é€ç¼©ç•¥å›¾
    const thumbnailStream = fs.createReadStream(attachment.thumbnail_path);
    thumbnailStream.pipe(res);
    
  } catch (error) {
    console.error('ç¼©ç•¥å›¾è·å–é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'ç¼©ç•¥å›¾è·å–å¤±è´¥',
      details: error.message,
      code: 'THUMBNAIL_ERROR'
    });
  }
});
```

#### **3.3.4 é™„ä»¶ä¿¡æ¯æŸ¥è¯¢ç«¯ç‚¹**
```javascript
// è·å–é™„ä»¶ä¿¡æ¯ç«¯ç‚¹
app.get('/api/attachments/:attachmentId', async (req, res) => {
  try {
    const { attachmentId } = req.params;
    
    const attachment = await getAttachmentById(attachmentId);
    if (!attachment) {
      return res.status(404).json({ 
        error: 'é™„ä»¶ä¸å­˜åœ¨',
        code: 'ATTACHMENT_NOT_FOUND'
      });
    }
    
    // è¿”å›é™„ä»¶ä¿¡æ¯ï¼ˆä¸åŒ…å«æ•æ„Ÿè·¯å¾„ä¿¡æ¯ï¼‰
    res.json({
      id: attachment.id,
      originalName: attachment.original_name,
      fileType: attachment.file_type,
      fileSize: attachment.file_size,
      mimeType: attachment.mime_type,
      width: attachment.width,
      height: attachment.height,
      duration: attachment.duration,
      hasThumbnail: !!attachment.thumbnail_path,
      createdAt: attachment.created_at,
      updatedAt: attachment.updated_at,
      urls: {
        download: `/api/attachments/download/${attachmentId}`,
        thumbnail: attachment.thumbnail_path ? `/api/attachments/thumbnail/${attachmentId}` : null
      }
    });
    
  } catch (error) {
    console.error('è·å–é™„ä»¶ä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'è·å–é™„ä»¶ä¿¡æ¯å¤±è´¥',
      details: error.message,
      code: 'GET_ATTACHMENT_ERROR'
    });
  }
});

// è·å–ä¼šè¯çš„æ‰€æœ‰é™„ä»¶
app.get('/api/sessions/:sessionId/attachments', async (req, res) => {
  try {
    const { sessionId } = req.params;
    const { page = 1, limit = 20, fileType } = req.query;
    
    // éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
    const session = await getSession(sessionId);
    if (!session) {
      return res.status(404).json({ 
        error: 'ä¼šè¯ä¸å­˜åœ¨',
        code: 'SESSION_NOT_FOUND'
      });
    }
    
    // è·å–é™„ä»¶åˆ—è¡¨
    const attachments = await getSessionAttachments(sessionId, {
      page: parseInt(page),
      limit: parseInt(limit),
      fileType
    });
    
    res.json({
      sessionId,
      attachments: attachments.data,
      pagination: {
        currentPage: parseInt(page),
        totalPages: Math.ceil(attachments.total / parseInt(limit)),
        totalAttachments: attachments.total,
        hasNext: parseInt(page) < Math.ceil(attachments.total / parseInt(limit)),
        hasPrev: parseInt(page) > 1
      }
    });
    
  } catch (error) {
    console.error('è·å–ä¼šè¯é™„ä»¶é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'è·å–ä¼šè¯é™„ä»¶å¤±è´¥',
      details: error.message,
      code: 'GET_SESSION_ATTACHMENTS_ERROR'
    });
  }
});
```

#### **3.3.5 é™„ä»¶åˆ é™¤ç«¯ç‚¹**
```javascript
// åˆ é™¤é™„ä»¶ç«¯ç‚¹
app.delete('/api/attachments/:attachmentId', async (req, res) => {
  try {
    const { attachmentId } = req.params;
    
    // ä»æ•°æ®åº“è·å–é™„ä»¶ä¿¡æ¯
    const attachment = await getAttachmentById(attachmentId);
    if (!attachment) {
      return res.status(404).json({ 
        error: 'é™„ä»¶ä¸å­˜åœ¨',
        code: 'ATTACHMENT_NOT_FOUND'
      });
    }
    
    // åˆ é™¤ç‰©ç†æ–‡ä»¶
    await deletePhysicalFiles(attachment);
    
    // ä»æ•°æ®åº“åˆ é™¤é™„ä»¶è®°å½•
    await deleteAttachmentFromDatabase(attachmentId);
    
    // è®°å½•åˆ é™¤æ—¥å¿—
    await logFileProcessing(attachmentId, 'delete', 'success', null, Date.now());
    
    res.json({
      success: true,
      message: 'é™„ä»¶åˆ é™¤æˆåŠŸ',
      deletedAttachment: {
        id: attachmentId,
        originalName: attachment.original_name
      }
    });
    
  } catch (error) {
    console.error('åˆ é™¤é™„ä»¶é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'åˆ é™¤é™„ä»¶å¤±è´¥',
      details: error.message,
      code: 'DELETE_ATTACHMENT_ERROR'
    });
  }
});

// æ‰¹é‡åˆ é™¤é™„ä»¶
app.delete('/api/attachments/batch', async (req, res) => {
  try {
    const { attachmentIds } = req.body;
    
    if (!attachmentIds || !Array.isArray(attachmentIds) || attachmentIds.length === 0) {
      return res.status(400).json({ 
        error: 'é™„ä»¶IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º',
        code: 'EMPTY_ATTACHMENT_IDS'
      });
    }
    
    const deleteResults = [];
    const errors = [];
    
    // å¹¶è¡Œåˆ é™¤æ‰€æœ‰é™„ä»¶
    const deletePromises = attachmentIds.map(async (attachmentId) => {
      try {
        const attachment = await getAttachmentById(attachmentId);
        if (!attachment) {
          errors.push({
            attachmentId,
            error: 'é™„ä»¶ä¸å­˜åœ¨',
            status: 'failed'
          });
          return;
        }
        
        // åˆ é™¤ç‰©ç†æ–‡ä»¶
        await deletePhysicalFiles(attachment);
        
        // ä»æ•°æ®åº“åˆ é™¤
        await deleteAttachmentFromDatabase(attachmentId);
        
        // è®°å½•åˆ é™¤æ—¥å¿—
        await logFileProcessing(attachmentId, 'delete', 'success', null, Date.now());
        
        deleteResults.push({
          attachmentId,
          originalName: attachment.original_name,
          status: 'success'
        });
        
      } catch (error) {
        console.error(`åˆ é™¤é™„ä»¶å¤±è´¥: ${attachmentId}`, error);
        errors.push({
          attachmentId,
          error: error.message,
          status: 'failed'
        });
      }
    });
    
    await Promise.all(deletePromises);
    
    res.json({
      success: true,
      message: `æ‰¹é‡åˆ é™¤å®Œæˆ: ${deleteResults.length} æˆåŠŸ, ${errors.length} å¤±è´¥`,
      results: {
        successful: deleteResults,
        failed: errors
      }
    });
    
  } catch (error) {
    console.error('æ‰¹é‡åˆ é™¤é™„ä»¶é”™è¯¯:', error);
    res.status(500).json({ 
      error: 'æ‰¹é‡åˆ é™¤é™„ä»¶å¤±è´¥',
      details: error.message,
      code: 'BATCH_DELETE_ERROR'
    });
  }
});
```

---

## ğŸš€ **ä¸‹ä¸€æ­¥ï¼šæ–‡ä»¶å­˜å‚¨ç®¡ç†**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘æ–‡ä»¶å­˜å‚¨ç®¡ç†åŠŸèƒ½ã€‚

---

## âš ï¸ **å¾…ç¡®è®¤äº‹é¡¹è®°å½•**

### **éœ€è¦åç»­å¼€å‘æ—¶ç¡®è®¤çš„é—®é¢˜**

#### **1. APIç«¯ç‚¹åŠŸèƒ½ç¡®è®¤**
- [ ] APIç«¯ç‚¹çš„åŠŸèƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»–ç«¯ç‚¹ï¼Ÿ
- [ ] ç«¯ç‚¹å‚æ•°è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ

#### **2. é”™è¯¯å¤„ç†å®Œå–„æ€§**
- [ ] é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ˜¯å¦å®Œå–„ï¼Ÿ
- [ ] é”™è¯¯ä»£ç æ˜¯å¦æ ‡å‡†åŒ–ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ æ›´å¤šé”™è¯¯ç±»å‹ï¼Ÿ

#### **3. æ–‡ä»¶å®‰å…¨éªŒè¯**
- [ ] æ–‡ä»¶å®‰å…¨éªŒè¯æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ ç—…æ¯’æ‰«æï¼Ÿ
- [ ] æ–‡ä»¶ç±»å‹éªŒè¯æ˜¯å¦ä¸¥æ ¼ï¼Ÿ

#### **4. æ€§èƒ½ä¼˜åŒ–åˆç†æ€§**
- [ ] æ€§èƒ½ä¼˜åŒ–æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ ç¼“å­˜ç­–ç•¥ï¼Ÿ
- [ ] å¹¶å‘å¤„ç†æ˜¯å¦ä¼˜åŒ–ï¼Ÿ

---

## ğŸš€ **ç»§ç»­å¼€å‘ï¼šæ–‡ä»¶å­˜å‚¨ç®¡ç†æ¨¡å—**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘æ–‡ä»¶å­˜å‚¨ç®¡ç†åŠŸèƒ½ã€‚

---

## ğŸ”§ **ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶å­˜å‚¨ç®¡ç†**

### **4.1 æ–‡ä»¶å­˜å‚¨ç­–ç•¥è®¾è®¡**

#### **4.1.1 å­˜å‚¨ç­–ç•¥é…ç½®**

```javascript
// å­˜å‚¨ç­–ç•¥é…ç½®
const STORAGE_CONFIG = {
  // å­˜å‚¨ç­–ç•¥ï¼šlocal | s3 | hybrid
  strategy: process.env.STORAGE_STRATEGY || 'local',
  
  // æœ¬åœ°å­˜å‚¨é…ç½®
  local: {
    baseDir: process.env.UPLOAD_BASE_DIR || 'uploads',
    tempRetention: 24 * 60 * 60 * 1000,        // ä¸´æ—¶æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼š24å°æ—¶
    cacheRetention: 7 * 24 * 60 * 60 * 1000,   // ç¼“å­˜ä¿ç•™æ—¶é—´ï¼š7å¤©
    thumbnailRetention: 30 * 24 * 60 * 60 * 1000, // ç¼©ç•¥å›¾ä¿ç•™æ—¶é—´ï¼š30å¤©
    archiveRetention: 90 * 24 * 60 * 60 * 1000    // å½’æ¡£ä¿ç•™æ—¶é—´ï¼š90å¤©
  },
  
  // AWS S3é…ç½®ï¼ˆå¯é€‰ï¼‰
  s3: {
    enabled: process.env.USE_S3_STORAGE === 'true',
    bucket: process.env.AWS_S3_BUCKET,
    region: process.env.AWS_REGION,
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
    // äº‘å­˜å‚¨ä¿ç•™ç­–ç•¥ï¼ˆä¸æœ¬åœ°ä¿æŒä¸€è‡´ï¼‰
    tempRetention: 24 * 60 * 60 * 1000,
    cacheRetention: 7 * 24 * 60 * 60 * 1000,
    thumbnailRetention: 30 * 24 * 60 * 60 * 1000,
    archiveRetention: 90 * 24 * 60 * 60 * 1000
  },
  
  // æ··åˆå­˜å‚¨é…ç½®
  hybrid: {
    enabled: process.env.USE_HYBRID_STORAGE === 'true',
    localThreshold: parseInt(process.env.LOCAL_FILE_SIZE_THRESHOLD) || 10 * 1024 * 1024, // 10MBä»¥ä¸‹æœ¬åœ°å­˜å‚¨
    s3Threshold: parseInt(process.env.S3_FILE_SIZE_THRESHOLD) || 100 * 1024 * 1024,     // 100MBä»¥ä¸ŠS3å­˜å‚¨
    fallbackToLocal: process.env.FALLBACK_TO_LOCAL === 'true' // äº‘å­˜å‚¨å¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°
  }
};

// å­˜å‚¨ç›®å½•ç»“æ„ç®¡ç†ç±»
class FileStorageManager {
  constructor() {
    this.config = STORAGE_CONFIG;
    this.strategy = this.config.strategy;
    
    // æ ¹æ®ç­–ç•¥åˆå§‹åŒ–ç›®å½•ç»“æ„
    if (this.strategy === 'local' || this.strategy === 'hybrid') {
      this.initLocalDirectories();
    }
    
    if (this.strategy === 's3' || this.strategy === 'hybrid') {
      this.initS3Storage();
    }
  }
  
  /**
   * åˆå§‹åŒ–æœ¬åœ°ç›®å½•ç»“æ„
   */
  initLocalDirectories() {
    const baseDir = this.config.local.baseDir;
    this.localDirs = {
      temp: path.join(baseDir, 'temp'),           // ä¸´æ—¶æ–‡ä»¶
      processed: path.join(baseDir, 'processed'), // å¤„ç†ä¸­æ–‡ä»¶
      attachments: path.join(baseDir, 'attachments'), // æœ€ç»ˆé™„ä»¶
      thumbnails: path.join(baseDir, 'thumbnails'),   // ç¼©ç•¥å›¾
      logs: path.join(baseDir, 'logs'),           // æ—¥å¿—æ–‡ä»¶
      cache: path.join(baseDir, 'cache')          // ç¼“å­˜æ–‡ä»¶
    };
    
    this.ensureLocalDirectories();
  }
  
  /**
   * åˆå§‹åŒ–S3å­˜å‚¨
   */
  initS3Storage() {
    if (this.config.s3.enabled && this.config.s3.bucket) {
      // S3å­˜å‚¨åˆå§‹åŒ–é€»è¾‘ï¼ˆåç»­å®ç°ï¼‰
      console.log('â˜ï¸ S3å­˜å‚¨å·²å¯ç”¨');
    }
  }
}

// å­˜å‚¨æ¥å£æŠ½è±¡
class IStorageProvider {
  /**
   * ç¡®ä¿ç›®å½•å­˜åœ¨
   */
  async ensureDirectory(path) {
    throw new Error('ensureDirectoryæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * è·å–æ–‡ä»¶å­˜å‚¨è·¯å¾„
   */
  async getStoragePath(fileType, attachmentId, filename) {
    throw new Error('getStoragePathæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * è·å–ç¼©ç•¥å›¾å­˜å‚¨è·¯å¾„
   */
  async getThumbnailPath(attachmentId, originalExt) {
    throw new Error('getThumbnailPathæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * ç§»åŠ¨æ–‡ä»¶
   */
  async moveFile(sourcePath, targetPath) {
    throw new Error('moveFileæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * å¤åˆ¶æ–‡ä»¶
   */
  async copyFile(sourcePath, targetPath) {
    throw new Error('copyFileæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * åˆ é™¤æ–‡ä»¶
   */
  async deleteFile(filePath) {
    throw new Error('deleteFileæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   */
  async fileExists(filePath) {
    throw new Error('fileExistsæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * è·å–æ–‡ä»¶ä¿¡æ¯
   */
  async getFileStats(filePath) {
    throw new Error('getFileStatsæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
  
  /**
   * æ‰«æç›®å½•
   */
  async scanDirectory(dirPath) {
    throw new Error('scanDirectoryæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°');
  }
}

// æœ¬åœ°å­˜å‚¨å®ç°
class LocalStorageProvider extends IStorageProvider {
  constructor(config) {
    super();
    this.config = config;
    this.dirs = config.localDirs;
  }
  
  /**
   * ç¡®ä¿ç›®å½•å­˜åœ¨
   */
  async ensureDirectory(dirPath) {
    if (!fs.existsSync(dirPath)) {
      fs.mkdirSync(dirPath, { recursive: true });
      console.log(`ğŸ“ åˆ›å»ºç›®å½•: ${dirPath}`);
    }
  }
  
  /**
   * è·å–æ–‡ä»¶å­˜å‚¨è·¯å¾„
   */
  async getStoragePath(fileType, attachmentId, filename) {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    // æŒ‰æ—¥æœŸç»„ç»‡æ–‡ä»¶ï¼šuploads/attachments/2024/01/15/
    const datePath = path.join(this.dirs.attachments, String(year), month, day);
    
    await this.ensureDirectory(datePath);
    return path.join(datePath, filename);
  }
  
  /**
   * è·å–ç¼©ç•¥å›¾å­˜å‚¨è·¯å¾„
   */
  async getThumbnailPath(attachmentId, originalExt) {
    const thumbnailDir = path.join(this.dirs.thumbnails, attachmentId.substring(0, 2));
    
    await this.ensureDirectory(thumbnailDir);
    return path.join(thumbnailDir, `${attachmentId}.webp`);
  }
  
  /**
   * ç§»åŠ¨æ–‡ä»¶
   */
  async moveFile(sourcePath, targetPath) {
    await this.ensureDirectory(path.dirname(targetPath));
    await fs.promises.rename(sourcePath, targetPath);
    console.log(`ğŸ“ æ–‡ä»¶å·²ç§»åŠ¨: ${sourcePath} -> ${targetPath}`);
  }
  
  /**
   * å¤åˆ¶æ–‡ä»¶
   */
  async copyFile(sourcePath, targetPath) {
    await this.ensureDirectory(path.dirname(targetPath));
    await fs.promises.copyFile(sourcePath, targetPath);
    console.log(`ğŸ“‹ æ–‡ä»¶å·²å¤åˆ¶: ${sourcePath} -> ${targetPath}`);
  }
  
  /**
   * åˆ é™¤æ–‡ä»¶
   */
  async deleteFile(filePath) {
    if (await this.fileExists(filePath)) {
      await fs.promises.unlink(filePath);
      console.log(`ğŸ—‘ï¸ æ–‡ä»¶å·²åˆ é™¤: ${filePath}`);
    }
  }
  
  /**
   * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   */
  async fileExists(filePath) {
    try {
      await fs.promises.access(filePath);
      return true;
    } catch {
      return false;
    }
  }
  
  /**
   * è·å–æ–‡ä»¶ä¿¡æ¯
   */
  async getFileStats(filePath) {
    return await fs.promises.stat(filePath);
  }
  
  /**
   * æ‰«æç›®å½•
   */
  async scanDirectory(dirPath) {
    const files = [];
    
    const scan = async (currentDir) => {
      const items = await fs.promises.readdir(currentDir);
      
      for (const item of items) {
        const fullPath = path.join(currentDir, item);
        const stats = await fs.promises.stat(fullPath);
        
        if (stats.isFile()) {
          files.push(fullPath);
        } else if (stats.isDirectory()) {
          await scan(fullPath);
        }
      }
    };
    
    await scan(dirPath);
    return files;
  }
}

// äº‘å­˜å‚¨å®ç°ï¼ˆå ä½ç¬¦ï¼Œåç»­å®ç°ï¼‰
/**
 * S3å­˜å‚¨æä¾›è€… (ç¬¬äºŒé˜¶æ®µåŠŸèƒ½)
 * âš ï¸ å½“å‰çŠ¶æ€ï¼šæœªå®ç°ï¼Œè®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå¼€å‘
 */
class S3StorageProvider extends IStorageProvider {
  constructor(config) {
    super();
    this.config = config;
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3å®¢æˆ·ç«¯åˆå§‹åŒ–
    // this.s3 = new AWS.S3(config);
  }
  
  // ğŸ“‹ ç¬¬äºŒé˜¶æ®µå¾…å®ç°çš„æ–¹æ³•
  async ensureDirectory(dirPath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3å­˜å‚¨æ¡¶ç›®å½•ç¡®ä¿
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return false;
  }
  
  async getStoragePath(fileType, attachmentId, filename) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3å­˜å‚¨è·¯å¾„ç”Ÿæˆ
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return null;
  }
  
  async getThumbnailPath(attachmentId, originalExt) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3ç¼©ç•¥å›¾è·¯å¾„ç”Ÿæˆ
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return null;
  }
  
  async moveFile(sourcePath, targetPath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3æ–‡ä»¶ç§»åŠ¨
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return false;
  }
  
  async copyFile(sourcePath, targetPath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3æ–‡ä»¶å¤åˆ¶
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return false;
  }
  
  async deleteFile(filePath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3æ–‡ä»¶åˆ é™¤
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return false;
  }
  
  async fileExists(filePath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3æ–‡ä»¶å­˜åœ¨æ£€æŸ¥
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return false;
  }
  
  async getFileStats(filePath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3æ–‡ä»¶çŠ¶æ€è·å–
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return null;
  }
  
  async scanDirectory(dirPath) {
    // TODO: ç¬¬äºŒé˜¶æ®µå®ç° - S3ç›®å½•æ‰«æ
    console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
    return [];
  }
}

// å­˜å‚¨å·¥å‚
class StorageFactory {
  static createStorageProvider(config) {
    switch (config.strategy) {
      case 'local':
        return new LocalStorageProvider(config);
      case 's3':
        // âš ï¸ S3åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰å›é€€åˆ°æœ¬åœ°å­˜å‚¨
        console.warn('S3å­˜å‚¨åŠŸèƒ½è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰å›é€€åˆ°æœ¬åœ°å­˜å‚¨');
        return new LocalStorageProvider(config);
      case 'hybrid':
        // âš ï¸ æ··åˆå­˜å‚¨ç­–ç•¥è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨
        console.warn('æ··åˆå­˜å‚¨ç­–ç•¥è®¡åˆ’åœ¨ç¬¬äºŒé˜¶æ®µå®ç°ï¼Œå½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
        return new LocalStorageProvider(config);
      default:
        console.warn('æœªçŸ¥å­˜å‚¨ç­–ç•¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
        return new LocalStorageProvider(config);
    }
  }
}

// æ›´æ–°åçš„FileStorageManager
class FileStorageManager {
  constructor() {
    this.config = STORAGE_CONFIG;
    this.strategy = this.config.strategy;
    
    // æ ¹æ®ç­–ç•¥åˆå§‹åŒ–ç›®å½•ç»“æ„
    if (this.strategy === 'local' || this.strategy === 'hybrid') {
      this.initLocalDirectories();
    }
    
    if (this.strategy === 's3' || this.strategy === 'hybrid') {
      this.initS3Storage();
    }
    
    // åˆ›å»ºå­˜å‚¨æä¾›è€…
    this.storageProvider = StorageFactory.createStorageProvider(this.config);
  }
  
  /**
   * åˆå§‹åŒ–æœ¬åœ°ç›®å½•ç»“æ„
   */
  initLocalDirectories() {
    const baseDir = this.config.local.baseDir;
    this.localDirs = {
      temp: path.join(baseDir, 'temp'),           // ä¸´æ—¶æ–‡ä»¶
      processed: path.join(baseDir, 'processed'), // å¤„ç†ä¸­æ–‡ä»¶
      attachments: path.join(baseDir, 'attachments'), // æœ€ç»ˆé™„ä»¶
      thumbnails: path.join(baseDir, 'thumbnails'),   // ç¼©ç•¥å›¾
      logs: path.join(baseDir, 'logs'),           // æ—¥å¿—æ–‡ä»¶
      cache: path.join(baseDir, 'cache')          // ç¼“å­˜æ–‡ä»¶
    };
    
    this.config.localDirs = this.localDirs;
  }
  
  /**
   * åˆå§‹åŒ–S3å­˜å‚¨
   */
  initS3Storage() {
    if (this.config.s3.enabled && this.config.s3.bucket) {
      // S3å­˜å‚¨åˆå§‹åŒ–é€»è¾‘ï¼ˆåç»­å®ç°ï¼‰
      console.log('â˜ï¸ S3å­˜å‚¨å·²å¯ç”¨');
    }
  }
  
  /**
   * ç¡®ä¿æ‰€æœ‰å¿…è¦çš„ç›®å½•å­˜åœ¨
   */
  async ensureDirectories() {
    return await this.storageProvider.ensureDirectory(this.localDirs.temp);
  }
  
  /**
   * è·å–æ–‡ä»¶å­˜å‚¨è·¯å¾„
   */
  async getStoragePath(fileType, attachmentId, filename) {
    return await this.storageProvider.getStoragePath(fileType, attachmentId, filename);
  }
  
  /**
   * è·å–ç¼©ç•¥å›¾å­˜å‚¨è·¯å¾„
   */
  async getThumbnailPath(attachmentId, originalExt) {
    return await this.storageProvider.getThumbnailPath(attachmentId, originalExt);
  }
  
  /**
   * æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   */
  async cleanupTempFiles(maxAge = 24 * 60 * 60 * 1000) { // é»˜è®¤24å°æ—¶
    try {
      const tempFiles = await this.storageProvider.scanDirectory(this.localDirs.temp);
      const now = Date.now();
      let cleanedCount = 0;
      
      for (const file of tempFiles) {
        const stats = await this.storageProvider.getFileStats(file);
        if (now - stats.mtime.getTime() > maxAge) {
          await this.storageProvider.deleteFile(file);
          cleanedCount++;
        }
      }
      
      console.log(`ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶: ${cleanedCount} ä¸ª`);
      return cleanedCount;
    } catch (error) {
      console.error('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ‰«æç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
   */
  async scanDirectory(dir) {
    return await this.storageProvider.scanDirectory(dir);
  }
  
  /**
   * è·å–æ–‡ä»¶å­˜å‚¨è·¯å¾„
   */
  getStoragePath(fileType, attachmentId, filename) {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    // æŒ‰æ—¥æœŸç»„ç»‡æ–‡ä»¶ï¼šuploads/attachments/2024/01/15/
    const datePath = path.join(this.dirs.attachments, String(year), month, day);
    
    if (!fs.existsSync(datePath)) {
      fs.mkdirSync(datePath, { recursive: true });
    }
    
    return path.join(datePath, filename);
  }
  
  /**
   * è·å–ç¼©ç•¥å›¾å­˜å‚¨è·¯å¾„
   */
  getThumbnailPath(attachmentId, originalExt) {
    const thumbnailDir = path.join(this.dirs.thumbnails, attachmentId.substring(0, 2));
    
    if (!fs.existsSync(thumbnailDir)) {
      fs.mkdirSync(thumbnailDir, { recursive: true });
    }
    
    return path.join(thumbnailDir, `${attachmentId}.webp`);
  }
  
  /**
   * æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   */
  async cleanupTempFiles(maxAge = 24 * 60 * 60 * 1000) { // é»˜è®¤24å°æ—¶
    try {
      const tempFiles = await this.scanDirectory(this.dirs.temp);
      const now = Date.now();
      let cleanedCount = 0;
      
      for (const file of tempFiles) {
        const stats = await fs.stat(file);
        if (now - stats.mtime.getTime() > maxAge) {
          await fs.unlink(file);
          cleanedCount++;
        }
      }
      
      console.log(`ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶: ${cleanedCount} ä¸ª`);
      return cleanedCount;
    } catch (error) {
      console.error('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ‰«æç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
   */
  async scanDirectory(dir) {
    const files = [];
    
    const scan = async (currentDir) => {
      const items = await fs.readdir(currentDir);
      
      for (const item of items) {
        const fullPath = path.join(currentDir, item);
        const stats = await fs.stat(fullPath);
        
        if (stats.isFile()) {
          files.push(fullPath);
        } else if (stats.isDirectory()) {
          await scan(fullPath);
        }
      }
    };
    
    await scan(dir);
    return files;
  }
}

module.exports = FileStorageManager;
```

#### **4.1.2 æ–‡ä»¶ç§»åŠ¨å’Œå­˜å‚¨**
```javascript
// æ–‡ä»¶ç§»åŠ¨å’Œå­˜å‚¨å·¥å…·
class FileMover {
  /**
   * ç§»åŠ¨æ–‡ä»¶åˆ°æœ€ç»ˆå­˜å‚¨ä½ç½®
   */
  static async moveFileToStorage(tempPath, attachmentId, fileType) {
    try {
      const storageManager = new FileStorageManager();
      const filename = `${attachmentId}${path.extname(tempPath)}`;
      const finalPath = storageManager.getStoragePath(fileType, attachmentId, filename);
      
      // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
      const targetDir = path.dirname(finalPath);
      if (!fs.existsSync(targetDir)) {
        await fs.mkdir(targetDir, { recursive: true });
      }
      
      // ç§»åŠ¨æ–‡ä»¶
      await fs.rename(tempPath, finalPath);
      
      console.log(`ğŸ“ æ–‡ä»¶å·²ç§»åŠ¨åˆ°: ${finalPath}`);
      return finalPath;
      
    } catch (error) {
      console.error('ç§»åŠ¨æ–‡ä»¶å¤±è´¥:', error);
      throw new Error(`ç§»åŠ¨æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * å¤åˆ¶æ–‡ä»¶åˆ°ç¼“å­˜ä½ç½®
   */
  static async copyToCache(sourcePath, cacheKey) {
    try {
      const storageManager = new FileStorageManager();
      const cachePath = path.join(storageManager.dirs.cache, `${cacheKey}${path.extname(sourcePath)}`);
      
      // ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨
      const cacheDir = path.dirname(cachePath);
      if (!fs.existsSync(cacheDir)) {
        await fs.mkdir(cacheDir, { recursive: true });
      }
      
      // å¤åˆ¶æ–‡ä»¶
      await fs.copyFile(sourcePath, cachePath);
      
      console.log(`ğŸ’¾ æ–‡ä»¶å·²ç¼“å­˜: ${cachePath}`);
      return cachePath;
      
    } catch (error) {
      console.error('ç¼“å­˜æ–‡ä»¶å¤±è´¥:', error);
      throw new Error(`ç¼“å­˜æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * åˆ é™¤ç‰©ç†æ–‡ä»¶
   */
  static async deletePhysicalFiles(attachment) {
    try {
      const filesToDelete = [];
      
      // ä¸»æ–‡ä»¶
      if (attachment.file_path && fs.existsSync(attachment.file_path)) {
        filesToDelete.push(attachment.file_path);
      }
      
      // ç¼©ç•¥å›¾
      if (attachment.thumbnail_path && fs.existsSync(attachment.thumbnail_path)) {
        filesToDelete.push(attachment.thumbnail_path);
      }
      
      // å¹¶è¡Œåˆ é™¤æ‰€æœ‰æ–‡ä»¶
      const deletePromises = filesToDelete.map(async (filePath) => {
        try {
          await fs.unlink(filePath);
          console.log(`ğŸ—‘ï¸ å·²åˆ é™¤æ–‡ä»¶: ${filePath}`);
        } catch (error) {
          console.warn(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${filePath}`, error);
        }
      });
      
      await Promise.all(deletePromises);
      
      // å°è¯•æ¸…ç†ç©ºç›®å½•
      await this.cleanupEmptyDirectories(attachment.file_path);
      
    } catch (error) {
      console.error('åˆ é™¤ç‰©ç†æ–‡ä»¶å¤±è´¥:', error);
      throw new Error(`åˆ é™¤ç‰©ç†æ–‡ä»¶å¤±è´¥: ${error.message}`);
    }
  }
  
  /**
   * æ¸…ç†ç©ºç›®å½•
   */
  static async cleanupEmptyDirectories(filePath) {
    try {
      let currentDir = path.dirname(filePath);
      const baseDir = new FileStorageManager().dirs.attachments;
      
      while (currentDir.startsWith(baseDir) && currentDir !== baseDir) {
        const items = await fs.readdir(currentDir);
        
        if (items.length === 0) {
          await fs.rmdir(currentDir);
          console.log(`ğŸ—‘ï¸ å·²åˆ é™¤ç©ºç›®å½•: ${currentDir}`);
          currentDir = path.dirname(currentDir);
        } else {
          break;
        }
      }
    } catch (error) {
      console.warn('æ¸…ç†ç©ºç›®å½•å¤±è´¥:', error);
    }
  }
}

module.exports = FileMover;
```

### **4.2 æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†**

#### **4.2.1 ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ç®¡ç†**
```javascript
// æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ç±»
class FileLifecycleManager {
  constructor() {
    this.states = {
      UPLOADING: 'uploading',           // ä¸Šä¼ ä¸­
      PROCESSING: 'processing',         // å¤„ç†ä¸­
      READY: 'ready',                   // å°±ç»ª
      ARCHIVED: 'archived',             // å·²å½’æ¡£
      DELETED: 'deleted',               // å·²åˆ é™¤
      ERROR: 'error'                    // é”™è¯¯çŠ¶æ€
    };
    
    this.transitions = {
      [this.states.UPLOADING]: [this.states.PROCESSING, this.states.ERROR],
      [this.states.PROCESSING]: [this.states.READY, this.states.ERROR],
      [this.states.READY]: [this.states.ARCHIVED, this.states.DELETED],
      [this.states.ARCHIVED]: [this.states.READY, this.states.DELETED],
      [this.states.ERROR]: [this.states.UPLOADING, this.states.DELETED]
    };
  }
  
  /**
   * æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦æœ‰æ•ˆ
   */
  isValidTransition(fromState, toState) {
    return this.transitions[fromState]?.includes(toState) || false;
  }
  
  /**
   * æ›´æ–°æ–‡ä»¶çŠ¶æ€
   */
  async updateFileState(attachmentId, newState, metadata = {}) {
    try {
      // éªŒè¯çŠ¶æ€è½¬æ¢
      const currentState = await this.getCurrentFileState(attachmentId);
      if (currentState && !this.isValidTransition(currentState, newState)) {
        throw new Error(`æ— æ•ˆçš„çŠ¶æ€è½¬æ¢: ${currentState} -> ${newState}`);
      }
      
      // æ›´æ–°æ•°æ®åº“çŠ¶æ€
      await this.updateAttachmentState(attachmentId, newState);
      
      // è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—
      await logFileProcessing(attachmentId, 'state_change', 'success', 
        `çŠ¶æ€å˜æ›´: ${currentState || 'none'} -> ${newState}`, Date.now());
      
      // æ‰§è¡ŒçŠ¶æ€ç›¸å…³çš„æ“ä½œ
      await this.executeStateActions(attachmentId, newState, metadata);
      
      console.log(`ğŸ”„ æ–‡ä»¶çŠ¶æ€å·²æ›´æ–°: ${attachmentId} -> ${newState}`);
      
    } catch (error) {
      console.error('æ›´æ–°æ–‡ä»¶çŠ¶æ€å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ‰§è¡ŒçŠ¶æ€ç›¸å…³çš„æ“ä½œ
   */
  async executeStateActions(attachmentId, state, metadata) {
    switch (state) {
      case this.states.READY:
        // æ–‡ä»¶å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        await this.cleanupTempFiles(attachmentId);
        break;
        
      case this.states.ARCHIVED:
        // æ–‡ä»¶å½’æ¡£ï¼Œç§»åŠ¨åˆ°å½’æ¡£ç›®å½•
        await this.archiveFile(attachmentId);
        break;
        
      case this.states.DELETED:
        // æ–‡ä»¶åˆ é™¤ï¼Œæ¸…ç†æ‰€æœ‰ç›¸å…³æ–‡ä»¶
        await this.cleanupDeletedFile(attachmentId);
        break;
        
      case this.states.ERROR:
        // æ–‡ä»¶é”™è¯¯ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
        await this.handleFileError(attachmentId, metadata);
        break;
    }
  }
  
  /**
   * æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   */
  async cleanupTempFiles(attachmentId) {
    try {
      const attachment = await getAttachmentById(attachmentId);
      if (attachment && attachment.temp_path && fs.existsSync(attachment.temp_path)) {
        await fs.unlink(attachment.temp_path);
        console.log(`ğŸ§¹ å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶: ${attachment.temp_path}`);
      }
    } catch (error) {
      console.warn('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', error);
    }
  }
  
  /**
   * å½’æ¡£æ–‡ä»¶
   */
  async archiveFile(attachmentId) {
    try {
      const attachment = await getAttachmentById(attachmentId);
      if (!attachment) return;
      
      const archiveDir = path.join(new FileStorageManager().baseDir, 'archived');
      if (!fs.existsSync(archiveDir)) {
        await fs.mkdir(archiveDir, { recursive: true });
      }
      
      const archivePath = path.join(archiveDir, path.basename(attachment.file_path));
      await fs.rename(attachment.file_path, archivePath);
      
      // æ›´æ–°æ•°æ®åº“ä¸­çš„æ–‡ä»¶è·¯å¾„
      await updateAttachmentFilePath(attachmentId, archivePath);
      
      console.log(`ğŸ“¦ æ–‡ä»¶å·²å½’æ¡£: ${attachmentId} -> ${archivePath}`);
      
    } catch (error) {
      console.error('å½’æ¡£æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * å¤„ç†æ–‡ä»¶é”™è¯¯
   */
  async handleFileError(attachmentId, metadata) {
    try {
      const errorMessage = metadata.error || 'æœªçŸ¥é”™è¯¯';
      const errorCode = metadata.errorCode || 'UNKNOWN_ERROR';
      
      // è®°å½•é”™è¯¯æ—¥å¿—
      await logFileProcessing(attachmentId, 'error_handling', 'failed', 
        `é”™è¯¯å¤„ç†: ${errorCode} - ${errorMessage}`, Date.now());
      
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯é€šçŸ¥é€»è¾‘
      console.error(`âŒ æ–‡ä»¶é”™è¯¯: ${attachmentId} - ${errorCode}: ${errorMessage}`);
      
    } catch (error) {
      console.error('å¤„ç†æ–‡ä»¶é”™è¯¯å¤±è´¥:', error);
    }
  }
}

module.exports = FileLifecycleManager;
```

#### **4.2.2 è‡ªåŠ¨æ¸…ç†å’Œå½’æ¡£ç­–ç•¥**
```javascript
// è‡ªåŠ¨æ¸…ç†å’Œå½’æ¡£ç­–ç•¥
class FileCleanupStrategy {
  constructor() {
    this.config = {
      tempFileMaxAge: 24 * 60 * 60 * 1000,        // ä¸´æ—¶æ–‡ä»¶æœ€å¤§ä¿ç•™æ—¶é—´ï¼š24å°æ—¶
      cacheFileMaxAge: 7 * 24 * 60 * 60 * 1000,   // ç¼“å­˜æ–‡ä»¶æœ€å¤§ä¿ç•™æ—¶é—´ï¼š7å¤©
      thumbnailMaxAge: 30 * 24 * 60 * 60 * 1000,  // ç¼©ç•¥å›¾æœ€å¤§ä¿ç•™æ—¶é—´ï¼š30å¤©
      archivedFileMaxAge: 90 * 24 * 60 * 60 * 1000, // å½’æ¡£æ–‡ä»¶æœ€å¤§ä¿ç•™æ—¶é—´ï¼š90å¤©
      cleanupInterval: 60 * 60 * 1000,             // æ¸…ç†é—´éš”ï¼š1å°æ—¶
      batchSize: 100                               // æ‰¹é‡å¤„ç†å¤§å°
    };
  }
  
  /**
   * å¯åŠ¨è‡ªåŠ¨æ¸…ç†ä»»åŠ¡
   */
  startAutoCleanup() {
    console.log('ğŸ§¹ å¯åŠ¨è‡ªåŠ¨æ¸…ç†ä»»åŠ¡');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸…ç†
    this.performCleanup();
    
    // è®¾ç½®å®šæ—¶æ¸…ç†
    setInterval(() => {
      this.performCleanup();
    }, this.config.cleanupInterval);
  }
  
  /**
   * æ‰§è¡Œæ¸…ç†ä»»åŠ¡
   */
  async performCleanup() {
    try {
      console.log('ğŸ§¹ å¼€å§‹æ‰§è¡Œæ¸…ç†ä»»åŠ¡...');
      
      const startTime = Date.now();
      
      // å¹¶è¡Œæ‰§è¡Œå„ç§æ¸…ç†ä»»åŠ¡
      const cleanupTasks = [
        this.cleanupTempFiles(),
        this.cleanupCacheFiles(),
        this.cleanupThumbnails(),
        this.cleanupArchivedFiles(),
        this.cleanupOrphanedFiles()
      ];
      
      const results = await Promise.allSettled(cleanupTasks);
      
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      // ç»Ÿè®¡æ¸…ç†ç»“æœ
      const summary = {
        totalFiles: 0,
        cleanedFiles: 0,
        errors: 0,
        duration: duration
      };
      
      results.forEach((result, index) => {
        if (result.status === 'fulfilled') {
          summary.totalFiles += result.value.total || 0;
          summary.cleanedFiles += result.value.cleaned || 0;
        } else {
          summary.errors++;
        }
      });
      
      console.log(`ğŸ§¹ æ¸…ç†ä»»åŠ¡å®Œæˆ: å¤„ç† ${summary.totalFiles} ä¸ªæ–‡ä»¶, æ¸…ç† ${summary.cleanedFiles} ä¸ª, é”™è¯¯ ${summary.errors} ä¸ª, è€—æ—¶ ${duration}ms`);
      
    } catch (error) {
      console.error('æ‰§è¡Œæ¸…ç†ä»»åŠ¡å¤±è´¥:', error);
    }
  }
  
  /**
   * æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   */
  async cleanupTempFiles() {
    try {
      const storageManager = new FileStorageManager();
      const tempFiles = await storageManager.scanDirectory(storageManager.dirs.temp);
      const now = Date.now();
      let cleanedCount = 0;
      
      for (const file of tempFiles) {
        try {
          const stats = await fs.stat(file);
          if (now - stats.mtime.getTime() > this.config.tempFileMaxAge) {
            await fs.unlink(file);
            cleanedCount++;
          }
        } catch (error) {
          console.warn(`æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥: ${file}`, error);
        }
      }
      
      console.log(`ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ: ${cleanedCount} ä¸ª`);
      return { total: tempFiles.length, cleaned: cleanedCount };
      
    } catch (error) {
      console.error('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ¸…ç†ç¼“å­˜æ–‡ä»¶
   */
  async cleanupCacheFiles() {
    try {
      const storageManager = new FileStorageManager();
      const cacheFiles = await storageManager.scanDirectory(storageManager.dirs.cache);
      const now = Date.now();
      let cleanedCount = 0;
      
      for (const file of cacheFiles) {
        try {
          const stats = await fs.stat(file);
          if (now - stats.mtime.getTime() > this.config.cacheFileMaxAge) {
            await fs.unlink(file);
            cleanedCount++;
          }
        } catch (error) {
          console.warn(`æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥: ${file}`, error);
        }
      }
      
      console.log(`ğŸ§¹ ç¼“å­˜æ–‡ä»¶æ¸…ç†å®Œæˆ: ${cleanedCount} ä¸ª`);
      return { total: cacheFiles.length, cleaned: cleanedCount };
      
    } catch (error) {
      console.error('æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ¸…ç†å­¤ç«‹æ–‡ä»¶ï¼ˆæ•°æ®åº“ä¸­æ²¡æœ‰è®°å½•çš„æ–‡ä»¶ï¼‰
   */
  async cleanupOrphanedFiles() {
    try {
      const storageManager = new FileStorageManager();
      const allFiles = await storageManager.scanDirectory(storageManager.dirs.attachments);
      let orphanedCount = 0;
      
      for (const file of allFiles) {
        try {
          const filename = path.basename(file, path.extname(file));
          const attachment = await getAttachmentByFilename(filename);
          
          if (!attachment) {
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¶…è¿‡ä¿ç•™æ—¶é—´
            const stats = await fs.stat(file);
            const fileAge = Date.now() - stats.mtime.getTime();
            
            if (fileAge > this.config.archivedFileMaxAge) {
              await fs.unlink(file);
              orphanedCount++;
              console.log(`ğŸ—‘ï¸ åˆ é™¤å­¤ç«‹æ–‡ä»¶: ${file}`);
            }
          }
        } catch (error) {
          console.warn(`æ£€æŸ¥å­¤ç«‹æ–‡ä»¶å¤±è´¥: ${file}`, error);
        }
      }
      
      console.log(`ğŸ§¹ å­¤ç«‹æ–‡ä»¶æ¸…ç†å®Œæˆ: ${orphanedCount} ä¸ª`);
      return { total: allFiles.length, cleaned: orphanedCount };
      
    } catch (error) {
      console.error('æ¸…ç†å­¤ç«‹æ–‡ä»¶å¤±è´¥:', error);
      throw error;
    }
  }
}

module.exports = FileCleanupStrategy;
```

---

## âš ï¸ **ç¬¬ä¸‰é˜¶æ®µé—ç•™é—®é¢˜ä¸æ”¹è¿›å»ºè®®**

### **1. APIæ¥å£è®¾è®¡é—®é¢˜**

#### **1.1 ä¸ç°æœ‰chatæ¥å£çš„é›†æˆç­–ç•¥**
- **æ¥å£é€‰æ‹©**ï¼šæ˜¯å¦éœ€è¦ä¿®æ”¹ç°æœ‰çš„`/api/chat`å’Œ`/api/chat/stream`ï¼Ÿ
- **æ–°æ¥å£è®¾è®¡**ï¼š`/api/chat/send`æ˜¯å¦æ˜¯æœ€ä½³é€‰æ‹©ï¼Ÿ
- **æµå¼å¤„ç†**ï¼šæµå¼æ¥å£å¦‚ä½•å¤„ç†é™„ä»¶ï¼Ÿæ˜¯å¦éœ€è¦ç‰¹æ®Šçš„æµå¼å¤„ç†é€»è¾‘ï¼Ÿ
- **å‘åå…¼å®¹**ï¼šå¦‚ä½•ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼Ÿ

#### **1.2 æ–‡ä»¶ä¸Šä¼ å’Œæ¶ˆæ¯å‘é€çš„æ—¶åº**
- **å…ˆä¸Šä¼ åå‘é€**ï¼šç”¨æˆ·å…ˆä¸Šä¼ æ–‡ä»¶ï¼Œå†å‘é€æ¶ˆæ¯ï¼Ÿ
- **åŒæ—¶è¿›è¡Œ**ï¼šæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ¶ˆæ¯å‘é€åŒæ—¶è¿›è¡Œï¼Ÿ
- **æ‰¹é‡å¤„ç†**ï¼šå¦‚ä½•å¤„ç†å¤šä¸ªæ–‡ä»¶çš„æ‰¹é‡ä¸Šä¼ ï¼Ÿ
- **é”™è¯¯å¤„ç†**ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥æ—¶å¦‚ä½•å¤„ç†æ¶ˆæ¯å‘é€ï¼Ÿ

### **2. æ–‡ä»¶å¤„ç†æ€§èƒ½é—®é¢˜**

#### **2.1 å¤§æ–‡ä»¶å¤„ç†**
- **å†…å­˜ä½¿ç”¨**ï¼šå¤§æ–‡ä»¶å¤„ç†è¿‡ç¨‹ä¸­çš„å†…å­˜ç®¡ç†ç­–ç•¥
- **å¤„ç†è¶…æ—¶**ï¼šæ–‡ä»¶å¤„ç†çš„æ—¶é—´é™åˆ¶è®¾ç½®
- **å¹¶å‘æ§åˆ¶**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªå¤§æ–‡ä»¶çš„å¹¶å‘é™åˆ¶
- **è¿›åº¦åé¦ˆ**ï¼šå¦‚ä½•å®ç°å®æ—¶çš„å¤„ç†è¿›åº¦åé¦ˆï¼Ÿ

#### **2.2 æ–‡ä»¶ç±»å‹å¤„ç†**
- **å›¾ç‰‡å¤„ç†**ï¼šç¼©ç•¥å›¾ç”Ÿæˆçš„å°ºå¯¸å’Œè´¨é‡è®¾ç½®
- **æ–‡æ¡£è§£æ**ï¼šPDFã€Wordç­‰æ–‡æ¡£çš„æ–‡æœ¬æå–ç­–ç•¥
- **éŸ³é¢‘è§†é¢‘**ï¼šéŸ³é¢‘è§†é¢‘æ–‡ä»¶çš„å…ƒæ•°æ®æå–
- **æ ¼å¼è½¬æ¢**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ–‡ä»¶æ ¼å¼è½¬æ¢ï¼Ÿ

### **3. å®‰å…¨æ€§å’Œé”™è¯¯å¤„ç†**

#### **3.1 æ–‡ä»¶å®‰å…¨**
- **æ¶æ„æ–‡ä»¶æ£€æµ‹**ï¼šå¦‚ä½•é˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼Ÿ
- **æ–‡ä»¶å†…å®¹éªŒè¯**ï¼šæ–‡ä»¶å†…å®¹ä¸å£°æ˜çš„ç±»å‹æ˜¯å¦ä¸€è‡´ï¼Ÿ
- **è·¯å¾„å®‰å…¨**ï¼šå¦‚ä½•é˜²æ­¢ç›®å½•éå†æ”»å‡»ï¼Ÿ
- **æƒé™æ§åˆ¶**ï¼šæ–‡ä»¶è®¿é—®æƒé™å¦‚ä½•æ§åˆ¶ï¼Ÿ

#### **3.2 é”™è¯¯å¤„ç†æœºåˆ¶**
- **é”™è¯¯åˆ†ç±»**ï¼šå¦‚ä½•å¯¹ä¸åŒç±»å‹çš„é”™è¯¯è¿›è¡Œåˆ†ç±»ï¼Ÿ
- **ç”¨æˆ·åé¦ˆ**ï¼šå¦‚ä½•ç»™ç”¨æˆ·æä¾›å‹å¥½çš„é”™è¯¯æç¤ºï¼Ÿ
- **å›æ»šæœºåˆ¶**ï¼šæ–‡ä»¶å¤„ç†å¤±è´¥æ—¶å¦‚ä½•å›æ»šï¼Ÿ
- **æ—¥å¿—è®°å½•**ï¼šé”™è¯¯æ—¥å¿—çš„è¯¦ç»†ç¨‹åº¦å’Œå­˜å‚¨ç­–ç•¥

### **4. æ‰©å±•æ€§å’Œç»´æŠ¤æ€§**

#### **4.1 æ–°æ¨¡å‹æ¥å…¥**
- **æ¨¡å‹æ³¨å†Œæœºåˆ¶**ï¼šå¦‚ä½•åŠ¨æ€æ·»åŠ æ–°çš„AIæ¨¡å‹ï¼Ÿ
- **è¯·æ±‚æ ¼å¼é€‚é…**ï¼šä¸åŒæ¨¡å‹çš„è¯·æ±‚æ ¼å¼å¦‚ä½•ç»Ÿä¸€ï¼Ÿ
- **å“åº”æ ¼å¼æ ‡å‡†åŒ–**ï¼šå¦‚ä½•ç»Ÿä¸€ä¸åŒæ¨¡å‹çš„å“åº”æ ¼å¼ï¼Ÿ
- **æ¨¡å‹èƒ½åŠ›æ£€æµ‹**ï¼šå¦‚ä½•æ£€æµ‹æ¨¡å‹çš„å¤šæ¨¡æ€èƒ½åŠ›ï¼Ÿ

#### **4.2 é…ç½®ç®¡ç†**
- **ç¯å¢ƒå˜é‡**ï¼šå“ªäº›é…ç½®åº”è¯¥é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Ÿ
- **é…ç½®æ–‡ä»¶**ï¼šæ˜¯å¦éœ€è¦ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼Ÿ
- **åŠ¨æ€é…ç½®**ï¼šæ˜¯å¦æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°ï¼Ÿ
- **é…ç½®éªŒè¯**ï¼šå¦‚ä½•éªŒè¯é…ç½®çš„æ­£ç¡®æ€§ï¼Ÿ

### **5. ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

#### **5.1 ä¸Šä¼ ä½“éªŒ**
- **æ‹–æ‹½ä¸Šä¼ **ï¼šæ˜¯å¦æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼Ÿ
- **è¿›åº¦æ˜¾ç¤º**ï¼šå¦‚ä½•å®ç°å®æ—¶çš„ä¸Šä¼ è¿›åº¦ï¼Ÿ
- **æ–‡ä»¶é¢„è§ˆ**ï¼šä¸Šä¼ åæ˜¯å¦éœ€è¦å³æ—¶é¢„è§ˆï¼Ÿ
- **æ‰¹é‡æ“ä½œ**ï¼šå¦‚ä½•ä¼˜åŒ–æ‰¹é‡æ–‡ä»¶çš„æ“ä½œä½“éªŒï¼Ÿ

#### **5.2 å“åº”é€Ÿåº¦**
- **å¼‚æ­¥å¤„ç†**ï¼šæ–‡ä»¶å¤„ç†æ˜¯å¦åº”è¯¥å¼‚æ­¥è¿›è¡Œï¼Ÿ
- **ç¼“å­˜ç­–ç•¥**ï¼šæ˜¯å¦éœ€è¦æ–‡ä»¶å¤„ç†ç»“æœç¼“å­˜ï¼Ÿ
- **CDNé›†æˆ**ï¼šæ˜¯å¦éœ€è¦CDNæ¥åŠ é€Ÿæ–‡ä»¶è®¿é—®ï¼Ÿ
- **å‹ç¼©ä¼˜åŒ–**ï¼šæ˜¯å¦éœ€è¦æ–‡ä»¶å‹ç¼©æ¥å‡å°‘ä¼ è¾“æ—¶é—´ï¼Ÿ

---

## âœ… **ç¬¬ä¸‰é˜¶æ®µå®æ–½Checklist**

### **ğŸ”§ æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶æ£€æŸ¥**
- [x] å®‰è£…å’Œé…ç½®Multerä¸­é—´ä»¶
- [x] éªŒè¯æ–‡ä»¶å­˜å‚¨é…ç½®ï¼ˆä¸´æ—¶ç›®å½•ã€æœ€ç»ˆç›®å½•ï¼‰
- [x] æµ‹è¯•æ–‡ä»¶ç±»å‹è¿‡æ»¤å™¨
- [x] éªŒè¯æ–‡ä»¶å¤§å°å’Œæ•°é‡é™åˆ¶
- [x] æµ‹è¯•æ–‡ä»¶å‘½åç­–ç•¥ï¼ˆæ—¶é—´æˆ³-UUID-æ‰©å±•åï¼‰
- [x] éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶

### **ğŸ“ æ–‡ä»¶å¤„ç†å·¥å…·æ£€æŸ¥**
- [x] å®‰è£…Sharpå›¾ç‰‡å¤„ç†åº“
- [x] æµ‹è¯•å›¾ç‰‡ç¼©ç•¥å›¾ç”Ÿæˆ
- [ ] éªŒè¯æ–‡æ¡£æ–‡æœ¬æå–åŠŸèƒ½
- [x] æµ‹è¯•éŸ³é¢‘è§†é¢‘å…ƒæ•°æ®æå–
- [x] éªŒè¯æ–‡ä»¶ç±»å‹æ£€æµ‹å‡†ç¡®æ€§
- [x] æµ‹è¯•æ–‡ä»¶å¤„ç†æ€§èƒ½

### **ğŸŒ APIç«¯ç‚¹å¼€å‘æ£€æŸ¥**
- [x] å®ç°`/api/attachments/upload`ç«¯ç‚¹
- [x] å®ç°`/api/attachments/download/:id`ç«¯ç‚¹
- [x] å®ç°`/api/attachments/thumbnail/:id`ç«¯ç‚¹
- [x] å®ç°`/api/attachments/:id`ä¿¡æ¯æŸ¥è¯¢ç«¯ç‚¹
- [x] å®ç°`/api/attachments/:id`åˆ é™¤ç«¯ç‚¹
- [x] å®ç°æ‰¹é‡åˆ é™¤ç«¯ç‚¹

### **ğŸ”— ä¸ç°æœ‰ç³»ç»Ÿé›†æˆæ£€æŸ¥**
- [âŒ] æµ‹è¯•ä¸ç°æœ‰chatæ¥å£çš„å…¼å®¹æ€§ *(æœªå®ç° - èŠå¤©APIä¸æ”¯æŒé™„ä»¶)*
- [x] éªŒè¯æ–°æ¥å£ä¸å½±å“ç°æœ‰åŠŸèƒ½
- [âŒ] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ å’Œæ¶ˆæ¯å‘é€çš„é›†æˆ *(æœªå®ç° - ä¸¤ä¸ªç‹¬ç«‹API)*
- [x] éªŒè¯ä¼šè¯å’Œæ¶ˆæ¯çš„å…³è”å…³ç³»
- [âŒ] æµ‹è¯•æµå¼æ¥å£çš„é™„ä»¶æ”¯æŒ *(æœªå®ç° - æµå¼APIä¸æ”¯æŒé™„ä»¶)*
- [âŒ] éªŒè¯å¤šæ¨¡æ€è¯·æ±‚çš„æ„å»º *(æœªå®ç° - æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±)*

### **ğŸ§ª åŠŸèƒ½æµ‹è¯•æ£€æŸ¥**
- [x] æµ‹è¯•å„ç§æ–‡ä»¶ç±»å‹çš„ä¸Šä¼ 
- [x] æµ‹è¯•æ–‡ä»¶å¤§å°é™åˆ¶
- [x] æµ‹è¯•æ–‡ä»¶æ•°é‡é™åˆ¶
- [x] æµ‹è¯•æ–‡ä»¶ç±»å‹éªŒè¯
- [x] æµ‹è¯•é”™è¯¯æƒ…å†µå¤„ç†
- [ ] æµ‹è¯•å¹¶å‘ä¸Šä¼ æ€§èƒ½

### **ğŸ“Š æ€§èƒ½æµ‹è¯•æ£€æŸ¥**
- [x] æµ‹è¯•å°æ–‡ä»¶ï¼ˆ<1MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•ä¸­ç­‰æ–‡ä»¶ï¼ˆ1-10MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼‰ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•æ‰¹é‡æ–‡ä»¶ä¸Šä¼ æ€§èƒ½
- [x] æµ‹è¯•æ–‡ä»¶å¤„ç†è€—æ—¶
- [x] æµ‹è¯•å†…å­˜ä½¿ç”¨æƒ…å†µ

### **ğŸ›¡ï¸ å®‰å…¨æ€§æµ‹è¯•æ£€æŸ¥**
- [x] æµ‹è¯•æ¶æ„æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤
- [x] éªŒè¯æ–‡ä»¶ç±»å‹ç™½åå•
- [x] æµ‹è¯•æ–‡ä»¶è·¯å¾„å®‰å…¨
- [x] éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶
- [ ] æµ‹è¯•æƒé™æ§åˆ¶æœºåˆ¶
- [x] éªŒè¯SQLæ³¨å…¥é˜²æŠ¤

### **ğŸ“ æ—¥å¿—å’Œç›‘æ§æ£€æŸ¥**
- [x] éªŒè¯æ–‡ä»¶ä¸Šä¼ æ—¥å¿—è®°å½•
- [x] éªŒè¯é”™è¯¯æ—¥å¿—è®°å½•
- [x] æµ‹è¯•æ€§èƒ½ç›‘æ§æ•°æ®
- [x] éªŒè¯å­˜å‚¨ç©ºé—´ç›‘æ§
- [â­ï¸] æµ‹è¯•å‘Šè­¦æœºåˆ¶ *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*
- [x] éªŒè¯å®¡è®¡æ—¥å¿—

### **ğŸ”„ é”™è¯¯å¤„ç†å’Œå›æ»šæ£€æŸ¥**
- [x] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ å¤±è´¥å¤„ç†
- [x] éªŒè¯ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- [x] æµ‹è¯•æ•°æ®åº“å›æ»šæœºåˆ¶
- [x] éªŒè¯é”™è¯¯ä¿¡æ¯å‡†ç¡®æ€§
- [x] æµ‹è¯•ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- [x] éªŒè¯ç³»ç»Ÿæ¢å¤èƒ½åŠ›

### **ğŸ“š æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥**
- [â­ï¸] æ›´æ–°APIæ–‡æ¡£ *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*
- [â­ï¸] æ·»åŠ æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨è¯´æ˜ *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*
- [â­ï¸] æ·»åŠ é”™è¯¯å¤„ç†æŒ‡å— *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*
- [x] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§
- [â­ï¸] æ·»åŠ æ€§èƒ½ä¼˜åŒ–å»ºè®® *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*
- [â­ï¸] éªŒè¯éƒ¨ç½²è¯´æ˜ *(æš‚ç¼“ - æœ¬åœ°ç¯å¢ƒ)*

### **ğŸ¯ ç¬¬ä¸‰é˜¶æ®µæ€»ç»“**

**âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶é…ç½®ï¼ˆMulterã€æ–‡ä»¶ç±»å‹éªŒè¯ã€å¤§å°é™åˆ¶ï¼‰
- âœ… æ–‡ä»¶å¤„ç†å·¥å…·ï¼ˆSharpå›¾ç‰‡å¤„ç†ã€ç¼©ç•¥å›¾ç”Ÿæˆã€å…ƒæ•°æ®æå–ï¼‰
- âœ… APIç«¯ç‚¹å¼€å‘ï¼ˆä¸Šä¼ ã€ä¸‹è½½ã€æŸ¥è¯¢ã€åˆ é™¤ã€æ‰¹é‡æ“ä½œï¼‰
- âœ… ä¸ç°æœ‰ç³»ç»Ÿé›†æˆï¼ˆæ•°æ®åº“ã€ä¼šè¯ã€æ¶ˆæ¯å…³è”ï¼‰
- âœ… åŠŸèƒ½æµ‹è¯•ï¼ˆå„ç§æ–‡ä»¶ç±»å‹ã€å¤§å°é™åˆ¶ã€é”™è¯¯å¤„ç†ï¼‰
- âœ… æ€§èƒ½æµ‹è¯•ï¼ˆå°ä¸­å¤§æ–‡ä»¶ã€æ‰¹é‡ä¸Šä¼ ã€å¤„ç†è€—æ—¶ï¼‰
- âœ… å®‰å…¨æ€§æµ‹è¯•ï¼ˆæ–‡ä»¶ç±»å‹ç™½åå•ã€è·¯å¾„å®‰å…¨ã€SQLæ³¨å…¥é˜²æŠ¤ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

**â­ï¸ æš‚ç¼“çš„æµ‹è¯•é¡¹ç›®ï¼š**
- æ–‡æ¡£æ–‡æœ¬æå–åŠŸèƒ½ï¼ˆéœ€è¦å®‰è£…pdf-parseã€mammothåº“ï¼‰
- å¤šæ¨¡æ€è¯·æ±‚æ„å»ºéªŒè¯
- å¹¶å‘ä¸Šä¼ æ€§èƒ½æµ‹è¯•
- æƒé™æ§åˆ¶æœºåˆ¶æµ‹è¯•
- å®Œæ•´æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥

**ğŸ“‹ æš‚ç¼“åŸå› ï¼š**
éƒ¨åˆ†æµ‹è¯•é¡¹ç›®ä¸»è¦é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒæˆ–éœ€è¦é¢å¤–ä¾èµ–åº“ã€‚æ ¸å¿ƒåŠŸèƒ½éªŒè¯å·²å®Œæˆï¼Œä¸ºåç»­å¼€å‘æä¾›äº†åšå®çš„åŸºç¡€ã€‚

---

## ğŸš€ **ç»§ç»­å¼€å‘ï¼šå¤šæ¨¡æ€AIé›†æˆæ¨¡å—**

### **éœ€è¦åç»­å¼€å‘æ—¶ç¡®è®¤çš„é—®é¢˜**

#### **1. å­˜å‚¨ç­–ç•¥é…ç½®**
- [ ] æŒ‰æ—¥æœŸç»„ç»‡æ–‡ä»¶çš„ç­–ç•¥æ˜¯å¦åˆé€‚ï¼Ÿï¼ˆå½“å‰ï¼šuploads/attachments/2024/01/15/ï¼‰
- [ ] ç¼©ç•¥å›¾åˆ†å±‚å­˜å‚¨ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿï¼ˆå½“å‰ï¼šuploads/thumbnails/ab/attachmentId.webpï¼‰
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒå…¶ä»–å­˜å‚¨ç­–ç•¥ï¼Ÿï¼ˆå¦‚æŒ‰æ–‡ä»¶ç±»å‹ã€æŒ‰ç”¨æˆ·IDç­‰ï¼‰

#### **2. æ¸…ç†ç­–ç•¥å‚æ•°**
- [ ] ä¸´æ—¶æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼š24å°æ—¶æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] ç¼“å­˜æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼š7å¤©æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] ç¼©ç•¥å›¾ä¿ç•™æ—¶é—´ï¼š30å¤©æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] å½’æ¡£æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼š90å¤©æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] æ¸…ç†é—´éš”ï¼š1å°æ—¶æ˜¯å¦åˆé€‚ï¼Ÿ

#### **3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
- [ ] æ‰¹é‡å¤„ç†å¤§å°ï¼š100ä¸ªæ–‡ä»¶æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] å¹¶è¡Œæ¸…ç†ä»»åŠ¡æ•°é‡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ æ–‡ä»¶å‹ç¼©ç­–ç•¥ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ CDNé›†æˆï¼Ÿ

#### **4. å­˜å‚¨æ‰©å±•æ€§**
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒäº‘å­˜å‚¨ï¼ˆAWS S3ã€é˜¿é‡Œäº‘OSSç­‰ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒæ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒæ–‡ä»¶åŠ å¯†å­˜å‚¨ï¼Ÿ

---

## âš ï¸ **ç¬¬å››é˜¶æ®µé—ç•™é—®é¢˜ä¸æ”¹è¿›å»ºè®®**

### **4.1 å­˜å‚¨ç­–ç•¥é…ç½®é—®é¢˜**

#### **4.1.1 ç¯å¢ƒå˜é‡é…ç½®ä¸å®Œæ•´**
- **é—®é¢˜æè¿°**ï¼šå½“å‰åªé…ç½®äº†åŸºç¡€çš„å­˜å‚¨ç­–ç•¥é€‰æ‹©ï¼Œç¼ºå°‘è¯¦ç»†çš„äº‘å­˜å‚¨é…ç½®
- **å½±å“**ï¼šæ— æ³•é€šè¿‡ç¯å¢ƒå˜é‡å®Œæ•´æ§åˆ¶äº‘å­˜å‚¨è¡Œä¸º
- **å»ºè®®**ï¼šè¡¥å……å®Œæ•´çš„äº‘å­˜å‚¨é…ç½®é¡¹ï¼ŒåŒ…æ‹¬CDNã€åŠ å¯†ã€æƒé™ç­‰

#### **4.1.2 æ··åˆå­˜å‚¨ç­–ç•¥æœªå®ç°**
- **é—®é¢˜æè¿°**ï¼š`hybrid` ç­–ç•¥åœ¨å·¥å‚ä¸­åªæ˜¯ç®€å•å›é€€åˆ°æœ¬åœ°å­˜å‚¨
- **å½±å“**ï¼šæ— æ³•å®ç°çœŸæ­£çš„æ™ºèƒ½æ–‡ä»¶åˆ†é…ç­–ç•¥
- **å»ºè®®**ï¼šå®ç°åŸºäºæ–‡ä»¶å¤§å°ã€ç±»å‹ã€è®¿é—®é¢‘ç‡çš„æ™ºèƒ½åˆ†é…ç®—æ³•

### **4.2 å­˜å‚¨æ¥å£æŠ½è±¡é—®é¢˜**

#### **4.2.1 äº‘å­˜å‚¨å®ç°ç¼ºå¤±**
- **é—®é¢˜æè¿°**ï¼š`S3StorageProvider` åªæ˜¯å ä½ç¬¦ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æŠ›å‡º"æœªå®ç°"é”™è¯¯
- **å½±å“**ï¼šæ— æ³•çœŸæ­£ä½¿ç”¨äº‘å­˜å‚¨åŠŸèƒ½
- **å»ºè®®**ï¼šå®ç°å®Œæ•´çš„S3å­˜å‚¨æ“ä½œï¼ŒåŒ…æ‹¬ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤ã€åˆ—è¡¨ç­‰

#### **4.2.2 é”™è¯¯å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€**
- **é—®é¢˜æè¿°**ï¼šæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨çš„é”™è¯¯å¤„ç†æ–¹å¼ä¸ä¸€è‡´
- **å½±å“**ï¼šä¸šåŠ¡å±‚æ— æ³•ç»Ÿä¸€å¤„ç†å­˜å‚¨é”™è¯¯
- **å»ºè®®**ï¼šå®šä¹‰ç»Ÿä¸€çš„é”™è¯¯ç±»å‹å’Œé”™è¯¯ç ï¼Œå®ç°ä¸€è‡´çš„é”™è¯¯å¤„ç†

### **4.3 æ€§èƒ½ä¼˜åŒ–é—®é¢˜**

#### **4.3.1 æ–‡ä»¶æ“ä½œç¼ºå°‘å¹¶å‘æ§åˆ¶**
- **é—®é¢˜æè¿°**ï¼šå¤§é‡æ–‡ä»¶æ“ä½œæ—¶æ²¡æœ‰å¹¶å‘é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½
- **å½±å“**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹ç³»ç»Ÿæ€§èƒ½ä¸‹é™
- **å»ºè®®**ï¼šå®ç°æ–‡ä»¶æ“ä½œé˜Ÿåˆ—ï¼Œæ·»åŠ å¹¶å‘æ§åˆ¶æœºåˆ¶

#### **4.3.2 ç¼“å­˜ç­–ç•¥ä¸å¤Ÿæ™ºèƒ½**
- **é—®é¢˜æè¿°**ï¼šç¼“å­˜æ¸…ç†ç­–ç•¥è¿‡äºç®€å•ï¼Œæ²¡æœ‰è€ƒè™‘æ–‡ä»¶è®¿é—®é¢‘ç‡
- **å½±å“**ï¼šçƒ­ç‚¹æ–‡ä»¶å¯èƒ½è¢«è¯¯åˆ ï¼Œå†·æ–‡ä»¶å ç”¨ç¼“å­˜ç©ºé—´
- **å»ºè®®**ï¼šå®ç°åŸºäºLRUçš„æ™ºèƒ½ç¼“å­˜ç­–ç•¥

### **4.4 å®‰å…¨ä¸æƒé™é—®é¢˜**

#### **4.4.1 æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶ç¼ºå¤±**
- **é—®é¢˜æè¿°**ï¼šæ²¡æœ‰æ–‡ä»¶çº§åˆ«çš„æƒé™æ§åˆ¶ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä»»ä½•æ–‡ä»¶
- **å½±å“**ï¼šå­˜åœ¨æ–‡ä»¶æ³„éœ²é£é™©
- **å»ºè®®**ï¼šå®ç°åŸºäºç”¨æˆ·ã€è§’è‰²ã€ä¼šè¯çš„æ–‡ä»¶æƒé™æ§åˆ¶

#### **4.4.2 æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥ä¸è¶³**
- **é—®é¢˜æè¿°**ï¼šç¼ºå°‘æ–‡ä»¶å†…å®¹çš„å®‰å…¨æ£€æŸ¥ï¼Œå¦‚ç—…æ¯’æ‰«æã€æ¶æ„ä»£ç æ£€æµ‹
- **å½±å“**ï¼šå¯èƒ½ä¸Šä¼ æ¶æ„æ–‡ä»¶
- **å»ºè®®**ï¼šé›†æˆæ–‡ä»¶å®‰å…¨æ£€æŸ¥æœåŠ¡ï¼Œå®ç°ä¸Šä¼ å‰çš„å®‰å…¨éªŒè¯

### **4.5 ç›‘æ§ä¸è¿ç»´é—®é¢˜**

#### **4.5.1 å­˜å‚¨æ“ä½œç¼ºå°‘è¯¦ç»†æ—¥å¿—**
- **é—®é¢˜æè¿°**ï¼šåªæœ‰ç®€å•çš„console.logï¼Œç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—å’Œç›‘æ§æŒ‡æ ‡
- **å½±å“**ï¼šæ— æ³•è¿›è¡Œæ€§èƒ½åˆ†æå’Œé—®é¢˜æ’æŸ¥
- **å»ºè®®**ï¼šå®ç°ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿï¼Œæ·»åŠ å…³é”®æŒ‡æ ‡ç›‘æ§

#### **4.5.2 å­˜å‚¨å®¹é‡ç›‘æ§ç¼ºå¤±**
- **é—®é¢˜æè¿°**ï¼šæ²¡æœ‰å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µçš„ç›‘æ§å’Œå‘Šè­¦
- **å½±å“**ï¼šå­˜å‚¨ç©ºé—´è€—å°½æ—¶æ— æ³•åŠæ—¶å‘ç°
- **å»ºè®®**ï¼šå®ç°å­˜å‚¨å®¹é‡ç›‘æ§ï¼Œè®¾ç½®å‘Šè­¦é˜ˆå€¼

---

## ğŸ“‹ **ç¬¬å››é˜¶æ®µå®æ–½Checklist**

### **1. å­˜å‚¨ç­–ç•¥é…ç½® (5é¡¹)**
- [ ] å®Œå–„äº‘å­˜å‚¨ç¯å¢ƒå˜é‡é…ç½®
- [ ] å®ç°æ··åˆå­˜å‚¨ç­–ç•¥ç®—æ³•
- [ ] æ·»åŠ å­˜å‚¨ç­–ç•¥éªŒè¯é€»è¾‘
- [ ] å®ç°å­˜å‚¨ç­–ç•¥çƒ­åˆ‡æ¢åŠŸèƒ½
- [ ] æ·»åŠ å­˜å‚¨ç­–ç•¥é…ç½®æ–‡æ¡£

### **2. å­˜å‚¨æ¥å£å®ç° (8é¡¹)**
- [ ] å®ç°S3StorageProviderå®Œæ•´åŠŸèƒ½
- [ ] å®ç°HybridStorageProvideræ··åˆç­–ç•¥
- [ ] ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œé”™è¯¯ç å®šä¹‰
- [ ] å®ç°å­˜å‚¨æ“ä½œçš„å¹‚ç­‰æ€§
- [ ] æ·»åŠ å­˜å‚¨æ“ä½œçš„è¶…æ—¶æ§åˆ¶
- [ ] å®ç°å­˜å‚¨æ“ä½œçš„é‡è¯•æœºåˆ¶
- [ ] æ·»åŠ å­˜å‚¨æ“ä½œçš„æ€§èƒ½ç›‘æ§
- [ ] å®ç°å­˜å‚¨æ“ä½œçš„æ‰¹é‡å¤„ç†

### **3. æ€§èƒ½ä¼˜åŒ– (6é¡¹)**
- [ ] å®ç°æ–‡ä»¶æ“ä½œå¹¶å‘æ§åˆ¶
- [ ] ä¼˜åŒ–æ–‡ä»¶æ‰«æç®—æ³•
- [ ] å®ç°æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- [ ] æ·»åŠ æ–‡ä»¶æ“ä½œé˜Ÿåˆ—
- [ ] å®ç°å¼‚æ­¥æ–‡ä»¶å¤„ç†
- [ ] ä¼˜åŒ–å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½

### **4. å®‰å…¨ä¸æƒé™ (7é¡¹)**
- [ ] å®ç°æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶
- [ ] æ·»åŠ æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥
- [ ] å®ç°æ–‡ä»¶å†…å®¹åŠ å¯†å­˜å‚¨
- [ ] æ·»åŠ æ–‡ä»¶è®¿é—®å®¡è®¡æ—¥å¿—
- [ ] å®ç°æ–‡ä»¶åˆ†äº«é“¾æ¥æœºåˆ¶
- [ ] æ·»åŠ æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶
- [ ] å®ç°æ–‡ä»¶åˆ é™¤ç¡®è®¤æœºåˆ¶

### **5. ç›‘æ§ä¸è¿ç»´ (6é¡¹)**
- [ ] å®ç°ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
- [ ] æ·»åŠ å…³é”®æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- [ ] å®ç°å­˜å‚¨å®¹é‡ç›‘æ§å‘Šè­¦
- [ ] æ·»åŠ å­˜å‚¨æ“ä½œç»Ÿè®¡æŠ¥è¡¨
- [ ] å®ç°å­˜å‚¨å¥åº·æ£€æŸ¥æ¥å£
- [ ] æ·»åŠ å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯•

### **6. æµ‹è¯•ä¸éªŒè¯ (5é¡¹)**
- [ ] ç¼–å†™å­˜å‚¨æ¥å£å•å…ƒæµ‹è¯•
- [ ] å®ç°å­˜å‚¨ç­–ç•¥é›†æˆæµ‹è¯•
- [ ] æ·»åŠ æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] å®ç°æ•…éšœæ¢å¤æµ‹è¯•
- [ ] æ·»åŠ å®‰å…¨æ¸—é€æµ‹è¯•

### **7. æ–‡æ¡£ä¸é…ç½® (4é¡¹)**
- [ ] ç¼–å†™å­˜å‚¨ç­–ç•¥é…ç½®æ–‡æ¡£
- [ ] æ·»åŠ å­˜å‚¨æ“ä½œAPIæ–‡æ¡£
- [ ] å®ç°å­˜å‚¨é…ç½®ç®¡ç†ç•Œé¢
- [ ] ç¼–å†™å­˜å‚¨æ•…éšœæ’æŸ¥æŒ‡å—

### **8. éƒ¨ç½²ä¸è¿ç§» (5é¡¹)**
- [ ] å‡†å¤‡äº‘å­˜å‚¨ç¯å¢ƒé…ç½®
- [ ] å®ç°æ•°æ®è¿ç§»è„šæœ¬
- [ ] æ·»åŠ å­˜å‚¨ç­–ç•¥åˆ‡æ¢è„šæœ¬
- [ ] å®ç°å­˜å‚¨æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] æ·»åŠ å­˜å‚¨æœåŠ¡é™çº§æ–¹æ¡ˆ

---

## ğŸš€ **ç»§ç»­å¼€å‘ï¼šå¤šæ¨¡æ€AIé›†æˆæ¨¡å—**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘å¤šæ¨¡æ€AIé›†æˆåŠŸèƒ½ã€‚

---

## ğŸ¤– **ç¬¬äº”é˜¶æ®µï¼šå¤šæ¨¡æ€AIé›†æˆ**

> **âš ï¸ ä¿®æ­£è¯´æ˜**ï¼šåŸºäºäº§å“ç»ç†åé¦ˆï¼Œæœ¬é˜¶æ®µå·²ç®€åŒ–ä¸ºä¸“æ³¨äºæ ¸å¿ƒå¤šæ¨¡æ€åŠŸèƒ½ï¼Œç§»é™¤äº†è¿‡åº¦å¤æ‚çš„æŠ½è±¡è®¾è®¡ã€‚
> 
> **ğŸ“‹ æŠ€æœ¯æ–¹æ¡ˆæ›´æ–°**ï¼šåŸºäºGemini APIæ–‡æ¡£ï¼Œé‡‡ç”¨base64ç¼–ç æ–¹å¼ç›´æ¥ä¸Šä¼ æ–‡ä»¶ç»™AIæ¨¡å‹å¤„ç†ï¼Œæ— éœ€æœ¬åœ°æ–‡ä»¶å†…å®¹æå–ã€‚

### **ğŸ“š å‚è€ƒæ–‡æ¡£**
- [Geminiæ–‡æ¡£ç†è§£API](https://ai.google.dev/gemini-api/docs/document-processing?hl=zh-cn) - æ”¯æŒPDFã€TXTã€Markdownã€HTMLã€XMLç­‰æ ¼å¼
- [Geminiå›¾ç‰‡ç†è§£API](https://ai.google.dev/gemini-api/docs/image-understanding?hl=zh-cn) - æ”¯æŒå„ç§å›¾ç‰‡æ ¼å¼çš„è§†è§‰ç†è§£

### **ğŸ”§ å®ç°ç­–ç•¥**
- **å°æ–‡ä»¶ï¼ˆ<20MBï¼‰**: ç›´æ¥base64ç¼–ç å†…åµŒåˆ°è¯·æ±‚ä¸­
- **å¤§æ–‡ä»¶ï¼ˆ>20MBï¼‰**: ä½¿ç”¨Gemini File APIä¸Šä¼ åå¼•ç”¨
- **æ”¯æŒæ ¼å¼**: PDFã€å›¾ç‰‡ã€æ–‡æœ¬æ–‡ä»¶ç­‰æ‰€æœ‰AIæ¨¡å‹æ”¯æŒçš„æ ¼å¼

### **5.1 å¤šæ¨¡æ€è¯·æ±‚æ„å»ºå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰**

#### **5.1.1 é€šç”¨å¤šæ¨¡æ€è¯·æ±‚æ„å»ºå™¨**
```javascript
// å¤šæ¨¡æ€è¯·æ±‚æ„å»ºå™¨
class MultimodalRequestBuilder {
  constructor() {
    this.supportedModels = {
      gemini: ['gemini-2.5-pro', 'gemini-2.5-flash', 'gemini-2.5-flash-lite'],
      gpt: ['gpt-4o', 'gpt-4o-mini'],
      claude: ['claude-opus-4-1-20250805', 'claude-sonnet-4-1-20250805']
    };
  }
  
  /**
   * æ„å»ºå¤šæ¨¡æ€è¯·æ±‚
   */
  async buildMultimodalRequest(modelType, modelVariant, message, attachments) {
    try {
      console.log(`ğŸ”§ æ„å»ºå¤šæ¨¡æ€è¯·æ±‚: ${modelType} - ${modelVariant}`);
      
      // éªŒè¯æ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€
      if (!this.isMultimodalSupported(modelType, modelVariant)) {
        throw new Error(`æ¨¡å‹ ${modelVariant} ä¸æ”¯æŒå¤šæ¨¡æ€è¾“å…¥`);
      }
      
      // æ ¹æ®æ¨¡å‹ç±»å‹æ„å»ºä¸åŒçš„è¯·æ±‚æ ¼å¼
      switch (modelType) {
        case 'gemini':
          return await this.buildGeminiRequest(modelVariant, message, attachments);
        case 'gpt':
          return await this.buildGPTRequest(modelVariant, message, attachments);
        case 'claude':
          return await this.buildClaudeRequest(modelVariant, message, attachments);
        default:
          throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹: ${modelType}`);
      }
      
    } catch (error) {
      console.error('æ„å»ºå¤šæ¨¡æ€è¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€
   */
  isMultimodalSupported(modelType, modelVariant) {
    const supportedVariants = this.supportedModels[modelType] || [];
    return supportedVariants.includes(modelVariant);
  }
  
  /**
   * æ„å»ºGeminiå¤šæ¨¡æ€è¯·æ±‚
   */
  async buildGeminiRequest(modelVariant, message, attachments) {
    try {
      const parts = [{ text: message }];
      
      // å¤„ç†é™„ä»¶
      if (attachments && attachments.length > 0) {
        for (const attachment of attachments) {
          const attachmentPart = await this.buildGeminiAttachmentPart(attachment);
          if (attachmentPart) {
            parts.push(attachmentPart);
          }
        }
      }
      
      const request = {
        contents: [{
          role: 'user',
          parts: parts
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 2048,
          topP: 0.8,
          topK: 40
        }
      };
      
      console.log(`âœ… Geminiå¤šæ¨¡æ€è¯·æ±‚æ„å»ºå®Œæˆ: ${parts.length} ä¸ªéƒ¨åˆ†`);
      return request;
      
    } catch (error) {
      console.error('æ„å»ºGeminiè¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ„å»ºGeminié™„ä»¶éƒ¨åˆ†
   * åŸºäºGemini APIæ–‡æ¡£ï¼šhttps://ai.google.dev/gemini-api/docs/document-processing?hl=zh-cn
   */
  async buildGeminiAttachmentPart(attachment) {
    try {
      const { fileType, filePath, mimeType, fileSize } = attachment;
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ20MBæ˜¯Geminiå†…åµŒæ–‡ä»¶çš„é™åˆ¶ï¼‰
      const maxInlineSize = 20 * 1024 * 1024; // 20MB
      
      if (fileSize && fileSize < maxInlineSize) {
        // å°æ–‡ä»¶ï¼ˆ< 20MBï¼‰ï¼šä½¿ç”¨å†…åµŒBase64ï¼ˆå®˜æ–¹æ¨èï¼‰
        console.log(`ğŸ“ å°æ–‡ä»¶ä½¿ç”¨å†…åµŒæ–¹å¼: ${(fileSize / 1024 / 1024).toFixed(2)}MB, ç±»å‹: ${fileType}`);
        const base64Data = await this.fileToBase64(filePath);
        return {
          inlineData: {
            mimeType: mimeType,
            data: base64Data
          }
        };
      } else {
        // å¤§æ–‡ä»¶ï¼ˆ>= 20MBï¼‰ï¼šä½¿ç”¨Gemini File API
        console.log(`ğŸ“ å¤§æ–‡ä»¶ä½¿ç”¨File API: ${(fileSize / 1024 / 1024).toFixed(2)}MB, ç±»å‹: ${fileType}`);
        const fileUri = await this.uploadToGeminiFileAPI(filePath, mimeType);
        return {
          fileData: {
            mimeType: mimeType,
            fileUri: fileUri
          }
        };
      }
      
    } catch (error) {
      console.error('æ„å»ºGeminié™„ä»¶éƒ¨åˆ†å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ç¼–ç 
   */
  async fileToBase64(filePath) {
    try {
      const fs = require('fs');
      const fileBuffer = fs.readFileSync(filePath);
      return fileBuffer.toString('base64');
    } catch (error) {
      console.error('æ–‡ä»¶è½¬Base64å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * ä¸Šä¼ æ–‡ä»¶åˆ°Gemini File APIï¼ˆå¤§æ–‡ä»¶å¤„ç†ï¼‰
   */
  async uploadToGeminiFileAPI(filePath, mimeType) {
    try {
      // TODO: å®ç°Gemini File APIä¸Šä¼ é€»è¾‘
      // å‚è€ƒï¼šhttps://ai.google.dev/gemini-api/docs/document-processing?hl=zh-cn
      console.log('ğŸ“ ä½¿ç”¨Gemini File APIä¸Šä¼ å¤§æ–‡ä»¶');
      
      // ä¸´æ—¶å®ç°ï¼šæŠ›å‡ºé”™è¯¯æç¤º
      throw new Error('Gemini File APIä¸Šä¼ åŠŸèƒ½å¾…å®ç°ï¼Œå½“å‰ä»…æ”¯æŒ<20MBæ–‡ä»¶');
      
    } catch (error) {
      console.error('Gemini File APIä¸Šä¼ å¤±è´¥:', error);
      throw error;
              }
            };
          } else {
              // æœ€åå›é€€ï¼šè¿”å›å›¾ç‰‡æè¿°
              return { text: `\n[å›¾ç‰‡é™„ä»¶: ${attachment.originalName} - å¤§å°: ${(fileSize / 1024 / 1024).toFixed(2)}MB]\n` };
            }
          }
        }
      } else if (fileType === 'document') {
        // æ ¹æ®Geminiå®˜æ–¹æ–‡æ¡£å»ºè®®ï¼Œæ™ºèƒ½é€‰æ‹©æ–‡æ¡£å¤„ç†ç­–ç•¥
        // å‚è€ƒï¼šhttps://ai.google.dev/gemini-api/docs/document-processing?hl=zh-cn
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ20MBæ˜¯Geminiå†…åµŒæ–‡æ¡£çš„é™åˆ¶ï¼‰
        const maxInlineSize = 20 * 1024 * 1024; // 20MB
        
        if (mimeType === 'application/pdf') {
          // PDFæ–‡æ¡£ï¼šä¼˜å…ˆä½¿ç”¨GeminiåŸç”Ÿæ”¯æŒ
          if (fileSize && fileSize < maxInlineSize) {
            // å°PDFï¼ˆ< 20MBï¼‰ï¼šä½¿ç”¨å†…åµŒæ–¹å¼ï¼ˆä¿æŒè§†è§‰ç†è§£èƒ½åŠ›ï¼‰
            console.log(`ğŸ“„ å°PDFä½¿ç”¨å†…åµŒæ–¹å¼: ${(fileSize / 1024 / 1024).toFixed(2)}MB`);
            const base64Data = await this.fileToBase64(filePath);
            return {
              inlineData: {
                mimeType: mimeType,
                data: base64Data
              }
            };
          } else {
            // å¤§PDFï¼ˆ>= 20MBï¼‰ï¼šå½“å‰ç­–ç•¥ä¸ºæ–‡æœ¬æå–æˆ–å‹ç¼©åBase64å†…åµŒ
            console.warn(`ğŸ“„ å¤§PDFæ–‡ä»¶: ${(fileSize / 1024 / 1024).toFixed(2)}MBï¼Œå°è¯•æ–‡æœ¬æå–æˆ–å‹ç¼©å¤„ç†`);
            
            // âš ï¸ ç¬¬äºŒé˜¶æ®µè®¡åˆ’ï¼šä½¿ç”¨Gemini File APIå¤„ç†å¤§æ–‡ä»¶
            // TODO: å®ç° uploadToGeminiFileAPI() æ–¹æ³•
            
            // å½“å‰å®ç°ï¼šå°è¯•å‹ç¼©PDFåå†…åµŒ
            const compressedPdfPath = await this.compressPdfForInline(filePath);
            if (compressedPdfPath) {
              const base64Data = await this.fileToBase64(compressedPdfPath);
              return {
                inlineData: {
                  mimeType: mimeType,
                  data: base64Data
                }
              };
            } else {
                // æœ€åå›é€€ï¼šæå–æ–‡æœ¬å†…å®¹
                console.log(`ğŸ“„ PDFå‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨æ–‡æœ¬æå–æ–¹å¼`);
                const textContent = await this.extractDocumentText(filePath, mimeType);
                return { text: `\n[PDFæ–‡æ¡£å†…å®¹]\n${textContent}\n[/PDFæ–‡æ¡£å†…å®¹]\n` };
              }
            }
          }
        } else {
          // éPDFæ–‡æ¡£ï¼šç»§ç»­ä½¿ç”¨æ–‡æœ¬æå–ï¼ˆGeminiåªå¯¹PDFæœ‰è§†è§‰ç†è§£èƒ½åŠ›ï¼‰
          console.log(`ğŸ“„ éPDFæ–‡æ¡£ä½¿ç”¨æ–‡æœ¬æå–: ${mimeType}`);
          const textContent = await this.extractDocumentText(filePath, mimeType);
          return { text: `\n[æ–‡æ¡£å†…å®¹]\n${textContent}\n[/æ–‡æ¡£å†…å®¹]\n` };
        }
      } else {
        // å…¶ä»–ç±»å‹ï¼šä½œä¸ºæ–‡æœ¬æè¿°
        return { text: `\n[é™„ä»¶: ${attachment.originalName} - ${fileType}]\n` };
      }
      
    } catch (error) {
      console.error('æ„å»ºGeminié™„ä»¶éƒ¨åˆ†å¤±è´¥:', error);
      // è¿”å›é”™è¯¯æè¿°ï¼Œä¸ä¸­æ–­æ•´ä¸ªè¯·æ±‚
      return { text: `\n[é™„ä»¶å¤„ç†å¤±è´¥: ${attachment.originalName}]\n` };
    }
  }
  
  /**
   * æ„å»ºGPTå¤šæ¨¡æ€è¯·æ±‚
   */
  async buildGPTRequest(modelVariant, message, attachments) {
    try {
      const messages = [{
        role: 'user',
        content: []
      }];
      
      // æ·»åŠ æ–‡æœ¬æ¶ˆæ¯
      if (message) {
        messages[0].content.push({
          type: 'text',
          text: message
        });
      }
      
      // å¤„ç†é™„ä»¶
      if (attachments && attachments.length > 0) {
        for (const attachment of attachments) {
          const attachmentContent = await this.buildGPTAttachmentContent(attachment);
          if (attachmentContent) {
            messages[0].content.push(attachmentContent);
          }
        }
      }
      
      const request = {
        model: modelVariant,
        messages: messages,
        temperature: 0.7,
        max_tokens: 2048,
        stream: false
      };
      
      console.log(`âœ… GPTå¤šæ¨¡æ€è¯·æ±‚æ„å»ºå®Œæˆ: ${messages[0].content.length} ä¸ªå†…å®¹é¡¹`);
      return request;
      
    } catch (error) {
      console.error('æ„å»ºGPTè¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æ„å»ºGPTé™„ä»¶å†…å®¹
   */
  async buildGPTAttachmentContent(attachment) {
    try {
      const { fileType, filePath, mimeType } = attachment;
      
      if (fileType === 'image') {
        // å›¾ç‰‡æ–‡ä»¶ï¼šè½¬æ¢ä¸ºbase64 URLï¼ˆOpenAI GPT-4oæ ‡å‡†æ ¼å¼ï¼‰
        // âš ï¸ å½“å‰ç­–ç•¥ï¼šä½¿ç”¨Base64å†…åµŒæ–¹å¼ï¼ˆç®€åŒ–å®ç°ï¼‰
        const base64Data = await this.fileToBase64(filePath);
        return {
          type: 'image_url',
          image_url: {
            url: `data:${mimeType};base64,${base64Data}`,
            detail: 'high' // æˆ– 'low', 'auto'
          }
        };
      } else if (fileType === 'document') {
        // æ–‡æ¡£æ–‡ä»¶ï¼šæå–æ–‡æœ¬å†…å®¹
        const textContent = await this.extractDocumentText(filePath, mimeType);
        return {
          type: 'text',
          text: `\n[æ–‡æ¡£å†…å®¹]\n${textContent}\n[/æ–‡æ¡£å†…å®¹]\n`
        };
      } else {
        // å…¶ä»–ç±»å‹ï¼šä½œä¸ºæ–‡æœ¬æè¿°
        return {
          type: 'text',
          text: `\n[é™„ä»¶: ${attachment.originalName} - ${fileType}]\n`
        };
      }
      
    } catch (error) {
      console.error('æ„å»ºGPTé™„ä»¶å†…å®¹å¤±è´¥:', error);
      return {
        type: 'text',
        text: `\n[é™„ä»¶å¤„ç†å¤±è´¥: ${attachment.originalName}]\n`
      };
    }
  }
  
  /**
   * æ„å»ºClaudeå¤šæ¨¡æ€è¯·æ±‚ï¼ˆé¢„ç•™ï¼‰
   */
  async buildClaudeRequest(modelVariant, message, attachments) {
    // Claudeå¤šæ¨¡æ€æ”¯æŒé¢„ç•™
    console.log('âš ï¸ Claudeå¤šæ¨¡æ€æ”¯æŒæ­£åœ¨å¼€å‘ä¸­');
    
    // ä¸´æ—¶è¿”å›æ–‡æœ¬æ ¼å¼
    let fullMessage = message || '';
    
    if (attachments && attachments.length > 0) {
      fullMessage += '\n\n[é™„ä»¶åˆ—è¡¨]\n';
      attachments.forEach(attachment => {
        fullMessage += `- ${attachment.originalName} (${attachment.fileType})\n`;
      });
      fullMessage += '\n[æ³¨æ„ï¼šClaudeå¤šæ¨¡æ€æ”¯æŒæ­£åœ¨å¼€å‘ä¸­ï¼Œé™„ä»¶å†…å®¹å°†ä»¥æ–‡æœ¬å½¢å¼æè¿°]';
    }
    
    return {
      model: modelVariant,
      messages: [{
        role: 'user',
        content: fullMessage
      }],
      max_tokens: 2048,
      temperature: 0.7
    };
  }
  
  /**
   * æ–‡ä»¶è½¬base64
   */
  async fileToBase64(filePath) {
    try {
      const fileBuffer = await fs.readFile(filePath);
      return fileBuffer.toString('base64');
    } catch (error) {
      console.error('æ–‡ä»¶è½¬base64å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * æå–æ–‡æ¡£æ–‡æœ¬å†…å®¹
   */
  async extractDocumentText(filePath, mimeType) {
    try {
      // æ ¹æ®MIMEç±»å‹é€‰æ‹©ä¸åŒçš„æå–æ–¹æ³•
      if (mimeType === 'text/plain' || mimeType === 'text/markdown') {
        // çº¯æ–‡æœ¬æ–‡ä»¶
        return await fs.readFile(filePath, 'utf-8');
      } else if (mimeType === 'application/pdf') {
        // PDFæ–‡ä»¶ï¼šä½¿ç”¨pdf-parseåº“
        return await this.extractPDFText(filePath);
      } else if (mimeType.includes('word') || mimeType.includes('document')) {
        // Wordæ–‡æ¡£ï¼šä½¿ç”¨mammothåº“
        return await this.extractWordText(filePath);
      } else {
        // å…¶ä»–ç±»å‹ï¼šè¿”å›æ–‡ä»¶ä¿¡æ¯
        const stats = await fs.stat(filePath);
        return `[æ–‡æ¡£æ–‡ä»¶: ${path.basename(filePath)}, å¤§å°: ${(stats.size / 1024).toFixed(2)}KB]`;
      }
    } catch (error) {
      console.error('æå–æ–‡æ¡£æ–‡æœ¬å¤±è´¥:', error);
      return `[æ–‡æ¡£å†…å®¹æå–å¤±è´¥: ${error.message}]`;
    }
  }
  
  /**
   * æå–PDFæ–‡æœ¬ï¼ˆéœ€è¦å®‰è£…pdf-parseåº“ï¼‰
   */
  async extractPDFText(filePath) {
    try {
      // éœ€è¦å®‰è£… pdf-parse åº“ï¼ˆå¯é€‰ä¾èµ–ï¼‰
      // npm install pdf-parse@1.1.1
      const pdfParse = require('pdf-parse');  // v1.1.1
      const dataBuffer = await fs.readFile(filePath);
      const data = await pdfParse(dataBuffer);
      return data.text;
    } catch (error) {
      console.error('PDFæ–‡æœ¬æå–å¤±è´¥:', error);
      return '[PDFæ–‡æœ¬æå–å¤±è´¥]';
    }
  }
  
  /**
   * æå–Wordæ–‡æ¡£æ–‡æœ¬ï¼ˆéœ€è¦å®‰è£…mammothåº“ï¼‰
   */
  async extractWordText(filePath) {
    try {
      // éœ€è¦å®‰è£… mammoth åº“ï¼ˆå¯é€‰ä¾èµ–ï¼‰
      // npm install mammoth@1.6.0
      const mammoth = require('mammoth');  // v1.6.0
      const result = await mammoth.extractRawText({ path: filePath });
      return result.value;
    } catch (error) {
      console.error('Wordæ–‡æ¡£æ–‡æœ¬æå–å¤±è´¥:', error);
      return '[Wordæ–‡æ¡£æ–‡æœ¬æå–å¤±è´¥]';
    }
  }
}

module.exports = MultimodalRequestBuilder;
```

### **5.2 å¤šæ¨¡æ€AIè°ƒç”¨å™¨**

#### **5.2.1 ç»Ÿä¸€çš„å¤šæ¨¡æ€AIè°ƒç”¨å™¨**
```javascript
// å¤šæ¨¡æ€AIè°ƒç”¨å™¨
class MultimodalAICaller {
  constructor() {
    this.requestBuilder = new MultimodalRequestBuilder();
    this.modelConfigs = {
      gemini: {
        baseUrl: process.env.VERCEL_PROXY_URL || 'https://www.connectmulti.cc/api/proxy',
        timeout: 180000 // 3åˆ†é’Ÿ
      },
      gpt: {
        baseUrl: process.env.VERCEL_PROXY_URL || 'https://www.connectmulti.cc/api/proxy',
        timeout: 180000
      },
      claude: {
        baseUrl: process.env.VERCEL_PROXY_URL || 'https://www.connectmulti.cc/api/proxy',
        timeout: 180000
      }
    };
  }
  
  /**
   * è°ƒç”¨å¤šæ¨¡æ€AI
   */
  async callMultimodalAI(modelType, modelVariant, message, attachments, options = {}) {
    try {
      console.log(`ğŸ¤– å¼€å§‹è°ƒç”¨å¤šæ¨¡æ€AI: ${modelType} - ${modelVariant}`);
      console.log(`ğŸ“ é™„ä»¶æ•°é‡: ${attachments ? attachments.length : 0}`);
      
      // æ„å»ºè¯·æ±‚
      const request = await this.requestBuilder.buildMultimodalRequest(
        modelType, 
        modelVariant, 
        message, 
        attachments
      );
      
      // è°ƒç”¨å¯¹åº”çš„AI API
      let response;
      switch (modelType) {
        case 'gemini':
          response = await this.callGeminiAPI(modelVariant, request, options);
          break;
        case 'gpt':
          response = await this.callGPTAPI(modelVariant, request, options);
          break;
        case 'claude':
          response = await this.callClaudeAPI(modelVariant, request, options);
          break;
        default:
          throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹: ${modelType}`);
      }
      
      console.log(`âœ… å¤šæ¨¡æ€AIè°ƒç”¨æˆåŠŸ: ${modelVariant}`);
      return response;
      
    } catch (error) {
      console.error('å¤šæ¨¡æ€AIè°ƒç”¨å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è°ƒç”¨Gemini API
   */
  async callGeminiAPI(modelVariant, request, options) {
    try {
      const config = this.modelConfigs.gemini;
      const modelPath = this.getGeminiModelPath(modelVariant);
      const url = `${config.baseUrl}?path=${encodeURIComponent(modelPath)}`;
      
      console.log(`ğŸ”— Gemini APIè°ƒç”¨: ${url}`);
      
      const fetch = require('node-fetch');
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(request),
        signal: AbortSignal.timeout(config.timeout)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Gemini APIé”™è¯¯: ${errorData.error?.message || response.statusText}`);
      }
      
      const data = await response.json();
      return this.parseGeminiResponse(data);
      
    } catch (error) {
      console.error('Gemini APIè°ƒç”¨å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è°ƒç”¨GPT API
   */
  async callGPTAPI(modelVariant, request, options) {
    try {
      const config = this.modelConfigs.gpt;
      const url = `${config.baseUrl}?provider=openai&path=chat/completions`;
      
      console.log(`ğŸ”— GPT APIè°ƒç”¨: ${url}`);
      
      const fetch = require('node-fetch');
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(request),
        signal: AbortSignal.timeout(config.timeout)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GPT APIé”™è¯¯: ${errorData.error?.message || response.statusText}`);
      }
      
      const data = await response.json();
      return this.parseGPTResponse(data);
      
    } catch (error) {
      console.error('GPT APIè°ƒç”¨å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è°ƒç”¨Claude APIï¼ˆé¢„ç•™ï¼‰
   */
  async callClaudeAPI(modelVariant, request, options) {
    try {
      const config = this.modelConfigs.claude;
      const url = `${config.baseUrl}?provider=anthropic&path=claude`;
      
      console.log(`ğŸ”— Claude APIè°ƒç”¨: ${url}`);
      
      // Claude APIè°ƒç”¨é€»è¾‘é¢„ç•™
      console.log('âš ï¸ Claude APIè°ƒç”¨åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
      
      // ä¸´æ—¶è¿”å›æ¨¡æ‹Ÿå“åº”
      return {
        content: 'Claudeå¤šæ¨¡æ€æ”¯æŒæ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·ç¨åå†è¯•ã€‚',
        model: modelVariant,
        usage: { total_tokens: 0 }
      };
      
    } catch (error) {
      console.error('Claude APIè°ƒç”¨å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è·å–Geminiæ¨¡å‹è·¯å¾„
   */
  getGeminiModelPath(modelVariant) {
    const modelPaths = {
      'gemini-2.5-pro': 'v1beta/models/gemini-2.5-pro:generateContent',
      'gemini-2.5-flash': 'v1beta/models/gemini-2.5-flash:generateContent',
      'gemini-2.5-flash-lite': 'v1beta/models/gemini-2.5-flash-lite:generateContent',
      'gemini-2.0-flash': 'v1beta/models/gemini-2.0-flash:generateContent',
      'gemini-1.5-pro': 'v1beta/models/gemini-1.5-pro:generateContent'
    };
    
    return modelPaths[modelVariant] || 'v1beta/models/gemini-2.5-flash:generateContent';
  }
  
  /**
   * è§£æGeminiå“åº”
   */
  parseGeminiResponse(data) {
    try {
      const candidates = data.candidates?.[0];
      if (!candidates || !candidates.content) {
        throw new Error('Geminiå“åº”æ ¼å¼æ— æ•ˆ');
      }
      
      const text = candidates.content.parts?.[0]?.text || '';
      if (!text) {
        throw new Error('Geminiå“åº”ä¸­æ²¡æœ‰æ–‡æœ¬å†…å®¹');
      }
      
      return {
        content: text,
        model: 'gemini',
        usage: data.usageMetadata || {},
        finishReason: candidates.finishReason
      };
      
    } catch (error) {
      console.error('è§£æGeminiå“åº”å¤±è´¥:', error);
      throw error;
    }
  }
  
  /**
   * è§£æGPTå“åº”
   */
  parseGPTResponse(data) {
    try {
      const choice = data.choices?.[0];
      if (!choice || !choice.message) {
        throw new Error('GPTå“åº”æ ¼å¼æ— æ•ˆ');
      }
      
      const text = choice.message.content || '';
      if (!text) {
        throw new Error('GPTå“åº”ä¸­æ²¡æœ‰æ–‡æœ¬å†…å®¹');
      }
      
      return {
        content: text,
        model: 'gpt',
        usage: data.usage || {},
        finishReason: choice.finish_reason
      };
      
    } catch (error) {
      console.error('è§£æGPTå“åº”å¤±è´¥:', error);
      throw error;
    }
  }
}

module.exports = MultimodalAICaller;
```

---

## âš ï¸ **å¤šæ¨¡æ€AIé›†æˆæ¨¡å—å¾…ç¡®è®¤äº‹é¡¹**

### **éœ€è¦åç»­å¼€å‘æ—¶ç¡®è®¤çš„é—®é¢˜**

#### **1. æ¨¡å‹æ”¯æŒé…ç½®**
- [ ] æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨æ˜¯å¦å®Œæ•´ï¼Ÿï¼ˆå½“å‰ï¼šGemini 2.5ç³»åˆ—ã€GPT-4oç³»åˆ—ã€Claudeç³»åˆ—ï¼‰
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒå…¶ä»–AIæ¨¡å‹ï¼Ÿï¼ˆå¦‚å›½å†…æ¨¡å‹ã€å¼€æºæ¨¡å‹ç­‰ï¼‰
- [ ] æ¨¡å‹ç‰ˆæœ¬æ›´æ–°ç­–ç•¥å¦‚ä½•åˆ¶å®šï¼Ÿ

#### **2. é™„ä»¶å¤„ç†ç­–ç•¥**
- [ ] å›¾ç‰‡æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦åˆç†ï¼Ÿï¼ˆå½“å‰ï¼šæ— æ˜ç¡®é™åˆ¶ï¼‰
- [ ] æ–‡æ¡£æ–‡ä»¶ç±»å‹æ”¯æŒæ˜¯å¦è¶³å¤Ÿï¼Ÿï¼ˆå½“å‰ï¼šPDFã€Wordã€çº¯æ–‡æœ¬ï¼‰
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒéŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶çš„å¤šæ¨¡æ€åˆ†æï¼Ÿ
- [ ] æ–‡æ¡£æ–‡æœ¬æå–çš„å‡†ç¡®æ€§å’Œæ€§èƒ½å¦‚ä½•ä¿è¯ï¼Ÿ

#### **3. APIè°ƒç”¨é…ç½®**
- [ ] è¶…æ—¶æ—¶é—´è®¾ç½®æ˜¯å¦åˆç†ï¼Ÿï¼ˆå½“å‰ï¼š3åˆ†é’Ÿï¼‰
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒæµå¼å“åº”ï¼Ÿ
- [ ] å¹¶å‘è¯·æ±‚æ•°é‡é™åˆ¶å¦‚ä½•è®¾ç½®ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ é‡è¯•æœºåˆ¶ï¼Ÿ

#### **4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ é™„ä»¶å†…å®¹ç¼“å­˜ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒé™„ä»¶é¢„å¤„ç†å’Œå‹ç¼©ï¼Ÿ
- [ ] æ‰¹é‡å¤„ç†é™„ä»¶çš„ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ CDNæ”¯æŒï¼Ÿ

---

## âš ï¸ **ç¬¬äº”é˜¶æ®µï¼šéœ€è¦ç¡®è®¤çš„å…³é”®é—®é¢˜**

### **1. å¤šæ¨¡æ€APIå…¼å®¹æ€§ç¡®è®¤**

#### **1.1 Geminiå¤šæ¨¡æ€æ”¯æŒ**
- [ ] **Base64ç¼–ç ç­–ç•¥**ï¼šå½“å‰ç»Ÿä¸€ä½¿ç”¨Base64å†…åµŒæ–¹å¼ï¼ˆç®€åŒ–å®ç°ï¼‰ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯å¦éœ€è¦å®ç°Gemini File APIï¼Ÿ
- [ ] **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šå½“å‰20MBå†…åµŒé™åˆ¶æ˜¯å¦è¶³å¤Ÿï¼Ÿè¶…å¤§æ–‡ä»¶å¤„ç†ç­–ç•¥æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] **PDFè§†è§‰ç†è§£**ï¼šGeminiå¯¹PDFçš„è§†è§‰ç†è§£èƒ½åŠ›æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] **å›¾ç‰‡æ ¼å¼æ”¯æŒ**ï¼šJPEGã€PNGã€WebPç­‰æ ¼å¼æ”¯æŒæ˜¯å¦å®Œæ•´ï¼Ÿ

#### **1.2 OpenAI GPTå¤šæ¨¡æ€æ”¯æŒ**
- [ ] **GPT-4oæ¨¡å‹ç¡®è®¤**ï¼šå½“å‰é¡¹ç›®ä¸­çš„GPTæ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€ï¼Ÿ
- [ ] **å›¾ç‰‡åˆ†æè´¨é‡**ï¼š`detail: 'high'`è®¾ç½®æ˜¯å¦åˆé€‚ï¼Ÿæ˜¯å¦éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Ÿ
- [ ] **æ–‡æ¡£å¤„ç†ç­–ç•¥**ï¼šGPTå¯¹æ–‡æ¡£çš„æ–‡æœ¬æå–æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] **APIè°ƒç”¨æˆæœ¬**ï¼šå¤šæ¨¡æ€è¯·æ±‚çš„æˆæœ¬æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´å†…ï¼Ÿ

#### **1.3 Claudeå¤šæ¨¡æ€æ”¯æŒ**
- [ ] **Claude APIé›†æˆ**ï¼šå½“å‰é¡¹ç›®ä¸­Claude APIæ˜¯å¦å·²é…ç½®ï¼Ÿ
- [ ] **å¤šæ¨¡æ€èƒ½åŠ›ç¡®è®¤**ï¼šClaudeæ¨¡å‹æ˜¯å¦æ”¯æŒå›¾ç‰‡å’Œæ–‡æ¡£åˆ†æï¼Ÿ
- [ ] **å®ç°ä¼˜å…ˆçº§**ï¼šClaudeå¤šæ¨¡æ€åŠŸèƒ½æ˜¯å¦ä¸ºå¿…éœ€åŠŸèƒ½ï¼Ÿ

### **2. æ–‡ä»¶å¤„ç†æŠ€æœ¯ç¡®è®¤**

#### **2.1 æ–‡æ¡£è§£æå·¥å…·é€‰æ‹©**
- [ ] **PDFè§£æ**ï¼šå½“å‰ä½¿ç”¨`pdf-parse@1.1.1`ï¼Œæ˜¯å¦éœ€è¦`pdf2pic`ç­‰æ›¿ä»£æ–¹æ¡ˆï¼Ÿ
- [ ] **Wordæ–‡æ¡£**ï¼šå½“å‰ä½¿ç”¨`mammoth@1.6.0`ï¼Œæ˜¯å¦éœ€è¦æ”¯æŒæ›´å¤šæ ¼å¼ï¼Ÿ
- [ ] **æ–‡æœ¬æå–**ï¼šæå–å‡†ç¡®ç‡æ˜¯å¦æ»¡è¶³AIåˆ†æéœ€æ±‚ï¼Ÿ
- [ ] **æ–‡ä»¶æ ¼å¼æ”¯æŒ**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ›´å¤šæ–‡æ¡£æ ¼å¼ï¼Ÿ

#### **2.2 å›¾ç‰‡å¤„ç†ç­–ç•¥**
- [ ] **Sharpåº“æ€§èƒ½**ï¼šå›¾ç‰‡å‹ç¼©å’Œæ ¼å¼è½¬æ¢æ€§èƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] **å‹ç¼©è´¨é‡**ï¼šå›¾ç‰‡å‹ç¼©åçš„è´¨é‡æŸå¤±æ˜¯å¦å¯æ¥å—ï¼Ÿ
- [ ] **æ ¼å¼è½¬æ¢**ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ›´å¤šå›¾ç‰‡æ ¼å¼ï¼Ÿ
- [ ] **ç¼©ç•¥å›¾ç”Ÿæˆ**ï¼šç¼©ç•¥å›¾å°ºå¯¸å’Œè´¨é‡è®¾ç½®æ˜¯å¦åˆé€‚ï¼Ÿ

### **3. å­˜å‚¨å’Œæ€§èƒ½ç¡®è®¤**

#### **3.1 æ–‡ä»¶å­˜å‚¨ç­–ç•¥**
- [ ] **æœ¬åœ°å­˜å‚¨å®¹é‡**ï¼šé¡¹ç›®æœåŠ¡å™¨å­˜å‚¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- [ ] **æ–‡ä»¶æ¸…ç†ç­–ç•¥**ï¼š24å°æ—¶ä¸´æ—¶æ–‡ä»¶æ¸…ç†æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] **å¤‡ä»½ç­–ç•¥**ï¼šæ˜¯å¦éœ€è¦æ–‡ä»¶å¤‡ä»½æœºåˆ¶ï¼Ÿ
- [ ] **è®¿é—®æƒé™**ï¼šæ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶æ˜¯å¦å¿…è¦ï¼Ÿ

#### **3.2 æ€§èƒ½ä¼˜åŒ–éœ€æ±‚**
- [ ] **å¹¶å‘å¤„ç†**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªé™„ä»¶çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ
- [ ] **å†…å­˜ä½¿ç”¨**ï¼šå¤§æ–‡ä»¶å¤„ç†æ—¶çš„å†…å­˜å ç”¨æ˜¯å¦å¯æ§ï¼Ÿ
- [ ] **å“åº”æ—¶é—´**ï¼šå¤šæ¨¡æ€è¯·æ±‚çš„å“åº”æ—¶é—´æ˜¯å¦å¯æ¥å—ï¼Ÿ
- [ ] **é”™è¯¯å¤„ç†**ï¼šé™„ä»¶å¤„ç†å¤±è´¥æ—¶çš„ç”¨æˆ·ä½“éªŒå¦‚ä½•ï¼Ÿ

### **4. ç”¨æˆ·ä½“éªŒç¡®è®¤**

#### **4.1 ä¸Šä¼ ä½“éªŒ**
- [ ] **ä¸Šä¼ è¿›åº¦**ï¼šå®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤ºæ˜¯å¦å¿…è¦ï¼Ÿ
- [ ] **æ–‡ä»¶é¢„è§ˆ**ï¼šä¸Šä¼ å‰æ˜¯å¦éœ€è¦æ–‡ä»¶é¢„è§ˆåŠŸèƒ½ï¼Ÿ
- [ ] **æ‹–æ‹½æ”¯æŒ**ï¼šæ‹–æ‹½ä¸Šä¼ çš„ç”¨æˆ·ä½“éªŒå¦‚ä½•ï¼Ÿ
- [ ] **æ‰¹é‡ä¸Šä¼ **ï¼šåŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶çš„ä½“éªŒå¦‚ä½•ï¼Ÿ

#### **4.2 AIäº¤äº’ä½“éªŒ**
- [ ] **å“åº”é€Ÿåº¦**ï¼šå¤šæ¨¡æ€AIå“åº”çš„é€Ÿåº¦æ˜¯å¦å¯æ¥å—ï¼Ÿ
- [ ] **é”™è¯¯æç¤º**ï¼šé™„ä»¶å¤„ç†å¤±è´¥æ—¶çš„æç¤ºæ˜¯å¦å‹å¥½ï¼Ÿ
- [ ] **ç»“æœå±•ç¤º**ï¼šAIåˆ†æç»“æœçš„å±•ç¤ºæ–¹å¼æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] **å†å²è®°å½•**ï¼šé™„ä»¶å’ŒAIå›å¤çš„å†å²è®°å½•å¦‚ä½•ç®¡ç†ï¼Ÿ

---

## âœ… **ç¬¬äº”é˜¶æ®µå®æ–½Checklist** - ğŸ‰ **100%å®Œæˆ**

### **ğŸ“‹ åŸºç¡€åŠŸèƒ½å®ç°æ£€æŸ¥** - âœ… **å…¨éƒ¨å®Œæˆ**
- [x] å®ç°ç®€åŒ–çš„å¤šæ¨¡æ€è¯·æ±‚æ„å»ºå™¨ - âœ… `convertMessagesForModel`å‡½æ•°å®Œæˆ
- [x] é›†æˆGemini Base64å¤šæ¨¡æ€æ”¯æŒï¼ˆå½“å‰ç­–ç•¥ï¼‰ - âœ… æ”¯æŒå›¾ç‰‡Base64+æ–‡æ¡£å¤„ç†
- [x] é›†æˆOpenAI GPTå¤šæ¨¡æ€æ”¯æŒï¼ˆå½“å‰ç­–ç•¥ï¼‰ - âœ… ä¸‰å±‚å¤„ç†ç­–ç•¥ï¼ˆå›¾ç‰‡+æ–‡æ¡£+æè¿°ï¼‰
- [x] å®ç°åŸºç¡€çš„æ–‡æ¡£æ–‡æœ¬æå– - âœ… `extractDocumentText`å‡½æ•°ï¼ˆPDF/Word/Textï¼‰
- [x] å®ç°åŸºç¡€çš„å›¾ç‰‡å¤„ç†åŠŸèƒ½ - âœ… Sharpåº“é›†æˆå®Œæˆ

### **ğŸ”§ æŠ€æœ¯é›†æˆæ£€æŸ¥** - âœ… **å…¨éƒ¨å®Œæˆ**
- [x] å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…ï¼ˆpdf-parse@1.1.1ã€mammoth@1.6.0ç­‰ï¼‰ - âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…
- [x] é…ç½®å¤šæ¨¡æ€APIè°ƒç”¨å‚æ•° - âœ… Gemini/GPTå‚æ•°é…ç½®å®Œæˆ
- [x] å®ç°æ–‡ä»¶ç±»å‹æ£€æµ‹å’ŒéªŒè¯ - âœ… `fileProcessor.js`å®Œæˆ
- [x] å®ç°Base64ç¼–ç å’Œè§£ç åŠŸèƒ½ï¼ˆå½“å‰ä¸»è¦ç­–ç•¥ï¼‰ - âœ… é›†æˆåœ¨å¤šæ¨¡æ€å¤„ç†ä¸­
- [x] å®ç°é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶ - âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†é€»è¾‘

### **ğŸ§ª åŠŸèƒ½æµ‹è¯•æ£€æŸ¥** - âœ… **å…¨éƒ¨å®Œæˆ**
- [x] æµ‹è¯•å›¾ç‰‡ä¸Šä¼ å’ŒAIåˆ†æåŠŸèƒ½ - âœ… Gemini/GPTå›¾ç‰‡åˆ†æéªŒè¯é€šè¿‡
- [x] æµ‹è¯•PDFæ–‡æ¡£ä¸Šä¼ å’ŒAIåˆ†æåŠŸèƒ½ - âœ… PDFæ–‡æœ¬æå–+AIåˆ†æéªŒè¯é€šè¿‡
- [x] æµ‹è¯•Wordæ–‡æ¡£ä¸Šä¼ å’ŒAIåˆ†æåŠŸèƒ½ - âœ… Wordæ–‡æ¡£è§£æéªŒè¯é€šè¿‡
- [x] æµ‹è¯•å¤šæ–‡ä»¶åŒæ—¶ä¸Šä¼ åŠŸèƒ½ - âœ… æ‰¹é‡ä¸Šä¼ åŠŸèƒ½éªŒè¯é€šè¿‡
- [x] æµ‹è¯•é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶ - âœ… å¼‚å¸¸å¤„ç†éªŒè¯é€šè¿‡

### **ğŸ“Š æ€§èƒ½æµ‹è¯•æ£€æŸ¥** - âœ… **æ ¸å¿ƒå®Œæˆ**
- [x] æµ‹è¯•å°æ–‡ä»¶ï¼ˆ<1MBï¼‰å¤„ç†æ€§èƒ½ - âœ… å“åº”å¿«é€Ÿ
- [x] æµ‹è¯•ä¸­ç­‰æ–‡ä»¶ï¼ˆ1-10MBï¼‰å¤„ç†æ€§èƒ½ - âœ… æ€§èƒ½è‰¯å¥½
- [x] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼‰å¤„ç†æ€§èƒ½ - âœ… åœ¨å¯æ¥å—èŒƒå›´å†…
- [x] æµ‹è¯•å¹¶å‘ä¸Šä¼ å¤„ç†æ€§èƒ½ - âœ… å¤šè½®å¯¹è¯æµ‹è¯•é€šè¿‡
- [x] æµ‹è¯•å†…å­˜ä½¿ç”¨å’Œæ¸…ç†æƒ…å†µ - âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶æ­£å¸¸

### **ğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥** - âœ… **å…¨éƒ¨å®Œæˆ**
- [x] éªŒè¯æ–‡ä»¶ç±»å‹ç™½åå•æœºåˆ¶ - âœ… `validateFileType`å‡½æ•°å®Œæˆ
- [x] æµ‹è¯•æ¶æ„æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤ - âœ… æ–‡ä»¶ç±»å‹+å¤§å°éªŒè¯
- [x] éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦ç”Ÿæ•ˆ - âœ… 20MBé™åˆ¶æ­£å¸¸å·¥ä½œ
- [x] æµ‹è¯•Base64ç¼–ç å®‰å…¨æ€§ï¼ˆå½“å‰ä¸»è¦ä¼ è¾“æ–¹å¼ï¼‰ - âœ… å®‰å…¨ä¼ è¾“éªŒè¯é€šè¿‡
- [x] éªŒè¯APIè°ƒç”¨æƒé™æ§åˆ¶ - âœ… ä¼šè¯å…³è”éªŒè¯å®Œæˆ

### **ğŸ“ æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥** - âœ… **æ ¸å¿ƒå®Œæˆ**
- [x] æ›´æ–°APIä½¿ç”¨æ–‡æ¡£ - âœ… æŠ€æœ¯å®ç°æ–‡æ¡£å·²åˆ›å»º
- [x] æ·»åŠ å¤šæ¨¡æ€åŠŸèƒ½è¯´æ˜ - âœ… è¯¦ç»†å¯¹ç…§è¡¨å·²å®Œæˆ
- [x] æ·»åŠ é”™è¯¯å¤„ç†æŒ‡å— - âœ… ä»£ç ä¸­åŒ…å«å®Œæ•´é”™è¯¯å¤„ç†
- [x] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§ - âœ… æ‰€æœ‰é…ç½®æ­£å¸¸
- [x] æ·»åŠ æ•…éšœæ’é™¤æŒ‡å— - âœ… è°ƒè¯•å’Œæµ‹è¯•æœºåˆ¶å®Œå–„

### **ğŸš€ é¢å¤–å®Œæˆçš„é‡è¦åŠŸèƒ½**
- [x] **æµå¼APIé™„ä»¶æ”¯æŒ** - âœ… æµå¼èŠå¤©å®Œç¾æ”¯æŒé™„ä»¶
- [x] **å¤šè½®å¯¹è¯ä¿®å¤** - âœ… ä¿®å¤é˜²é‡å¤é€»è¾‘ï¼Œæ”¯æŒæ­£å¸¸å¤šè½®å¯¹è¯
- [x] **Claudeæ¥å£é¢„ç•™** - âœ… ä¸ºClaude APIé¢„ç•™å®Œæ•´å¤šæ¨¡æ€æ¥å£
- [x] **å…¨é¢æµ‹è¯•éªŒè¯** - âœ… æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡å®é™…æµ‹è¯•éªŒè¯

---

## ğŸš€ **ç»§ç»­å¼€å‘ï¼šå‰ç«¯ç»„ä»¶å¼€å‘æ¨¡å—**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘å‰ç«¯ç»„ä»¶åŠŸèƒ½ã€‚

---

## ğŸ¨ **ç¬¬å…­é˜¶æ®µï¼šå‰ç«¯ç»„ä»¶å¼€å‘**

### **6.1 æ–‡ä»¶ä¸Šä¼ ç»„ä»¶**

#### **6.1.1 æ‹–æ‹½ä¸Šä¼ ç»„ä»¶**
```typescript
// æ‹–æ‹½ä¸Šä¼ ç»„ä»¶
import React, { useState, useRef, useCallback } from 'react';
import { Upload, FileText, Image, Video, Music, File } from 'lucide-react';

interface FileUploadProps {
  onFilesSelected: (files: File[]) => void;
  maxFiles?: number;
  maxFileSize?: number;
  acceptedTypes?: string[];
  disabled?: boolean;
}

const FileUpload: React.FC<FileUploadProps> = ({
  onFilesSelected,
  maxFiles = 10,
  maxFileSize = 50 * 1024 * 1024, // 50MB
  acceptedTypes = ['image/*', 'application/pdf', 'text/*'],
  disabled = false
}) => {
  const [isDragOver, setIsDragOver] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<{[key: string]: number}>({});
  const fileInputRef = useRef<HTMLInputElement>(null);

  // å¤„ç†æ‹–æ‹½äº‹ä»¶
  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    if (!disabled) {
      setIsDragOver(true);
    }
  }, [disabled]);

  const handleDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragOver(false);
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragOver(false);
    
    if (disabled) return;
    
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  }, [disabled]);

  // å¤„ç†æ–‡ä»¶é€‰æ‹©
  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    handleFiles(files);
  }, []);

  // éªŒè¯å’Œå¤„ç†æ–‡ä»¶
  const handleFiles = useCallback((files: File[]) => {
    const validFiles: File[] = [];
    const errors: string[] = [];

    files.forEach(file => {
      // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶
      if (validFiles.length >= maxFiles) {
        errors.push(`æœ€å¤šåªèƒ½ä¸Šä¼  ${maxFiles} ä¸ªæ–‡ä»¶`);
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶å¤§å°
      if (file.size > maxFileSize) {
        errors.push(`${file.name} æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ ${(maxFileSize / 1024 / 1024).toFixed(1)}MB`);
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const isValidType = acceptedTypes.some(type => {
        if (type.endsWith('/*')) {
          return file.type.startsWith(type.slice(0, -1));
        }
        return file.type === type;
      });

      if (!isValidType) {
        errors.push(`${file.name} æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ`);
        return;
      }

      validFiles.push(file);
    });

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (errors.length > 0) {
      errors.forEach(error => console.warn(error));
      // è¿™é‡Œå¯ä»¥é›†æˆtoasté€šçŸ¥
    }

    if (validFiles.length > 0) {
      onFilesSelected(validFiles);
    }
  }, [maxFiles, maxFileSize, acceptedTypes, onFilesSelected]);

  // è·å–æ–‡ä»¶å›¾æ ‡
  const getFileIcon = (file: File) => {
    if (file.type.startsWith('image/')) return <Image className="w-6 h-6 text-blue-500" />;
    if (file.type.startsWith('video/')) return <Video className="w-6 h-6 text-purple-500" />;
    if (file.type.startsWith('audio/')) return <Music className="w-6 h-6 text-green-500" />;
    if (file.type === 'application/pdf') return <FileText className="w-6 h-6 text-red-500" />;
    return <File className="w-6 h-6 text-gray-500" />;
  };

  return (
    <div className="w-full">
      {/* æ‹–æ‹½åŒºåŸŸ */}
      <div
        className={`
          relative border-2 border-dashed rounded-lg p-8 text-center transition-colors
          ${isDragOver 
            ? 'border-blue-500 bg-blue-50' 
            : 'border-gray-300 hover:border-gray-400'
          }
          ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
        `}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        onClick={() => !disabled && fileInputRef.current?.click()}
      >
        <Upload className="w-12 h-12 mx-auto text-gray-400 mb-4" />
        
        <div className="space-y-2">
          <p className="text-lg font-medium text-gray-900">
            æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
          </p>
          <p className="text-sm text-gray-500">
            æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æ¡£ç­‰æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ {maxFileSize / 1024 / 1024}MB
          </p>
          <p className="text-xs text-gray-400">
            æœ€å¤šå¯ä¸Šä¼  {maxFiles} ä¸ªæ–‡ä»¶
          </p>
        </div>

        {/* éšè—çš„æ–‡ä»¶è¾“å…¥ */}
        <input
          ref={fileInputRef}
          type="file"
          multiple
          accept={acceptedTypes.join(',')}
          onChange={handleFileSelect}
          className="hidden"
          disabled={disabled}
        />
      </div>

      {/* ä¸Šä¼ è¿›åº¦æ˜¾ç¤º */}
      {Object.keys(uploadProgress).length > 0 && (
        <div className="mt-4 space-y-2">
          {Object.entries(uploadProgress).map(([fileName, progress]) => (
            <div key={fileName} className="flex items-center space-x-2">
              <div className="flex-1 bg-gray-200 rounded-full h-2">
                <div 
                  className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                  style={{ width: `${progress}%` }}
                />
              </div>
              <span className="text-sm text-gray-600 min-w-[60px]">
                {progress}%
              </span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default FileUpload;
```

#### **6.1.2 æ–‡ä»¶é¢„è§ˆç»„ä»¶**
```typescript
// æ–‡ä»¶é¢„è§ˆç»„ä»¶
import React, { useState, useEffect } from 'react';
import { X, Download, Eye, FileText, Image, Video, Music } from 'lucide-react';

interface FilePreviewProps {
  file: {
    id: string;
    name: string;
    type: string;
    size: number;
    url?: string;
    thumbnailUrl?: string;
  };
  onRemove?: (id: string) => void;
  onDownload?: (id: string) => void;
  showActions?: boolean;
}

const FilePreview: React.FC<FilePreviewProps> = ({
  file,
  onRemove,
  onDownload,
  showActions = true
}) => {
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  // ç”Ÿæˆé¢„è§ˆURL
  useEffect(() => {
    if (file.thumbnailUrl) {
      setPreviewUrl(file.thumbnailUrl);
    } else if (file.url && file.type.startsWith('image/')) {
      setPreviewUrl(file.url);
    }
  }, [file]);

  // è·å–æ–‡ä»¶å›¾æ ‡
  const getFileIcon = () => {
    if (file.type.startsWith('image/')) return <Image className="w-8 h-8 text-blue-500" />;
    if (file.type.startsWith('video/')) return <Video className="w-8 h-8 text-purple-500" />;
    if (file.type.startsWith('audio/')) return <Music className="w-8 h-8 text-green-500" />;
    if (file.type === 'application/pdf') return <FileText className="w-8 h-8 text-red-500" />;
    return <FileText className="w-8 h-8 text-gray-500" />;
  };

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  // å¤„ç†é¢„è§ˆç‚¹å‡»
  const handlePreview = () => {
    if (file.url) {
      window.open(file.url, '_blank');
    }
  };

  return (
    <div className="relative group bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
      {/* æ–‡ä»¶ä¿¡æ¯ */}
      <div className="flex items-start space-x-3">
        {/* æ–‡ä»¶å›¾æ ‡/é¢„è§ˆ */}
        <div className="flex-shrink-0">
          {previewUrl ? (
            <div className="w-16 h-16 rounded-lg overflow-hidden bg-gray-100">
              <img
                src={previewUrl}
                alt={file.name}
                className="w-full h-full object-cover"
                onLoad={() => setIsLoading(false)}
                onError={() => setIsLoading(false)}
              />
            </div>
          ) : (
            <div className="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center">
              {getFileIcon()}
            </div>
          )}
        </div>

        {/* æ–‡ä»¶è¯¦æƒ… */}
        <div className="flex-1 min-w-0">
          <h4 className="text-sm font-medium text-gray-900 truncate">
            {file.name}
          </h4>
          <p className="text-xs text-gray-500 mt-1">
            {formatFileSize(file.size)}
          </p>
          <p className="text-xs text-gray-400 mt-1">
            {file.type}
          </p>
        </div>

        {/* æ“ä½œæŒ‰é’® */}
        {showActions && (
          <div className="flex-shrink-0 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
            {file.url && (
              <button
                onClick={handlePreview}
                className="p-1 text-gray-400 hover:text-blue-500 transition-colors"
                title="é¢„è§ˆ"
              >
                <Eye className="w-4 h-4" />
              </button>
            )}
            
            {onDownload && (
              <button
                onClick={() => onDownload(file.id)}
                className="p-1 text-gray-400 hover:text-green-500 transition-colors"
                title="ä¸‹è½½"
              >
                <Download className="w-4 h-4" />
              </button>
            )}
            
            {onRemove && (
              <button
                onClick={() => onRemove(file.id)}
                className="p-1 text-gray-400 hover:text-red-500 transition-colors"
                title="åˆ é™¤"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>
        )}
      </div>

      {/* åŠ è½½çŠ¶æ€ */}
      {isLoading && (
        <div className="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-lg">
          <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        </div>
      )}
    </div>
  );
};

export default FilePreview;
```

#### **6.1.3 èŠå¤©ç•Œé¢é›†æˆç»„ä»¶**
```typescript
// èŠå¤©ç•Œé¢é›†æˆç»„ä»¶
import React, { useState, useRef, useEffect } from 'react';
import { Send, Paperclip, X, Image, FileText, Video, Music } from 'lucide-react';
import FileUpload from './FileUpload';
import FilePreview from './FilePreview';

interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
  attachments?: Array<{
    id: string;
    name: string;
    type: string;
    url: string;
    thumbnailUrl?: string;
  }>;
}

interface ChatInterfaceProps {
  onSendMessage: (message: string, attachments: File[]) => Promise<void>;
  messages: ChatMessage[];
  isLoading?: boolean;
  disabled?: boolean;
}

const ChatInterface: React.FC<ChatInterfaceProps> = ({
  onSendMessage,
  messages,
  isLoading = false,
  disabled = false
}) => {
  const [inputValue, setInputValue] = useState('');
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [showFileUpload, setShowFileUpload] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // å¤„ç†å‘é€æ¶ˆæ¯
  const handleSendMessage = async () => {
    if (!inputValue.trim() && selectedFiles.length === 0) return;
    if (disabled || isLoading) return;

    try {
      await onSendMessage(inputValue.trim(), selectedFiles);
      setInputValue('');
      setSelectedFiles([]);
      setShowFileUpload(false);
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
      // è¿™é‡Œå¯ä»¥é›†æˆé”™è¯¯æç¤º
    }
  };

  // å¤„ç†æ–‡ä»¶é€‰æ‹©
  const handleFilesSelected = (files: File[]) => {
    setSelectedFiles(prev => [...prev, ...files]);
  };

  // ç§»é™¤é€‰ä¸­çš„æ–‡ä»¶
  const handleRemoveFile = (index: number) => {
    setSelectedFiles(prev => prev.filter((_, i) => i !== index));
  };

  // å¤„ç†å›è½¦é”®
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  // è·å–æ–‡ä»¶å›¾æ ‡
  const getFileIcon = (file: File) => {
    if (file.type.startsWith('image/')) return <Image className="w-4 h-4 text-blue-500" />;
    if (file.type.startsWith('video/')) return <Video className="w-4 h-4 text-purple-500" />;
    if (file.type.startsWith('audio/')) return <Music className="w-4 h-4 text-green-500" />;
    if (file.type === 'application/pdf') return <FileText className="w-4 h-4 text-red-500" />;
    return <FileText className="w-4 h-4 text-gray-500" />;
  };

  return (
    <div className="flex flex-col h-full bg-white">
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((message) => (
          <div
            key={message.id}
            className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div
              className={`
                max-w-[70%] rounded-lg p-3
                ${message.role === 'user'
                  ? 'bg-blue-500 text-white'
                  : 'bg-gray-100 text-gray-900'
                }
              `}
            >
              {/* æ¶ˆæ¯å†…å®¹ */}
              <div className="whitespace-pre-wrap">{message.content}</div>
              
              {/* é™„ä»¶æ˜¾ç¤º */}
              {message.attachments && message.attachments.length > 0 && (
                <div className="mt-2 space-y-2">
                  {message.attachments.map((attachment) => (
                    <div
                      key={attachment.id}
                      className={`
                        flex items-center space-x-2 p-2 rounded
                        ${message.role === 'user'
                          ? 'bg-blue-400 bg-opacity-30'
                          : 'bg-gray-200'
                        }
                      `}
                    >
                      {getFileIcon({ type: attachment.type } as File)}
                      <span className="text-sm truncate">{attachment.name}</span>
                    </div>
                  ))}
                </div>
              )}
              
              {/* æ—¶é—´æˆ³ */}
              <div
                className={`
                  text-xs mt-2 opacity-70
                  ${message.role === 'user' ? 'text-blue-100' : 'text-gray-500'}
                `}
              >
                {message.timestamp.toLocaleTimeString()}
              </div>
            </div>
          </div>
        ))}
        
        {/* åŠ è½½çŠ¶æ€ */}
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-gray-100 rounded-lg p-3">
              <div className="flex space-x-1">
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
              </div>
            </div>
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>

      {/* è¾“å…¥åŒºåŸŸ */}
      <div className="border-t border-gray-200 p-4">
        {/* é€‰ä¸­çš„æ–‡ä»¶é¢„è§ˆ */}
        {selectedFiles.length > 0 && (
          <div className="mb-3 p-3 bg-gray-50 rounded-lg">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-gray-700">
                å·²é€‰æ‹© {selectedFiles.length} ä¸ªæ–‡ä»¶
              </span>
              <button
                onClick={() => setSelectedFiles([])}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
            <div className="grid grid-cols-2 gap-2">
              {selectedFiles.map((file, index) => (
                <div
                  key={index}
                  className="flex items-center space-x-2 p-2 bg-white rounded border"
                >
                  {getFileIcon(file)}
                  <span className="text-xs text-gray-600 truncate flex-1">
                    {file.name}
                  </span>
                  <button
                    onClick={() => handleRemoveFile(index)}
                    className="text-gray-400 hover:text-red-500"
                  >
                    <X className="w-3 h-3" />
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* è¾“å…¥æ¡†å’ŒæŒ‰é’® */}
        <div className="flex space-x-2">
          {/* æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */}
          <button
            onClick={() => setShowFileUpload(!showFileUpload)}
            disabled={disabled}
            className={`
              p-2 rounded-lg transition-colors
              ${disabled
                ? 'text-gray-400 cursor-not-allowed'
                : 'text-gray-500 hover:text-blue-500 hover:bg-blue-50'
              }
            `}
            title="æ·»åŠ é™„ä»¶"
          >
            <Paperclip className="w-5 h-5" />
          </button>

          {/* æ–‡æœ¬è¾“å…¥æ¡† */}
          <div className="flex-1 relative">
            <textarea
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="è¾“å…¥æ¶ˆæ¯..."
              disabled={disabled}
              className={`
                w-full px-3 py-2 border border-gray-300 rounded-lg resize-none
                focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
                ${disabled ? 'bg-gray-100 cursor-not-allowed' : 'bg-white'}
              `}
              rows={1}
              style={{
                minHeight: '40px',
                maxHeight: '120px'
              }}
            />
          </div>

          {/* å‘é€æŒ‰é’® */}
          <button
            onClick={handleSendMessage}
            disabled={disabled || isLoading || (!inputValue.trim() && selectedFiles.length === 0)}
            className={`
              p-2 rounded-lg transition-colors
              ${disabled || isLoading || (!inputValue.trim() && selectedFiles.length === 0)
                ? 'text-gray-400 cursor-not-allowed'
                : 'text-blue-500 hover:text-white hover:bg-blue-500'
              }
            `}
            title="å‘é€æ¶ˆæ¯"
          >
            <Send className="w-5 h-5" />
          </button>
        </div>

        {/* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */}
        {showFileUpload && (
          <div className="mt-3">
            <FileUpload
              onFilesSelected={handleFilesSelected}
              maxFiles={5}
              maxFileSize={50 * 1024 * 1024}
              acceptedTypes={['image/*', 'application/pdf', 'text/*', 'video/*', 'audio/*']}
              disabled={disabled}
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default ChatInterface;
```

#### **6.1.4 é™„ä»¶ç®¡ç†Hook**
```typescript
// é™„ä»¶ç®¡ç†Hook
import { useState, useCallback } from 'react';

interface Attachment {
  id: string;
  name: string;
  type: string;
  size: number;
  url: string;
  thumbnailUrl?: string;
  uploadProgress?: number;
  status: 'uploading' | 'success' | 'error';
}

interface UseAttachmentsReturn {
  attachments: Attachment[];
  addAttachment: (file: File) => void;
  removeAttachment: (id: string) => void;
  updateAttachmentProgress: (id: string, progress: number) => void;
  updateAttachmentStatus: (id: string, status: Attachment['status']) => void;
  clearAttachments: () => void;
  uploadAttachments: (files: File[]) => Promise<Attachment[]>;
}

export const useAttachments = (): UseAttachmentsReturn => {
  const [attachments, setAttachments] = useState<Attachment[]>([]);

  // æ·»åŠ é™„ä»¶
  const addAttachment = useCallback((file: File) => {
    const attachment: Attachment = {
      id: `temp_${Date.now()}_${Math.random()}`,
      name: file.name,
      type: file.type,
      size: file.size,
      url: URL.createObjectURL(file),
      status: 'uploading',
      uploadProgress: 0
    };

    setAttachments(prev => [...prev, attachment]);
  }, []);

  // ç§»é™¤é™„ä»¶
  const removeAttachment = useCallback((id: string) => {
    setAttachments(prev => {
      const attachment = prev.find(a => a.id === id);
      if (attachment?.url.startsWith('blob:')) {
        URL.revokeObjectURL(attachment.url);
      }
      return prev.filter(a => a.id !== id);
    });
  }, []);

  // æ›´æ–°ä¸Šä¼ è¿›åº¦
  const updateAttachmentProgress = useCallback((id: string, progress: number) => {
    setAttachments(prev => 
      prev.map(a => a.id === id ? { ...a, uploadProgress: progress } : a)
    );
  }, []);

  // æ›´æ–°é™„ä»¶çŠ¶æ€
  const updateAttachmentStatus = useCallback((id: string, status: Attachment['status']) => {
    setAttachments(prev => 
      prev.map(a => a.id === id ? { ...a, status } : a)
    );
  }, []);

  // æ¸…ç©ºé™„ä»¶
  const clearAttachments = useCallback(() => {
    setAttachments(prev => {
      prev.forEach(a => {
        if (a.url.startsWith('blob:')) {
          URL.revokeObjectURL(a.url);
        }
      });
      return [];
    });
  }, []);

  // ä¸Šä¼ é™„ä»¶åˆ°æœåŠ¡å™¨
  const uploadAttachments = useCallback(async (files: File[]): Promise<Attachment[]> => {
    const uploadPromises = files.map(async (file) => {
      const attachment: Attachment = {
        id: `temp_${Date.now()}_${Math.random()}`,
        name: file.name,
        type: file.type,
        size: file.size,
        url: URL.createObjectURL(file),
        status: 'uploading',
        uploadProgress: 0
      };

      addAttachment(file);

      try {
        // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/attachments/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('ä¸Šä¼ å¤±è´¥');
        }

        const result = await response.json();
        
        // æ›´æ–°é™„ä»¶ä¿¡æ¯
        updateAttachmentStatus(attachment.id, 'success');
        updateAttachmentProgress(attachment.id, 100);

        return {
          ...attachment,
          id: result.attachmentId,
          url: result.url,
          thumbnailUrl: result.thumbnailUrl,
          status: 'success' as const,
          uploadProgress: 100
        };

      } catch (error) {
        console.error('é™„ä»¶ä¸Šä¼ å¤±è´¥:', error);
        updateAttachmentStatus(attachment.id, 'error');
        throw error;
      }
    });

    return Promise.all(uploadPromises);
  }, [addAttachment, updateAttachmentStatus, updateAttachmentProgress]);

  return {
    attachments,
    addAttachment,
    removeAttachment,
    updateAttachmentProgress,
    updateAttachmentStatus,
    clearAttachments,
    uploadAttachments
  };
};
```


### **å¤šæ¨¡æ€AIé›†æˆæ¨¡å—äº®ç‚¹**
1. **ç»Ÿä¸€æ¥å£**: æ”¯æŒGeminiã€GPTã€Claudeä¸‰ç§æ¨¡å‹
2. **æ™ºèƒ½è¯·æ±‚æ„å»º**: è‡ªåŠ¨æ„å»ºä¸åŒæ¨¡å‹çš„å¤šæ¨¡æ€è¯·æ±‚æ ¼å¼
3. **é™„ä»¶å¤„ç†**: æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ç­‰å¤šç§é™„ä»¶ç±»å‹
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
5. **æ‰©å±•æ€§**: é¢„ç•™Claudeå¤šæ¨¡æ€æ”¯æŒæ¥å£

---

## âš ï¸ **ç¬¬å…­é˜¶æ®µï¼šéœ€è¦ç¡®è®¤çš„å…³é”®é—®é¢˜**

### **1. ä¸ç°æœ‰é¡¹ç›®é›†æˆç¡®è®¤**

#### **1.1 ç»„ä»¶æ¥å£å…¼å®¹æ€§**
- [ ] **ChatInputæ‰©å±•**ï¼šç°æœ‰ChatInputåªæ”¯æŒæ–‡æœ¬ï¼Œå¦‚ä½•æ‰©å±•æ”¯æŒé™„ä»¶ï¼Ÿ
- [ ] **æ¶ˆæ¯ç»“æ„ç»Ÿä¸€**ï¼šç°æœ‰Messageæ¥å£ä¸ChatMessageæ¥å£å¦‚ä½•ç»Ÿä¸€ï¼Ÿ
- [ ] **APIæ¥å£å…¼å®¹**ï¼šç°æœ‰APIæ˜¯å¦æ”¯æŒé™„ä»¶å‚æ•°ï¼Ÿéœ€è¦å¦‚ä½•æ‰©å±•ï¼Ÿ
- [ ] **çŠ¶æ€ç®¡ç†**ï¼šæ˜¯å¦éœ€è¦å…¨å±€çŠ¶æ€ç®¡ç†æ¥åè°ƒé™„ä»¶å’Œæ¶ˆæ¯ï¼Ÿ

#### **1.2 ç°æœ‰ç»„ä»¶é›†æˆç­–ç•¥**
- [ ] **æ¸è¿›å¼é›†æˆ**ï¼šæ˜¯æ‰©å±•ç°æœ‰ç»„ä»¶è¿˜æ˜¯åˆ›å»ºæ–°ç»„ä»¶ï¼Ÿ
- [ ] **å‘åå…¼å®¹**ï¼šå¦‚ä½•ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼Ÿ
- [ ] **æ•°æ®è¿ç§»**ï¼šç°æœ‰æ¶ˆæ¯æ•°æ®æ˜¯å¦éœ€è¦è¿ç§»æ”¯æŒé™„ä»¶ï¼Ÿ
- [ ] **UIå¸ƒå±€è°ƒæ•´**ï¼šç°æœ‰åˆ†æ å¸ƒå±€æ˜¯å¦éœ€è¦è°ƒæ•´ï¼Ÿ

### **2. æŠ€æœ¯æ ˆå…¼å®¹æ€§ç¡®è®¤**

#### **2.1 æ ·å¼æ¡†æ¶é€‰æ‹©**
- [ ] **CSSæ¡†æ¶**ï¼šç°æœ‰é¡¹ç›®ä½¿ç”¨ä»€ä¹ˆCSSæ¡†æ¶ï¼ŸTailwind CSSè¿˜æ˜¯å…¶ä»–ï¼Ÿ
- [ ] **æ ·å¼å†²çª**ï¼šæ–°ç»„ä»¶æ ·å¼æ˜¯å¦ä¸ç°æœ‰æ ·å¼å†²çªï¼Ÿ
- [ ] **å“åº”å¼è®¾è®¡**ï¼šæ–°ç»„ä»¶æ˜¯å¦é€‚é…ç°æœ‰çš„å“åº”å¼å¸ƒå±€ï¼Ÿ
- [ ] **ä¸»é¢˜ä¸€è‡´æ€§**ï¼šæ–°ç»„ä»¶æ˜¯å¦ä¸ç°æœ‰UIä¸»é¢˜ä¿æŒä¸€è‡´ï¼Ÿ

#### **2.2 ä¾èµ–åº“ç®¡ç†**
- [ ] **å›¾æ ‡åº“**ï¼šæ˜¯å¦å·²å®‰è£…lucide-reactï¼Ÿç‰ˆæœ¬æ˜¯å¦å…¼å®¹ï¼Ÿ
- [ ] **æ–‡ä»¶å¤„ç†åº“**ï¼šæ˜¯å¦éœ€è¦å®‰è£…æ–°çš„æ–‡ä»¶å¤„ç†ä¾èµ–ï¼Ÿ
- [ ] **ç±»å‹å®šä¹‰**ï¼šTypeScriptç±»å‹å®šä¹‰æ˜¯å¦ä¸ç°æœ‰é¡¹ç›®ä¸€è‡´ï¼Ÿ
- [ ] **åŒ…å¤§å°å½±å“**ï¼šæ–°å¢ä¾èµ–å¯¹é¡¹ç›®åŒ…å¤§å°çš„å½±å“å¦‚ä½•ï¼Ÿ

### **3. åŠŸèƒ½å®ç°ç¡®è®¤**

#### **3.1 æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½**
- [ ] **ä¸Šä¼ API**ï¼šåç«¯æ–‡ä»¶ä¸Šä¼ APIæ˜¯å¦å·²å®ç°ï¼Ÿ
- [ ] **æ–‡ä»¶å­˜å‚¨**ï¼šæ–‡ä»¶å­˜å‚¨è·¯å¾„å’Œè®¿é—®æƒé™å¦‚ä½•é…ç½®ï¼Ÿ
- [ ] **æ–‡ä»¶é¢„è§ˆ**ï¼šæ–‡ä»¶é¢„è§ˆåŠŸèƒ½æ˜¯å¦éœ€è¦CDNæ”¯æŒï¼Ÿ
- [ ] **é”™è¯¯å¤„ç†**ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥æ—¶çš„ç”¨æˆ·ä½“éªŒå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

#### **3.2 å¤šæ¨¡æ€AIé›†æˆ**
- [ ] **APIè°ƒç”¨**ï¼šå¤šæ¨¡æ€APIè°ƒç”¨æ˜¯å¦ä¸ç°æœ‰èŠå¤©APIé›†æˆï¼Ÿ
- [ ] **å“åº”å¤„ç†**ï¼šAIå“åº”ä¸­å¦‚ä½•å±•ç¤ºé™„ä»¶åˆ†æç»“æœï¼Ÿ
- [ ] **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§æ–‡ä»¶ä¸Šä¼ å’ŒAIåˆ†æçš„æ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ
- [ ] **æˆæœ¬æ§åˆ¶**ï¼šå¤šæ¨¡æ€APIè°ƒç”¨çš„æˆæœ¬å¦‚ä½•æ§åˆ¶ï¼Ÿ

### **4. ç”¨æˆ·ä½“éªŒç¡®è®¤**

#### **4.1 äº¤äº’æµç¨‹è®¾è®¡**
- [ ] **ä¸Šä¼ æµç¨‹**ï¼šæ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´ç”¨æˆ·æµç¨‹æ˜¯å¦åˆç†ï¼Ÿ
- [ ] **é¢„è§ˆä½“éªŒ**ï¼šæ–‡ä»¶é¢„è§ˆçš„äº¤äº’æ–¹å¼æ˜¯å¦ç›´è§‚ï¼Ÿ
- [ ] **é”™è¯¯æç¤º**ï¼šå„ç§é”™è¯¯æƒ…å†µçš„æç¤ºä¿¡æ¯æ˜¯å¦å‹å¥½ï¼Ÿ
- [ ] **åŠ è½½çŠ¶æ€**ï¼šä¸Šä¼ å’ŒAIåˆ†æè¿‡ç¨‹ä¸­çš„åŠ è½½çŠ¶æ€æ˜¯å¦æ¸…æ™°ï¼Ÿ

#### **4.2 æ€§èƒ½ä½“éªŒ**
- [ ] **ä¸Šä¼ é€Ÿåº¦**ï¼šæ–‡ä»¶ä¸Šä¼ é€Ÿåº¦æ˜¯å¦æ»¡è¶³ç”¨æˆ·æœŸæœ›ï¼Ÿ
- [ ] **å“åº”æ—¶é—´**ï¼šAIåˆ†æå“åº”æ—¶é—´æ˜¯å¦å¯æ¥å—ï¼Ÿ
- [ ] **å¹¶å‘å¤„ç†**ï¼šå¤šç”¨æˆ·åŒæ—¶ä¸Šä¼ æ—¶çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ
- [ ] **å†…å­˜ä½¿ç”¨**ï¼šå¤§æ–‡ä»¶å¤„ç†æ—¶çš„å†…å­˜å ç”¨æ˜¯å¦å¯æ§ï¼Ÿ

### **5. å®‰å…¨æ€§ç¡®è®¤**

#### **5.1 æ–‡ä»¶å®‰å…¨**
- [ ] **æ–‡ä»¶ç±»å‹éªŒè¯**ï¼šå‰ç«¯å’Œåç«¯çš„æ–‡ä»¶ç±»å‹éªŒè¯æ˜¯å¦ä¸€è‡´ï¼Ÿ
- [ ] **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šæ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦åœ¨å‰åç«¯éƒ½ç”Ÿæ•ˆï¼Ÿ
- [ ] **æ¶æ„æ–‡ä»¶é˜²æŠ¤**ï¼šå¦‚ä½•é˜²æŠ¤æ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼Ÿ
- [ ] **æ–‡ä»¶è®¿é—®æƒé™**ï¼šä¸Šä¼ æ–‡ä»¶çš„è®¿é—®æƒé™å¦‚ä½•æ§åˆ¶ï¼Ÿ

#### **5.2 æ•°æ®å®‰å…¨**
- [ ] **æ•æ„Ÿä¿¡æ¯**ï¼šé™„ä»¶ä¸­æ˜¯å¦å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Ÿ
- [ ] **æ•°æ®åŠ å¯†**ï¼šæ–‡ä»¶ä¼ è¾“å’Œå­˜å‚¨æ˜¯å¦éœ€è¦åŠ å¯†ï¼Ÿ
- [ ] **éšç§ä¿æŠ¤**ï¼šç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶éšç§å¦‚ä½•ä¿æŠ¤ï¼Ÿ
- [ ] **åˆè§„è¦æ±‚**ï¼šæ˜¯å¦éœ€è¦æ»¡è¶³ç‰¹å®šçš„åˆè§„è¦æ±‚ï¼Ÿ

### **6. æµ‹è¯•å’Œéƒ¨ç½²ç¡®è®¤**

#### **6.1 æµ‹è¯•ç­–ç•¥**
- [ ] **å•å…ƒæµ‹è¯•**ï¼šæ–°ç»„ä»¶çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡å¦‚ä½•ï¼Ÿ
- [ ] **é›†æˆæµ‹è¯•**ï¼šä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆæµ‹è¯•å¦‚ä½•è®¾è®¡ï¼Ÿ
- [ ] **ç”¨æˆ·æµ‹è¯•**ï¼šçœŸå®ç”¨æˆ·çš„ä½¿ç”¨ä½“éªŒå¦‚ä½•éªŒè¯ï¼Ÿ
- [ ] **æ€§èƒ½æµ‹è¯•**ï¼šå„ç§åœºæ™¯ä¸‹çš„æ€§èƒ½æµ‹è¯•å¦‚ä½•æ‰§è¡Œï¼Ÿ

#### **6.2 éƒ¨ç½²å’Œè¿ç»´**
- [ ] **éƒ¨ç½²ç­–ç•¥**ï¼šæ–°åŠŸèƒ½å¦‚ä½•å¹³æ»‘éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ
- [ ] **ç›‘æ§å‘Šè­¦**ï¼šæ–‡ä»¶ä¸Šä¼ å’ŒAIåˆ†æçš„ç›‘æ§å¦‚ä½•è®¾ç½®ï¼Ÿ
- [ ] **æ—¥å¿—è®°å½•**ï¼šå…³é”®æ“ä½œçš„æ—¥å¿—è®°å½•æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] **å›æ»šæ–¹æ¡ˆ**ï¼šå‡ºç°é—®é¢˜æ—¶å¦‚ä½•å¿«é€Ÿå›æ»šï¼Ÿ

---

## âœ… **ç¬¬å…­é˜¶æ®µå®æ–½Checklist**

### **ğŸ“‹ åŸºç¡€ç»„ä»¶å¼€å‘æ£€æŸ¥**
- [ ] å®ç°FileUploadæ‹–æ‹½ä¸Šä¼ ç»„ä»¶
- [ ] å®ç°FilePreviewæ–‡ä»¶é¢„è§ˆç»„ä»¶
- [ ] å®ç°ChatInterfaceé›†æˆç»„ä»¶
- [ ] å®ç°useAttachmentsçŠ¶æ€ç®¡ç†Hook
- [ ] å®Œæˆç»„ä»¶TypeScriptç±»å‹å®šä¹‰

### **ğŸ”§ æŠ€æœ¯é›†æˆæ£€æŸ¥**
- [ ] ç¡®è®¤ç°æœ‰é¡¹ç›®CSSæ¡†æ¶ï¼ˆTailwind CSSæˆ–å…¶ä»–ï¼‰
- [ ] å®‰è£…lucide-reactå›¾æ ‡åº“ä¾èµ–
- [ ] é…ç½®æ–‡ä»¶ä¸Šä¼ ç›¸å…³ä¾èµ–åŒ…
- [ ] ç»Ÿä¸€TypeScriptç±»å‹å®šä¹‰
- [ ] è§£å†³æ ·å¼æ¡†æ¶å…¼å®¹æ€§é—®é¢˜

### **ğŸ”— ç°æœ‰é¡¹ç›®é›†æˆæ£€æŸ¥**
- [ ] æ‰©å±•ChatInputç»„ä»¶æ”¯æŒé™„ä»¶ä¸Šä¼ 
- [ ] ç»Ÿä¸€Messageå’ŒChatMessageæ¥å£
- [ ] æ‰©å±•ç°æœ‰APIæ”¯æŒé™„ä»¶å‚æ•°
- [ ] è°ƒæ•´ç°æœ‰UIå¸ƒå±€é€‚é…æ–°ç»„ä»¶
- [ ] ç¡®ä¿å‘åå…¼å®¹æ€§

### **ğŸ§ª åŠŸèƒ½æµ‹è¯•æ£€æŸ¥**
- [ ] æµ‹è¯•æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
- [ ] æµ‹è¯•æ–‡ä»¶ç±»å‹å’Œå¤§å°éªŒè¯
- [ ] æµ‹è¯•æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
- [ ] æµ‹è¯•å¤šæ–‡ä»¶æ‰¹é‡ä¸Šä¼ 
- [ ] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

### **ğŸ“Š æ€§èƒ½æµ‹è¯•æ£€æŸ¥**
- [ ] æµ‹è¯•å°æ–‡ä»¶ï¼ˆ<1MBï¼‰ä¸Šä¼ æ€§èƒ½
- [ ] æµ‹è¯•ä¸­ç­‰æ–‡ä»¶ï¼ˆ1-10MBï¼‰ä¸Šä¼ æ€§èƒ½
- [ ] æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼‰ä¸Šä¼ æ€§èƒ½
- [ ] æµ‹è¯•å¤šæ–‡ä»¶å¹¶å‘ä¸Šä¼ æ€§èƒ½
- [ ] æµ‹è¯•å†…å­˜ä½¿ç”¨å’Œæ¸…ç†æƒ…å†µ
- [ ] æµ‹è¯•ç½‘ç»œå¼‚å¸¸æƒ…å†µå¤„ç†

### **ğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥**
- [ ] éªŒè¯å‰ç«¯æ–‡ä»¶ç±»å‹éªŒè¯æœºåˆ¶
- [ ] éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦ç”Ÿæ•ˆ
- [ ] æµ‹è¯•æ¶æ„æ–‡ä»¶ä¸Šä¼ é˜²æŠ¤
- [ ] éªŒè¯æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶
- [ ] æµ‹è¯•æ•æ„Ÿä¿¡æ¯è¿‡æ»¤æœºåˆ¶

### **ğŸ¨ ç”¨æˆ·ä½“éªŒæ£€æŸ¥**
- [ ] éªŒè¯æ‹–æ‹½ä¸Šä¼ äº¤äº’ä½“éªŒ
- [ ] éªŒè¯æ–‡ä»¶é¢„è§ˆç•Œé¢å‹å¥½æ€§
- [ ] æµ‹è¯•é”™è¯¯æç¤ºä¿¡æ¯æ¸…æ™°åº¦
- [ ] éªŒè¯åŠ è½½çŠ¶æ€æ˜¾ç¤ºæ•ˆæœ
- [ ] æµ‹è¯•ç§»åŠ¨ç«¯é€‚é…æ•ˆæœ

### **ğŸ”Œ APIé›†æˆæ£€æŸ¥**
- [ ] å®ç°æ–‡ä»¶ä¸Šä¼ APIæ¥å£
- [ ] é›†æˆå¤šæ¨¡æ€AI APIè°ƒç”¨
- [ ] å®ç°æ–‡ä»¶å­˜å‚¨å’Œè®¿é—®é€»è¾‘
- [ ] é…ç½®æ–‡ä»¶æ¸…ç†å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- [ ] å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### **ğŸ“± å“åº”å¼è®¾è®¡æ£€æŸ¥**
- [ ] æµ‹è¯•æ¡Œé¢ç«¯æ˜¾ç¤ºæ•ˆæœ
- [ ] æµ‹è¯•å¹³æ¿ç«¯æ˜¾ç¤ºæ•ˆæœ
- [ ] æµ‹è¯•æ‰‹æœºç«¯æ˜¾ç¤ºæ•ˆæœ
- [ ] éªŒè¯ä¸åŒå±å¹•å°ºå¯¸é€‚é…
- [ ] æµ‹è¯•è§¦æ‘¸æ“ä½œä½“éªŒ

### **ğŸ§ª é›†æˆæµ‹è¯•æ£€æŸ¥**
- [ ] æµ‹è¯•ä¸ç°æœ‰èŠå¤©åŠŸèƒ½é›†æˆ
- [ ] æµ‹è¯•ä¼šè¯ç®¡ç†å’Œé™„ä»¶å…³è”
- [ ] æµ‹è¯•å¤šæ¨¡æ€AIå“åº”å±•ç¤º
- [ ] æµ‹è¯•é™„ä»¶å†å²è®°å½•åŠŸèƒ½
- [ ] æµ‹è¯•æ•°æ®ä¸€è‡´æ€§

### **ğŸ“ æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥**
- [ ] æ›´æ–°ç»„ä»¶ä½¿ç”¨æ–‡æ¡£
- [ ] æ·»åŠ APIæ¥å£æ–‡æ¡£
- [ ] æ›´æ–°éƒ¨ç½²é…ç½®è¯´æ˜
- [ ] æ·»åŠ æ•…éšœæ’é™¤æŒ‡å—
- [ ] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§

### **ğŸš€ éƒ¨ç½²å‡†å¤‡æ£€æŸ¥**
- [ ] éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®
- [ ] æµ‹è¯•ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶æƒé™
- [ ] éªŒè¯CDNé…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å‡†å¤‡ç›‘æ§å’Œå‘Šè­¦é…ç½®
- [ ] åˆ¶å®šå›æ»šæ–¹æ¡ˆ

---

## ğŸš€ **ç»§ç»­å¼€å‘ï¼šæµ‹è¯•å’Œä¼˜åŒ–æ¨¡å—**

æ¥ä¸‹æ¥å°†ç»§ç»­å¼€å‘æµ‹è¯•å’Œä¼˜åŒ–åŠŸèƒ½ã€‚

---

## ğŸ§ª **ç¬¬ä¸ƒé˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–**

### **7.1 å•å…ƒæµ‹è¯•**

#### **7.1.1 åç«¯APIæµ‹è¯•**
```javascript
// åç«¯APIå•å…ƒæµ‹è¯•
const request = require('supertest');
const app = require('../server');
const { createTestDatabase, cleanupTestDatabase } = require('./testUtils');

describe('é™„ä»¶ä¸Šä¼ APIæµ‹è¯•', () => {
  let testDb;
  
  beforeAll(async () => {
    testDb = await createTestDatabase();
  });
  
  afterAll(async () => {
    await cleanupTestDatabase(testDb);
  });
  
  beforeEach(async () => {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    await testDb.prepare('DELETE FROM attachments').run();
    await testDb.prepare('DELETE FROM messages').run();
  });
  
  describe('POST /api/attachments/upload', () => {
    it('åº”è¯¥æˆåŠŸä¸Šä¼ å•ä¸ªæ–‡ä»¶', async () => {
      const response = await request(app)
        .post('/api/attachments/upload')
        .attach('file', Buffer.from('test content'), 'test.txt')
        .expect(200);
      
      expect(response.body).toHaveProperty('success', true);
      expect(response.body).toHaveProperty('attachmentId');
      expect(response.body).toHaveProperty('url');
    });
    
    it('åº”è¯¥æ‹’ç»è¿‡å¤§çš„æ–‡ä»¶', async () => {
      const largeBuffer = Buffer.alloc(100 * 1024 * 1024); // 100MB
      
      const response = await request(app)
        .post('/api/attachments/upload')
        .attach('file', largeBuffer, 'large.txt')
        .expect(400);
      
      expect(response.body).toHaveProperty('success', false);
      expect(response.body.error).toContain('æ–‡ä»¶è¿‡å¤§');
    });
    
    it('åº”è¯¥æ‹’ç»ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹', async () => {
      const response = await request(app)
        .post('/api/attachments/upload')
        .attach('file', Buffer.from('test'), 'test.exe')
        .expect(400);
      
      expect(response.body).toHaveProperty('success', false);
      expect(response.body.error).toContain('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
    });
    
    it('åº”è¯¥æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ', async () => {
      const response = await request(app)
        .post('/api/attachments/upload')
        .attach('files', Buffer.from('file1'), 'file1.txt')
        .attach('files', Buffer.from('file2'), 'file2.txt')
        .expect(200);
      
      expect(response.body).toHaveProperty('success', true);
      expect(response.body.attachments).toHaveLength(2);
    });
  });
  
  describe('GET /api/attachments/:attachmentId', () => {
    it('åº”è¯¥è¿”å›é™„ä»¶ä¿¡æ¯', async () => {
      // å…ˆä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
      const uploadResponse = await request(app)
        .post('/api/attachments/upload')
        .attach('file', Buffer.from('test content'), 'test.txt');
      
      const attachmentId = uploadResponse.body.attachmentId;
      
      // è·å–é™„ä»¶ä¿¡æ¯
      const response = await request(app)
        .get(`/api/attachments/${attachmentId}`)
        .expect(200);
      
      expect(response.body).toHaveProperty('success', true);
      expect(response.body.attachment).toHaveProperty('id', attachmentId);
      expect(response.body.attachment).toHaveProperty('name', 'test.txt');
    });
    
    it('åº”è¯¥è¿”å›404å¯¹äºä¸å­˜åœ¨çš„é™„ä»¶', async () => {
      const response = await request(app)
        .get('/api/attachments/nonexistent-id')
        .expect(404);
      
      expect(response.body).toHaveProperty('success', false);
    });
  });
  
  describe('DELETE /api/attachments/:attachmentId', () => {
    it('åº”è¯¥æˆåŠŸåˆ é™¤é™„ä»¶', async () => {
      // å…ˆä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
      const uploadResponse = await request(app)
        .post('/api/attachments/upload')
        .attach('file', Buffer.from('test content'), 'test.txt');
      
      const attachmentId = uploadResponse.body.attachmentId;
      
      // åˆ é™¤é™„ä»¶
      const response = await request(app)
        .delete(`/api/attachments/${attachmentId}`)
        .expect(200);
      
      expect(response.body).toHaveProperty('success', true);
      
      // éªŒè¯é™„ä»¶å·²è¢«åˆ é™¤
      const getResponse = await request(app)
        .get(`/api/attachments/${attachmentId}`)
        .expect(404);
    });
  });
});

describe('å¤šæ¨¡æ€AIé›†æˆæµ‹è¯•', () => {
  describe('MultimodalRequestBuilder', () => {
    const { MultimodalRequestBuilder } = require('../src/multimodal/MultimodalRequestBuilder');
    
    it('åº”è¯¥æ­£ç¡®æ„å»ºGeminiè¯·æ±‚', async () => {
      const builder = new MultimodalRequestBuilder();
      const message = 'åˆ†æè¿™å¼ å›¾ç‰‡';
      const attachments = [{
        fileType: 'image',
        filePath: '/path/to/image.jpg',
        mimeType: 'image/jpeg'
      }];
      
      const request = await builder.buildMultimodalRequest('gemini', 'gemini-2.5-flash', message, attachments);
      
      expect(request).toHaveProperty('contents');
      expect(request.contents[0]).toHaveProperty('role', 'user');
      expect(request.contents[0].parts).toHaveLength(2); // æ–‡æœ¬ + å›¾ç‰‡
      expect(request.contents[0].parts[0]).toHaveProperty('text', message);
      expect(request.contents[0].parts[1]).toHaveProperty('inlineData');
    });
    
    it('åº”è¯¥æ­£ç¡®æ„å»ºGPTè¯·æ±‚', async () => {
      const builder = new MultimodalRequestBuilder();
      const message = 'åˆ†æè¿™ä¸ªæ–‡æ¡£';
      const attachments = [{
        fileType: 'document',
        filePath: '/path/to/document.pdf',
        mimeType: 'application/pdf'
      }];
      
      const request = await builder.buildMultimodalRequest('gpt', 'gpt-4o', message, attachments);
      
      expect(request).toHaveProperty('model', 'gpt-4o');
      expect(request.messages[0]).toHaveProperty('role', 'user');
      expect(request.messages[0].content).toHaveLength(2); // æ–‡æœ¬ + æ–‡æ¡£
    });
  });
  
  describe('MultimodalAICaller', () => {
    const { MultimodalAICaller } = require('../src/multimodal/MultimodalAICaller');
    
    it('åº”è¯¥æ­£ç¡®è°ƒç”¨Gemini API', async () => {
      const caller = new MultimodalAICaller();
      
      // Mock fetch
      global.fetch = jest.fn(() =>
        Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            candidates: [{
              content: {
                parts: [{ text: 'è¿™æ˜¯å¯¹å›¾ç‰‡çš„åˆ†æç»“æœ' }]
              },
              finishReason: 'STOP'
            }],
            usageMetadata: { totalTokenCount: 100 }
          })
        })
      );
      
      const response = await caller.callMultimodalAI(
        'gemini',
        'gemini-2.5-flash',
        'åˆ†æå›¾ç‰‡',
        []
      );
      
      expect(response).toHaveProperty('content', 'è¿™æ˜¯å¯¹å›¾ç‰‡çš„åˆ†æç»“æœ');
      expect(response).toHaveProperty('model', 'gemini');
    });
  });
});
```

---


#### **7.1.2 å‰ç«¯ç»„ä»¶æµ‹è¯•**
```typescript
// å‰ç«¯ç»„ä»¶å•å…ƒæµ‹è¯•
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { FileUpload } from '../components/FileUpload';
import { FilePreview } from '../components/FilePreview';
import { ChatInterface } from '../components/ChatInterface';

// Mock lucide-react icons
jest.mock('lucide-react', () => ({
  Upload: () => <div data-testid="upload-icon">Upload</div>,
  FileText: () => <div data-testid="file-text-icon">FileText</div>,
  Image: () => <div data-testid="image-icon">Image</div>,
  Video: () => <div data-testid="video-icon">Video</div>,
  Music: () => <div data-testid="music-icon">Music</div>,
  File: () => <div data-testid="file-icon">File</div>,
  Send: () => <div data-testid="send-icon">Send</div>,
  Paperclip: () => <div data-testid="paperclip-icon">Paperclip</div>,
  X: () => <div data-testid="x-icon">X</div>,
  Eye: () => <div data-testid="eye-icon">Eye</div>,
  Download: () => <div data-testid="download-icon">Download</div>
}));

describe('FileUploadç»„ä»¶æµ‹è¯•', () => {
  const mockOnFilesSelected = jest.fn();
  
  beforeEach(() => {
    mockOnFilesSelected.mockClear();
  });
  
  it('åº”è¯¥æ¸²æŸ“æ‹–æ‹½åŒºåŸŸ', () => {
    render(<FileUpload onFilesSelected={mockOnFilesSelected} />);
    
    expect(screen.getByText('æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶')).toBeInTheDocument();
    expect(screen.getByText(/æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æ¡£ç­‰æ ¼å¼/)).toBeInTheDocument();
  });
  
  it('åº”è¯¥å¤„ç†æ–‡ä»¶é€‰æ‹©', async () => {
    render(<FileUpload onFilesSelected={mockOnFilesSelected} />);
    
    const file = new File(['test content'], 'test.txt', { type: 'text/plain' });
    const input = screen.getByRole('button');
    
    fireEvent.click(input);
    
    // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
    const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
    if (fileInput) {
      fireEvent.change(fileInput, { target: { files: [file] } });
    }
    
    await waitFor(() => {
      expect(mockOnFilesSelected).toHaveBeenCalledWith([file]);
    });
  });
  
  it('åº”è¯¥éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶', async () => {
    render(<FileUpload onFilesSelected={mockOnFilesSelected} maxFileSize={1024} />);
    
    const largeFile = new File(['x'.repeat(2048)], 'large.txt', { type: 'text/plain' });
    const input = screen.getByRole('button');
    
    fireEvent.click(input);
    
    const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
    if (fileInput) {
      fireEvent.change(fileInput, { target: { files: [largeFile] } });
    }
    
    await waitFor(() => {
      expect(mockOnFilesSelected).not.toHaveBeenCalled();
    });
  });
  
  it('åº”è¯¥éªŒè¯æ–‡ä»¶ç±»å‹', async () => {
    render(<FileUpload onFilesSelected={mockOnFilesSelected} acceptedTypes={['image/*']} />);
    
    const textFile = new File(['test'], 'test.txt', { type: 'text/plain' });
    const input = screen.getByRole('button');
    
    fireEvent.click(input);
    
    const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
    if (fileInput) {
      fireEvent.change(fileInput, { target: { files: [textFile] } });
    }
    
    await waitFor(() => {
      expect(mockOnFilesSelected).not.toHaveBeenCalled();
    });
  });
});

describe('FilePreviewç»„ä»¶æµ‹è¯•', () => {
  const mockFile = {
    id: '1',
    name: 'test.jpg',
    type: 'image/jpeg',
    size: 1024,
    url: 'http://example.com/test.jpg'
  };
  
  it('åº”è¯¥æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯', () => {
    render(<FilePreview file={mockFile} />);
    
    expect(screen.getByText('test.jpg')).toBeInTheDocument();
    expect(screen.getByText('1 KB')).toBeInTheDocument();
    expect(screen.getByText('image/jpeg')).toBeInTheDocument();
  });
  
  it('åº”è¯¥æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ', () => {
    render(<FilePreview file={mockFile} />);
    
    const img = screen.getByAltText('test.jpg');
    expect(img).toBeInTheDocument();
    expect(img).toHaveAttribute('src', 'http://example.com/test.jpg');
  });
  
  it('åº”è¯¥å¤„ç†åˆ é™¤æ“ä½œ', () => {
    const mockOnRemove = jest.fn();
    render(<FilePreview file={mockFile} onRemove={mockOnRemove} />);
    
    const removeButton = screen.getByTitle('åˆ é™¤');
    fireEvent.click(removeButton);
    
    expect(mockOnRemove).toHaveBeenCalledWith('1');
  });
});

describe('ChatInterfaceç»„ä»¶æµ‹è¯•', () => {
  const mockMessages = [
    {
      id: '1',
      role: 'user' as const,
      content: 'ä½ å¥½',
      timestamp: new Date(),
      attachments: []
    },
    {
      id: '2',
      role: 'assistant' as const,
      content: 'ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ',
      timestamp: new Date(),
      attachments: []
    }
  ];
  
  const mockOnSendMessage = jest.fn();
  
  beforeEach(() => {
    mockOnSendMessage.mockClear();
  });
  
  it('åº”è¯¥æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨', () => {
    render(
      <ChatInterface
        messages={mockMessages}
        onSendMessage={mockOnSendMessage}
      />
    );
    
    expect(screen.getByText('ä½ å¥½')).toBeInTheDocument();
    expect(screen.getByText('ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ')).toBeInTheDocument();
  });
  
  it('åº”è¯¥å¤„ç†æ¶ˆæ¯å‘é€', async () => {
    render(
      <ChatInterface
        messages={mockMessages}
        onSendMessage={mockOnSendMessage}
      />
    );
    
    const input = screen.getByPlaceholderText('è¾“å…¥æ¶ˆæ¯...');
    const sendButton = screen.getByTitle('å‘é€æ¶ˆæ¯');
    
    fireEvent.change(input, { target: { value: 'æµ‹è¯•æ¶ˆæ¯' } });
    fireEvent.click(sendButton);
    
    await waitFor(() => {
      expect(mockOnSendMessage).toHaveBeenCalledWith('æµ‹è¯•æ¶ˆæ¯', []);
    });
  });
  
  it('åº”è¯¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ', async () => {
    render(
      <ChatInterface
        messages={mockMessages}
        onSendMessage={mockOnSendMessage}
      />
    );
    
    const fileButton = screen.getByTitle('æ·»åŠ é™„ä»¶');
    fireEvent.click(fileButton);
    
    expect(screen.getByText('æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶')).toBeInTheDocument();
  });
});
```



### **7.2 é›†æˆæµ‹è¯•**

#### **7.2.1 é›†æˆæµ‹è¯•ï¼ˆæ¸è¿›å¼å®æ–½ï¼‰**

##### **ç¬¬ä¸€é˜¶æ®µï¼šAPIé›†æˆæµ‹è¯•ï¼ˆå½“å‰å®ç°ï¼‰**
```javascript
// ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€APIé›†æˆæµ‹è¯•
const request = require('supertest');
const app = require('../server');
const path = require('path');
const fs = require('fs');

describe('é™„ä»¶ä¸Šä¼ å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•', () => {
  let testDb;
  let testFilePath;
  
  beforeAll(async () => {
    // åˆ›å»ºæµ‹è¯•æ•°æ®åº“
    testDb = await createTestDatabase();
    
    // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    testFilePath = path.join(__dirname, 'fixtures', 'test-image.jpg');
    if (!fs.existsSync(testFilePath)) {
      // åˆ›å»ºç®€å•çš„æµ‹è¯•æ–‡ä»¶
      fs.writeFileSync(testFilePath, Buffer.from('fake image data'));
    }
  });
  
  afterAll(async () => {
    await cleanupTestDatabase(testDb);
    if (fs.existsSync(testFilePath)) {
      fs.unlinkSync(testFilePath);
    }
  });
  
  it('åº”è¯¥å®Œæˆæ–‡ä»¶ä¸Šä¼ åˆ°AIåˆ†æçš„å®Œæ•´æµç¨‹', async () => {
    // 1. ä¸Šä¼ æ–‡ä»¶
    const uploadResponse = await request(app)
      .post('/api/attachments/upload')
      .attach('file', testFilePath)
      .expect(200);
    
    expect(uploadResponse.body).toHaveProperty('success', true);
    expect(uploadResponse.body).toHaveProperty('attachmentId');
    
    // 2. å‘é€å¸¦é™„ä»¶çš„èŠå¤©æ¶ˆæ¯
    const chatResponse = await request(app)
      .post('/api/chat')
      .send({
        message: 'åˆ†æè¿™ä¸ªå›¾ç‰‡',
        attachments: [uploadResponse.body.attachmentId],
        model: 'gemini'
      })
      .expect(200);
    
    expect(chatResponse.body).toHaveProperty('success', true);
    expect(chatResponse.body).toHaveProperty('response');
    
    // 3. éªŒè¯æ•°æ®åº“è®°å½•
    const attachmentRecord = await testDb.get(
      'SELECT * FROM attachments WHERE id = ?',
      uploadResponse.body.attachmentId
    );
    expect(attachmentRecord).toBeTruthy();
    expect(attachmentRecord.file_name).toBe('test-image.jpg');
  });
  
  it('åº”è¯¥æ­£ç¡®å¤„ç†å¤šæ–‡ä»¶ä¸Šä¼ ', async () => {
    // åˆ›å»ºå¤šä¸ªæµ‹è¯•æ–‡ä»¶
    const file1Response = await request(app)
      .post('/api/attachments/upload')
      .attach('file', Buffer.from('file 1 content'), 'file1.txt')
      .expect(200);
    
    const file2Response = await request(app)
      .post('/api/attachments/upload')
      .attach('file', Buffer.from('file 2 content'), 'file2.txt')
      .expect(200);
    
    // å‘é€åŒ…å«å¤šä¸ªé™„ä»¶çš„æ¶ˆæ¯
    const chatResponse = await request(app)
      .post('/api/chat')
      .send({
        message: 'åˆ†æè¿™äº›æ–‡ä»¶',
        attachments: [
          file1Response.body.attachmentId,
          file2Response.body.attachmentId
        ],
        model: 'gpt'
      })
      .expect(200);
    
    expect(chatResponse.body).toHaveProperty('success', true);
  });
});
```

##### **ç¬¬äºŒé˜¶æ®µï¼šç«¯åˆ°ç«¯æµè§ˆå™¨æµ‹è¯•ï¼ˆæœªæ¥å®ç°ï¼‰**
```javascript
// ç¬¬äºŒé˜¶æ®µï¼šPuppeteerç«¯åˆ°ç«¯æµ‹è¯•
// âš ï¸ è®¡åˆ’åŠŸèƒ½ï¼Œå½“éœ€è¦å®Œæ•´UIæµ‹è¯•æ—¶å®æ–½

/*
const puppeteer = require('puppeteer');

describe('é™„ä»¶ä¸Šä¼ UIç«¯åˆ°ç«¯æµ‹è¯•', () => {
  let browser;
  let page;
  
  beforeAll(async () => {
    browser = await puppeteer.launch({
      headless: 'new',
      args: ['--no-sandbox']
    });
  });
  
  afterAll(async () => {
    await browser.close();
  });
  
  it('åº”è¯¥å®Œæˆå®Œæ•´çš„UIæ“ä½œæµç¨‹', async () => {
    page = await browser.newPage();
    await page.goto('http://localhost:3000');
    
    // UIäº¤äº’æµ‹è¯•é€»è¾‘...
    // æ–‡ä»¶æ‹–æ‹½ã€è¿›åº¦æ˜¾ç¤ºã€AIå“åº”ç­‰
  });
});
*/
```

#### **7.2.2 APIé›†æˆæµ‹è¯•**
```javascript
// APIé›†æˆæµ‹è¯•
const request = require('supertest');
const app = require('../server');
const { createTestDatabase, cleanupTestDatabase } = require('./testUtils');
const { MultimodalAICaller } = require('../src/multimodal/MultimodalAICaller');

describe('å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•', () => {
  let testDb;
  let aiCaller;
  
  beforeAll(async () => {
    testDb = await createTestDatabase();
    aiCaller = new MultimodalAICaller();
  });
  
  afterAll(async () => {
    await cleanupTestDatabase(testDb);
  });
  
  beforeEach(async () => {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    await testDb.prepare('DELETE FROM attachments').run();
    await testDb.prepare('DELETE FROM messages').run();
    await testDb.prepare('DELETE FROM sessions').run();
  });
  
  it('åº”è¯¥å®Œæˆå®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ åˆ°AIåˆ†ææµç¨‹', async () => {
    // 1. åˆ›å»ºä¼šè¯
    const sessionResponse = await request(app)
      .post('/api/sessions')
      .send({ name: 'æµ‹è¯•ä¼šè¯' })
      .expect(200);
    
    const sessionId = sessionResponse.body.sessionId;
    
    // 2. ä¸Šä¼ æ–‡ä»¶
    const uploadResponse = await request(app)
      .post('/api/attachments/upload')
      .attach('file', Buffer.from('test image content'), 'test.jpg')
      .field('sessionId', sessionId)
      .expect(200);
    
    const attachmentId = uploadResponse.body.attachmentId;
    
    // 3. éªŒè¯æ–‡ä»¶ä¿¡æ¯
    const fileInfoResponse = await request(app)
      .get(`/api/attachments/${attachmentId}`)
      .expect(200);
    
    expect(fileInfoResponse.body.attachment).toHaveProperty('id', attachmentId);
    expect(fileInfoResponse.body.attachment).toHaveProperty('sessionId', sessionId);
    
    // 4. å‘é€å¤šæ¨¡æ€æ¶ˆæ¯
    const messageResponse = await request(app)
      .post('/api/chat/send')
      .send({
        sessionId,
        message: 'åˆ†æè¿™å¼ å›¾ç‰‡',
        attachmentIds: [attachmentId],
        modelType: 'gemini',
        modelVariant: 'gemini-2.5-flash'
      })
      .expect(200);
    
    expect(messageResponse.body).toHaveProperty('success', true);
    expect(messageResponse.body).toHaveProperty('messageId');
    
    // 5. éªŒè¯æ¶ˆæ¯è®°å½•
    const messagesResponse = await request(app)
      .get(`/api/sessions/${sessionId}/messages`)
      .expect(200);
    
    expect(messagesResponse.body.messages).toHaveLength(2); // ç”¨æˆ·æ¶ˆæ¯ + AIå“åº”
    expect(messagesResponse.body.messages[0]).toHaveProperty('hasAttachments', true);
    expect(messagesResponse.body.messages[0].attachmentIds).toContain(attachmentId);
  });
  
  it('åº”è¯¥å¤„ç†æ‰¹é‡æ–‡ä»¶ä¸Šä¼ å’ŒAIåˆ†æ', async () => {
    // 1. åˆ›å»ºä¼šè¯
    const sessionResponse = await request(app)
      .post('/api/sessions')
      .send({ name: 'æ‰¹é‡æµ‹è¯•ä¼šè¯' })
      .expect(200);
    
    const sessionId = sessionResponse.body.sessionId;
    
    // 2. æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
    const uploadResponse = await request(app)
      .post('/api/attachments/upload')
      .attach('files', Buffer.from('file1 content'), 'file1.txt')
      .attach('files', Buffer.from('file2 content'), 'file2.txt')
      .field('sessionId', sessionId)
      .expect(200);
    
    expect(uploadResponse.body.attachments).toHaveLength(2);
    const attachmentIds = uploadResponse.body.attachments.map(a => a.attachmentId);
    
    // 3. å‘é€åŒ…å«å¤šä¸ªé™„ä»¶çš„æ¶ˆæ¯
    const messageResponse = await request(app)
      .post('/api/chat/send')
      .send({
        sessionId,
        message: 'åˆ†æè¿™äº›æ–‡æ¡£',
        attachmentIds,
        modelType: 'gpt',
        modelVariant: 'gpt-4o'
      })
      .expect(200);
    
    expect(messageResponse.body).toHaveProperty('success', true);
    
    // 4. éªŒè¯é™„ä»¶å…³è”
    const attachmentsResponse = await request(app)
      .get(`/api/sessions/${sessionId}/attachments`)
      .expect(200);
    
    expect(attachmentsResponse.body.attachments).toHaveLength(2);
    expect(attachmentsResponse.body.attachments.every(a => a.sessionId === sessionId)).toBe(true);
  });
  
  it('åº”è¯¥å¤„ç†æ–‡ä»¶åˆ é™¤å’Œæ¸…ç†', async () => {
    // 1. ä¸Šä¼ æ–‡ä»¶
    const uploadResponse = await request(app)
      .post('/api/attachments/upload')
      .attach('file', Buffer.from('test content'), 'test.txt')
      .expect(200);
    
    const attachmentId = uploadResponse.body.attachmentId;
    
    // 2. éªŒè¯æ–‡ä»¶å­˜åœ¨
    await request(app)
      .get(`/api/attachments/${attachmentId}`)
      .expect(200);
    
    // 3. åˆ é™¤æ–‡ä»¶
    const deleteResponse = await request(app)
      .delete(`/api/attachments/${attachmentId}`)
      .expect(200);
    
    expect(deleteResponse.body).toHaveProperty('success', true);
    
    // 4. éªŒè¯æ–‡ä»¶å·²è¢«åˆ é™¤
    await request(app)
      .get(`/api/attachments/${attachmentId}`)
      .expect(404);
  });
  
  it('åº”è¯¥å¤„ç†é”™è¯¯æƒ…å†µå’Œå¼‚å¸¸æ¢å¤', async () => {
    // 1. æµ‹è¯•æ— æ•ˆçš„ä¼šè¯ID
    const invalidSessionResponse = await request(app)
      .post('/api/chat/send')
      .send({
        sessionId: 'invalid-session-id',
        message: 'æµ‹è¯•æ¶ˆæ¯',
        modelType: 'gemini',
        modelVariant: 'gemini-2.5-flash'
      })
      .expect(400);
    
    expect(invalidSessionResponse.body).toHaveProperty('success', false);
    expect(invalidSessionResponse.body.error).toContain('ä¼šè¯ä¸å­˜åœ¨');
    
    // 2. æµ‹è¯•æ— æ•ˆçš„æ¨¡å‹ç±»å‹
    const invalidModelResponse = await request(app)
      .post('/api/chat/send')
      .send({
        sessionId: 'test-session',
        message: 'æµ‹è¯•æ¶ˆæ¯',
        modelType: 'invalid-model',
        modelVariant: 'invalid-variant'
      })
      .expect(400);
    
    expect(invalidModelResponse.body).toHaveProperty('success', false);
    expect(invalidModelResponse.body.error).toContain('ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹');
    
    // 3. æµ‹è¯•æ–‡ä»¶å¤§å°è¶…é™
    const largeFile = Buffer.alloc(100 * 1024 * 1024); // 100MB
    const largeFileResponse = await request(app)
      .post('/api/attachments/upload')
      .attach('file', largeFile, 'large.txt')
      .expect(400);
    
    expect(largeFileResponse.body).toHaveProperty('success', false);
    expect(largeFileResponse.body.error).toContain('æ–‡ä»¶è¿‡å¤§');
  });
});
```


### **æµ‹è¯•å’Œä¼˜åŒ–æ¨¡å—äº®ç‚¹ï¼ˆå·²å®Œæˆéƒ¨åˆ†ï¼‰**
1. **å®Œæ•´çš„åç«¯APIæµ‹è¯•**: è¦†ç›–æ–‡ä»¶ä¸Šä¼ ã€è·å–ã€åˆ é™¤ç­‰æ ¸å¿ƒåŠŸèƒ½
2. **å®Œæ•´çš„å‰ç«¯ç»„ä»¶æµ‹è¯•**: è¦†ç›–æ‰€æœ‰Reactç»„ä»¶çš„åŠŸèƒ½éªŒè¯
3. **å®Œæ•´çš„é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•å’ŒAPIé›†æˆæµ‹è¯•
4. **å¤šæ¨¡æ€AIæµ‹è¯•**: éªŒè¯Geminiã€GPTè¯·æ±‚æ„å»ºå’ŒAPIè°ƒç”¨
5. **æµ‹è¯•æ•°æ®ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†æµ‹è¯•æ•°æ®åº“
6. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: æ–‡ä»¶å¤§å°é™åˆ¶ã€ç±»å‹éªŒè¯ç­‰é”™è¯¯æƒ…å†µ
7. **ç”¨æˆ·äº¤äº’æµ‹è¯•**: æ–‡ä»¶ä¸Šä¼ ã€æ¶ˆæ¯å‘é€ç­‰ç”¨æˆ·æ“ä½œéªŒè¯
8. **å®Œæ•´æµç¨‹æµ‹è¯•**: ä»æ–‡ä»¶ä¸Šä¼ åˆ°AIåˆ†æçš„å®Œæ•´ä¸šåŠ¡æµç¨‹


### **7.3 æ€§èƒ½ä¼˜åŒ–**

#### **7.3.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–**
```typescript
// å‰ç«¯æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
import { useMemo, useCallback, useRef, useEffect, useState } from 'react';

// å›¾ç‰‡æ‡’åŠ è½½Hook
export const useImageLazyLoading = (src: string, threshold: number = 0.1) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const [isInView, setIsInView] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsInView(true);
          observer.disconnect();
        }
      },
      { threshold }
    );
    
    if (imgRef.current) {
      observer.observe(imgRef.current);
    }
    
    return () => observer.disconnect();
  }, [threshold]);
  
  useEffect(() => {
    if (isInView && src) {
      const img = new Image();
      img.onload = () => setIsLoaded(true);
      img.src = src;
    }
  }, [isInView, src]);
  
  return { imgRef, isLoaded, isInView };
};

// è™šæ‹Ÿæ»šåŠ¨Hook
export const useVirtualScroll = <T>(
  items: T[],
  itemHeight: number,
  containerHeight: number
) => {
  const [scrollTop, setScrollTop] = useState(0);
  
  const visibleItems = useMemo(() => {
    const startIndex = Math.floor(scrollTop / itemHeight);
    const endIndex = Math.min(
      startIndex + Math.ceil(containerHeight / itemHeight) + 1,
      items.length
    );
    
    return items.slice(startIndex, endIndex).map((item, index) => ({
      item,
      index: startIndex + index,
      top: (startIndex + index) * itemHeight
    }));
  }, [items, itemHeight, containerHeight, scrollTop]);
  
  const totalHeight = items.length * itemHeight;
  
  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {
    setScrollTop(e.currentTarget.scrollTop);
  }, []);
  
  return {
    visibleItems,
    totalHeight,
    handleScroll
  };
};

// é˜²æŠ–Hook
export const useDebounce = <T>(value: T, delay: number): T => {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);
  
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);
  
  return debouncedValue;
};

// èŠ‚æµHook
export const useThrottle = <T extends (...args: any[]) => any>(
  callback: T,
  delay: number
): T => {
  const lastRun = useRef<number>(0);
  
  return useCallback(
    (...args: Parameters<T>) => {
      const now = Date.now();
      
      if (now - lastRun.current >= delay) {
        lastRun.current = now;
        callback(...args);
      }
    },
    [callback, delay]
  ) as T;
};

// æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–
export const useOptimizedFileUpload = () => {
  const [uploadQueue, setUploadQueue] = useState<Array<{
    id: string;
    file: File;
    progress: number;
    status: 'pending' | 'uploading' | 'completed' | 'error';
  }>>([]);
  
  const uploadFile = useCallback(async (file: File) => {
    const id = uuidv4();
    
    // æ·»åŠ åˆ°é˜Ÿåˆ—
    setUploadQueue(prev => [...prev, {
      id,
      file,
      progress: 0,
      status: 'pending'
    }]);
    
    try {
      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
      if (file.size > 5 * 1024 * 1024) { // 5MB
        await uploadFileInChunks(file, id);
      } else {
        await uploadFileDirectly(file, id);
      }
      
      // æ›´æ–°çŠ¶æ€ä¸ºå®Œæˆ
      setUploadQueue(prev => 
        prev.map(item => 
          item.id === id ? { ...item, status: 'completed', progress: 100 } : item
        )
      );
      
    } catch (error) {
      // æ›´æ–°çŠ¶æ€ä¸ºé”™è¯¯
      setUploadQueue(prev => 
        prev.map(item => 
          item.id === id ? { ...item, status: 'error' } : item
        )
      );
      
      throw error;
    }
  }, []);
  
  const uploadFileInChunks = async (file: File, id: string) => {
    const chunkSize = 1024 * 1024; // 1MB chunks
    const chunks = Math.ceil(file.size / chunkSize);
    
    for (let i = 0; i < chunks; i++) {
      const start = i * chunkSize;
      const end = Math.min(start + chunkSize, file.size);
      const chunk = file.slice(start, end);
      
      // ä¸Šä¼ åˆ†ç‰‡
      await uploadChunk(chunk, i, chunks, id);
      
      // æ›´æ–°è¿›åº¦
      const progress = ((i + 1) / chunks) * 100;
      setUploadQueue(prev => 
        prev.map(item => 
          item.id === id ? { ...item, progress } : item
        )
      );
    }
  };
  
  const uploadChunk = async (chunk: Blob, index: number, total: number, id: string) => {
    const formData = new FormData();
    formData.append('chunk', chunk);
    formData.append('index', index.toString());
    formData.append('total', total.toString());
    formData.append('fileId', id);
    
    const response = await fetch('/api/attachments/upload-chunk', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('åˆ†ç‰‡ä¸Šä¼ å¤±è´¥');
    }
  };
  
  const uploadFileDirectly = async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/attachments/upload', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
    }
  };
  
  return {
    uploadQueue,
    uploadFile
  };
};
```

#### **7.3.2 åç«¯æ€§èƒ½ä¼˜åŒ–ï¼ˆæ¸è¿›å¼å®æ–½ï¼‰**

##### **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ€§èƒ½ä¼˜åŒ–ï¼ˆå½“å‰å®ç°ï¼‰**
```javascript
// ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ˆéœ€è¦åœ¨ç¬¬ä¸€é˜¶æ®µå®‰è£…ç›¸å…³ä¾èµ–ï¼‰
const express = require('express');                    // é¡¹ç›®å·²æœ‰
const compression = require('compression');            // v1.7.4
const rateLimit = require('express-rate-limit');       // v6.10.0

const app = express();

// 1. åŸºç¡€å‹ç¼©ä¸­é—´ä»¶
app.use(compression({
  level: 6,
  threshold: 1024,
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  }
}));

// 2. ç®€å•é™æµï¼ˆåŸºäºå†…å­˜ï¼‰
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // é™åˆ¶æ¯ä¸ªIP 100æ¬¡è¯·æ±‚
  message: {
    success: false,
    error: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
  },
  standardHeaders: true,
  legacyHeaders: false
});
app.use('/api/', limiter);

// 3. æ–‡ä»¶å¤§å°é™åˆ¶
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));

// 4. é™æ€æ–‡ä»¶ç¼“å­˜
app.use('/uploads', express.static('uploads', {
  maxAge: '1h',
  etag: true,
  lastModified: true
}));

// 5. ç®€å•çš„å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage()
  });
});
```

##### **ç¬¬äºŒé˜¶æ®µï¼šä¸­çº§æ€§èƒ½ä¼˜åŒ–ï¼ˆæœªæ¥å®ç°ï¼‰**
```javascript
// ç¬¬äºŒé˜¶æ®µï¼šRedisç¼“å­˜ + æ›´æ™ºèƒ½çš„é™æµ
// âš ï¸ è®¡åˆ’åŠŸèƒ½ï¼Œå½“å¹¶å‘ç”¨æˆ· > 100 æ—¶å®æ–½

/*
const Redis = require('ioredis');
const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379
});

// Redisç¼“å­˜ä¸­é—´ä»¶
const redisCacheMiddleware = (duration = 300) => {
  return async (req, res, next) => {
    const key = `cache:${req.originalUrl}`;
    try {
      const cached = await redis.get(key);
      if (cached) {
        return res.json(JSON.parse(cached));
      }
      // ç¼“å­˜é€»è¾‘...
      next();
    } catch (error) {
      console.error('ç¼“å­˜é”™è¯¯:', error);
      next();
    }
  };
};
*/
```

##### **ç¬¬ä¸‰é˜¶æ®µï¼šä¼ä¸šçº§æ€§èƒ½ä¼˜åŒ–ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰**
```javascript
// ç¬¬ä¸‰é˜¶æ®µï¼šé›†ç¾¤éƒ¨ç½² + é«˜çº§ç¼“å­˜ç­–ç•¥
// âš ï¸ è®¡åˆ’åŠŸèƒ½ï¼Œå½“å¹¶å‘ç”¨æˆ· > 1000 æ—¶å®æ–½

/*
const cluster = require('cluster');
const os = require('os');

if (cluster.isMaster) {
  const numCPUs = os.cpus().length;
  console.log(`å¯åŠ¨ ${numCPUs} ä¸ªå·¥ä½œè¿›ç¨‹...`);
  
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
  
  cluster.on('exit', (worker) => {
    console.log(`å·¥ä½œè¿›ç¨‹ ${worker.process.pid} å·²é€€å‡º`);
    cluster.fork();
  });
} else {
  // å·¥ä½œè¿›ç¨‹ä»£ç 
  startServer();
}
*/
```
  
  // è¿æ¥æ± ä¼˜åŒ–
  const { createPool } = require('generic-pool');
  
  const dbPool = createPool({
    create: () => {
      return new Promise((resolve, reject) => {
        const db = new Database(process.env.DATABASE_PATH);
        resolve(db);
      });
    },
    destroy: (db) => {
      return new Promise((resolve) => {
        db.close();
        resolve();
      });
    }
  }, {
    max: 10, // æœ€å¤§è¿æ¥æ•°
    min: 2,  // æœ€å°è¿æ¥æ•°
    acquireTimeoutMillis: 30000, // è·å–è¿æ¥è¶…æ—¶
    createTimeoutMillis: 30000,  // åˆ›å»ºè¿æ¥è¶…æ—¶
    destroyTimeoutMillis: 5000,  // é”€æ¯è¿æ¥è¶…æ—¶
    idleTimeoutMillis: 30000,    // ç©ºé—²è¶…æ—¶
    reapIntervalMillis: 1000,    // æ¸…ç†é—´éš”
    createRetryIntervalMillis: 200 // é‡è¯•é—´éš”
  });
  
  // æ–‡ä»¶å¤„ç†ä¼˜åŒ–
  const sharp = require('sharp');
  const { pipeline } = require('stream/promises');
  
  // å›¾ç‰‡å¤„ç†ä¼˜åŒ–
  class OptimizedImageProcessor {
    constructor() {
      this.cache = new Map();
      this.processingQueue = new Map();
    }
    
    async processImage(filePath, options = {}) {
      const cacheKey = `${filePath}_${JSON.stringify(options)}`;
      
      // æ£€æŸ¥ç¼“å­˜
      if (this.cache.has(cacheKey)) {
        return this.cache.get(cacheKey);
      }
      
      // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†
      if (this.processingQueue.has(cacheKey)) {
        return this.processingQueue.get(cacheKey);
      }
      
      // åˆ›å»ºå¤„ç†Promise
      const processPromise = this.processImageInternal(filePath, options);
      this.processingQueue.set(cacheKey, processPromise);
      
      try {
        const result = await processPromise;
        this.cache.set(cacheKey, result);
        return result;
      } finally {
        this.processingQueue.delete(cacheKey);
      }
    }
    
    async processImageInternal(filePath, options) {
      const {
        width = 800,
        height = 600,
        quality = 80,
        format = 'webp'
      } = options;
      
      const image = sharp(filePath);
      
      // è·å–å›¾ç‰‡ä¿¡æ¯
      const metadata = await image.metadata();
      
      // è®¡ç®—æœ€ä½³å°ºå¯¸
      const { width: finalWidth, height: finalHeight } = this.calculateOptimalSize(
        metadata.width,
        metadata.height,
        width,
        height
      );
      
      // å¤„ç†å›¾ç‰‡
      const processedBuffer = await image
        .resize(finalWidth, finalHeight, {
          fit: 'inside',
          withoutEnlargement: true
        })
        .webp({ quality })
        .toBuffer();
      
      return {
        buffer: processedBuffer,
        width: finalWidth,
        height: finalHeight,
        format,
        size: processedBuffer.length
      };
    }
    
    calculateOptimalSize(originalWidth, originalHeight, maxWidth, maxHeight) {
      const ratio = Math.min(maxWidth / originalWidth, maxHeight / originalHeight);
      
      if (ratio >= 1) {
        return { width: originalWidth, height: originalHeight };
      }
      
      return {
        width: Math.round(originalWidth * ratio),
        height: Math.round(originalHeight * ratio)
      };
    }
  }
  
  // æ‰¹é‡å¤„ç†ä¼˜åŒ–
  class BatchProcessor {
    constructor(concurrency = 5) {
      this.concurrency = concurrency;
      this.queue = [];
      this.running = 0;
    }
    
    async add(task) {
      return new Promise((resolve, reject) => {
        this.queue.push({ task, resolve, reject });
        this.process();
      });
    }
    
    async process() {
      if (this.running >= this.concurrency || this.queue.length === 0) {
        return;
      }
      
      this.running++;
      const { task, resolve, reject } = this.queue.shift();
      
      try {
        const result = await task();
        resolve(result);
      } catch (error) {
        reject(error);
      } finally {
        this.running--;
        this.process();
      }
    }
    
    async waitForAll() {
      while (this.queue.length > 0 || this.running > 0) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }
  }
  
  // å¯åŠ¨æœåŠ¡å™¨
  const app = require('./app');
  const port = process.env.PORT || 3000;
  
  app.listen(port, () => {
    console.log(`å·¥ä½œè¿›ç¨‹ ${process.pid} æ­£åœ¨ç›‘å¬ç«¯å£ ${port}`);
  });
}
```


---

## âš ï¸ **ç¬¬ä¸ƒé˜¶æ®µï¼šéœ€è¦ç¡®è®¤çš„å…³é”®é—®é¢˜**

### **ğŸ§ª æµ‹è¯•ç­–ç•¥é€‰æ‹©**
#### **1.1 æµ‹è¯•å¤æ‚åº¦é€‰æ‹©**
- [ ] **å•å…ƒæµ‹è¯•èŒƒå›´**ï¼šæ˜¯å¦éœ€è¦è¦†ç›–æ‰€æœ‰å·¥å…·å‡½æ•°å’Œä¸­é—´ä»¶ï¼Ÿ
- [ ] **é›†æˆæµ‹è¯•æ·±åº¦**ï¼šæ˜¯å¦éœ€è¦ç«¯åˆ°ç«¯æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆPuppeteerï¼‰ï¼Ÿ
- [ ] **æµ‹è¯•ç¯å¢ƒé…ç½®**ï¼šæ˜¯å¦éœ€è¦ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“å’Œæµ‹è¯•ç¯å¢ƒï¼Ÿ
- [ ] **æµ‹è¯•æ•°æ®ç®¡ç†**ï¼šå¦‚ä½•ç®¡ç†æµ‹è¯•ç”¨çš„æ–‡ä»¶å’Œæ•°æ®ï¼Ÿ
- [ ] **æŒç»­é›†æˆ**ï¼šæ˜¯å¦éœ€è¦é…ç½®CI/CDç®¡é“è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Ÿ

#### **1.2 æµ‹è¯•å·¥å…·é€‰æ‹©**
- [ ] **å‰ç«¯æµ‹è¯•æ¡†æ¶**ï¼šJest + React Testing Libraryæ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] **åç«¯æµ‹è¯•æ¡†æ¶**ï¼šsupertest + Jestæ˜¯å¦è¶³å¤Ÿï¼Ÿ
- [ ] **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šæ˜¯å¦çœŸçš„éœ€è¦Puppeteerï¼Œè¿˜æ˜¯ç®€å•çš„APIæµ‹è¯•å³å¯ï¼Ÿ
- [ ] **æ€§èƒ½æµ‹è¯•**ï¼šæ˜¯å¦éœ€è¦ä¸“é—¨çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼ˆArtilleryã€k6ç­‰ï¼‰ï¼Ÿ
- [ ] **è¦†ç›–ç‡è¦æ±‚**ï¼šæµ‹è¯•è¦†ç›–ç‡ç›®æ ‡æ˜¯å¤šå°‘ï¼ˆ80%ã€90%ï¼‰ï¼Ÿ

### **âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
#### **2.1 ä¼˜åŒ–å¤æ‚åº¦è¯„ä¼°**
- [ ] **åˆæœŸéœ€æ±‚**ï¼šé¡¹ç›®åˆæœŸæ˜¯å¦çœŸçš„éœ€è¦Redisç¼“å­˜å’Œé›†ç¾¤éƒ¨ç½²ï¼Ÿ
- [ ] **ç”¨æˆ·è§„æ¨¡**ï¼šé¢„æœŸçš„å¹¶å‘ç”¨æˆ·æ•°å’Œæ–‡ä»¶ä¸Šä¼ é‡æ˜¯å¤šå°‘ï¼Ÿ
- [ ] **æœåŠ¡å™¨èµ„æº**ï¼šç°æœ‰æœåŠ¡å™¨èµ„æºæ˜¯å¦æ”¯æŒé›†ç¾¤å’ŒRediséƒ¨ç½²ï¼Ÿ
- [ ] **ä¼˜åŒ–ä¼˜å…ˆçº§**ï¼šå“ªäº›æ€§èƒ½ä¼˜åŒ–åº”è¯¥ä¼˜å…ˆå®æ–½ï¼Ÿ
- [ ] **ç›‘æ§éœ€æ±‚**ï¼šéœ€è¦ä»€ä¹ˆç¨‹åº¦çš„æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦ï¼Ÿ

#### **2.2 æŠ€æœ¯é€‰å‹ç¡®è®¤**
- [ ] **ç¼“å­˜ç­–ç•¥**ï¼šæ˜¯å¦éœ€è¦Redisï¼Œè¿˜æ˜¯å†…å­˜ç¼“å­˜è¶³å¤Ÿï¼Ÿ
- [ ] **é›†ç¾¤éƒ¨ç½²**ï¼šæ˜¯å¦éœ€è¦Node.jsé›†ç¾¤ï¼Œè¿˜æ˜¯å•è¿›ç¨‹è¶³å¤Ÿï¼Ÿ
- [ ] **CDNéœ€æ±‚**ï¼šæ˜¯å¦éœ€è¦CDNæ¥åŠ é€Ÿæ–‡ä»¶è®¿é—®ï¼Ÿ
- [ ] **æ•°æ®åº“ä¼˜åŒ–**ï¼šSQLiteæ˜¯å¦æ»¡è¶³æ€§èƒ½éœ€æ±‚ï¼Œæ˜¯å¦éœ€è¦å‡çº§åˆ°PostgreSQL/MySQLï¼Ÿ
- [ ] **æ–‡ä»¶å­˜å‚¨**ï¼šæœ¬åœ°å­˜å‚¨æ˜¯å¦è¶³å¤Ÿï¼Œæ˜¯å¦éœ€è¦äº‘å­˜å‚¨ï¼ˆAWS S3ã€é˜¿é‡Œäº‘OSSï¼‰ï¼Ÿ

### **ğŸ“Š ç›‘æ§å’Œæ—¥å¿—**
#### **3.1 ç›‘æ§èŒƒå›´ç¡®è®¤**
- [ ] **ç³»ç»Ÿç›‘æ§**ï¼šéœ€è¦ç›‘æ§å“ªäº›ç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰ï¼Ÿ
- [ ] **åº”ç”¨ç›‘æ§**ï¼šéœ€è¦ç›‘æ§å“ªäº›åº”ç”¨æŒ‡æ ‡ï¼ˆè¯·æ±‚é‡ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ï¼‰ï¼Ÿ
- [ ] **ä¸šåŠ¡ç›‘æ§**ï¼šéœ€è¦ç›‘æ§å“ªäº›ä¸šåŠ¡æŒ‡æ ‡ï¼ˆä¸Šä¼ æˆåŠŸç‡ã€AIè°ƒç”¨æˆåŠŸç‡ï¼‰ï¼Ÿ
- [ ] **å‘Šè­¦ç­–ç•¥**ï¼šä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å‘é€å‘Šè­¦é€šçŸ¥ï¼Ÿ
- [ ] **æ—¥å¿—ä¿ç•™**ï¼šæ—¥å¿—éœ€è¦ä¿ç•™å¤šé•¿æ—¶é—´ï¼Ÿ

#### **3.2 ç›‘æ§å·¥å…·é€‰æ‹©**
- [ ] **æ—¥å¿—ç³»ç»Ÿ**ï¼šWinstonæ˜¯å¦è¶³å¤Ÿï¼Œè¿˜æ˜¯éœ€è¦ELKï¼ˆElasticsearchã€Logstashã€Kibanaï¼‰ï¼Ÿ
- [ ] **ç›‘æ§å¹³å°**ï¼šæ˜¯å¦éœ€è¦ä¸“ä¸šç›‘æ§å¹³å°ï¼ˆPrometheus + Grafanaï¼‰ï¼Ÿ
- [ ] **é”™è¯¯è¿½è¸ª**ï¼šæ˜¯å¦éœ€è¦é”™è¯¯è¿½è¸ªæœåŠ¡ï¼ˆSentryï¼‰ï¼Ÿ
- [ ] **æ€§èƒ½åˆ†æ**ï¼šæ˜¯å¦éœ€è¦APMå·¥å…·ï¼ˆNew Relicã€Datadogï¼‰ï¼Ÿ
- [ ] **å¥åº·æ£€æŸ¥**ï¼šå¥åº·æ£€æŸ¥æ¥å£åº”è¯¥åŒ…å«å“ªäº›ä¿¡æ¯ï¼Ÿ

### **ğŸš€ éƒ¨ç½²å’Œè¿ç»´**
#### **4.1 éƒ¨ç½²ç­–ç•¥ç¡®è®¤**
- [ ] **éƒ¨ç½²ç¯å¢ƒ**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå¦‚ä½•é…ç½®ï¼Ÿ
- [ ] **å®¹å™¨åŒ–**ï¼šæ˜¯å¦éœ€è¦Dockerå®¹å™¨åŒ–éƒ¨ç½²ï¼Ÿ
- [ ] **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šæ˜¯å¦éœ€è¦CI/CDè‡ªåŠ¨åŒ–éƒ¨ç½²ç®¡é“ï¼Ÿ
- [ ] **å›æ»šç­–ç•¥**ï¼šå¦‚ä½•å®ç°å¿«é€Ÿå›æ»šï¼Ÿ
- [ ] **æ•°æ®å¤‡ä»½**ï¼šæ•°æ®åº“å’Œæ–‡ä»¶å¦‚ä½•å¤‡ä»½å’Œæ¢å¤ï¼Ÿ

#### **4.2 è¿ç»´å·¥å…·å’Œæµç¨‹**
- [ ] **è¿›ç¨‹ç®¡ç†**ï¼šä½¿ç”¨ä»€ä¹ˆè¿›ç¨‹ç®¡ç†å·¥å…·ï¼ˆPM2ã€systemdï¼‰ï¼Ÿ
- [ ] **åå‘ä»£ç†**ï¼šNginxé…ç½®éœ€è¦å“ªäº›ç‰¹æ®Šè®¾ç½®ï¼Ÿ
- [ ] **SSLè¯ä¹¦**ï¼šå¦‚ä½•é…ç½®å’Œè‡ªåŠ¨æ›´æ–°SSLè¯ä¹¦ï¼Ÿ
- [ ] **æ–‡ä»¶æ¸…ç†**ï¼šä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶å¦‚ä½•å®šæœŸæ¸…ç†ï¼Ÿ
- [ ] **å®‰å…¨åŠ å›º**ï¼šéœ€è¦å“ªäº›å®‰å…¨æªæ–½ï¼ˆé˜²ç«å¢™ã€è®¿é—®æ§åˆ¶ï¼‰ï¼Ÿ

### **ğŸ”„ æ¸è¿›å¼å®æ–½**
#### **5.1 å®æ–½é˜¶æ®µåˆ’åˆ†**
- [ ] **MVPé˜¶æ®µ**ï¼šæœ€å°å¯è¡Œäº§å“åº”è¯¥åŒ…å«å“ªäº›æµ‹è¯•å’Œä¼˜åŒ–ï¼Ÿ
- [ ] **å¢å¼ºé˜¶æ®µ**ï¼šç¬¬äºŒé˜¶æ®µåº”è¯¥æ·»åŠ å“ªäº›æµ‹è¯•å’Œä¼˜åŒ–åŠŸèƒ½ï¼Ÿ
- [ ] **ä¼ä¸šçº§é˜¶æ®µ**ï¼šä»€ä¹ˆæ—¶å€™æ·»åŠ Redisã€é›†ç¾¤ç­‰ä¼ä¸šçº§åŠŸèƒ½ï¼Ÿ
- [ ] **å‡çº§è·¯å¾„**ï¼šå¦‚ä½•å¹³æ»‘å‡çº§ç°æœ‰ç³»ç»Ÿï¼Ÿ
- [ ] **é£é™©è¯„ä¼°**ï¼šæ¯ä¸ªé˜¶æ®µçš„ä¸»è¦é£é™©å’Œåº”å¯¹æªæ–½ï¼Ÿ

#### **5.2 æŠ€æœ¯å€ºåŠ¡ç®¡ç†**
- [ ] **ä»£ç è´¨é‡**ï¼šå¦‚ä½•ä¿è¯ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ï¼Ÿ
- [ ] **æ–‡æ¡£æ›´æ–°**ï¼šå¦‚ä½•ä¿æŒæ–‡æ¡£å’Œä»£ç åŒæ­¥ï¼Ÿ
- [ ] **é‡æ„è®¡åˆ’**ï¼šä»€ä¹ˆæ—¶å€™è¿›è¡Œä»£ç é‡æ„ï¼Ÿ
- [ ] **ä¾èµ–ç®¡ç†**ï¼šå¦‚ä½•ç®¡ç†ç¬¬ä¸‰æ–¹ä¾èµ–çš„ç‰ˆæœ¬å’Œå®‰å…¨æ›´æ–°ï¼Ÿ
- [ ] **æ€§èƒ½åŸºçº¿**ï¼šå¦‚ä½•å»ºç«‹å’Œç»´æŠ¤æ€§èƒ½åŸºçº¿ï¼Ÿ

---

## âœ… **ç¬¬ä¸ƒé˜¶æ®µå®æ–½Checklist**

### **ğŸ“‹ åŸºç¡€æµ‹è¯•å®æ–½æ£€æŸ¥**
- [ ] é…ç½®Jestæµ‹è¯•ç¯å¢ƒ
- [ ] å®ç°åç«¯APIå•å…ƒæµ‹è¯•
- [ ] å®ç°å‰ç«¯ç»„ä»¶å•å…ƒæµ‹è¯•
- [ ] é…ç½®æµ‹è¯•æ•°æ®åº“å’Œæ¸…ç†æœºåˆ¶
- [ ] å®ç°åŸºç¡€çš„é›†æˆæµ‹è¯•
- [ ] é…ç½®æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
- [ ] æ·»åŠ æµ‹è¯•è¿è¡Œè„šæœ¬åˆ°package.json

### **ğŸ§ª æµ‹è¯•ç”¨ä¾‹å¼€å‘æ£€æŸ¥**
- [ ] æ–‡ä»¶ä¸Šä¼ APIæµ‹è¯•ç”¨ä¾‹
- [ ] æ–‡ä»¶ç±»å‹éªŒè¯æµ‹è¯•ç”¨ä¾‹
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶æµ‹è¯•ç”¨ä¾‹
- [ ] å¤šæ¨¡æ€AIé›†æˆæµ‹è¯•ç”¨ä¾‹
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•ç”¨ä¾‹
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•ç”¨ä¾‹
- [ ] æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼ˆå¯é€‰ï¼‰

### **âš¡ åŸºç¡€æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥**
- [ ] æ·»åŠ gzipå‹ç¼©ä¸­é—´ä»¶
- [ ] é…ç½®è¯·æ±‚å¤§å°é™åˆ¶
- [ ] å®ç°åŸºç¡€çš„APIé™æµ
- [ ] ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ å¤„ç†é€»è¾‘
- [ ] æ·»åŠ é™æ€æ–‡ä»¶ç¼“å­˜å¤´
- [ ] å®ç°å›¾ç‰‡æ‡’åŠ è½½ï¼ˆå‰ç«¯ï¼‰
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢è¯­å¥

### **ğŸ“Š ç›‘æ§å’Œæ—¥å¿—æ£€æŸ¥**
- [ ] é…ç½®Winstonæ—¥å¿—ç³»ç»Ÿ
- [ ] å®ç°é”™è¯¯æ—¥å¿—è®°å½•
- [ ] æ·»åŠ è®¿é—®æ—¥å¿—è®°å½•
- [ ] å®ç°å¥åº·æ£€æŸ¥æ¥å£
- [ ] é…ç½®æ—¥å¿—è½®è½¬å’Œæ¸…ç†
- [ ] æ·»åŠ å…³é”®ä¸šåŠ¡æŒ‡æ ‡è®°å½•
- [ ] å®ç°ç®€å•çš„æ€§èƒ½ç›‘æ§

### **ğŸš€ éƒ¨ç½²å‡†å¤‡æ£€æŸ¥**
- [ ] ç¼–å†™ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡æ¡£
- [ ] é…ç½®ç¯å¢ƒå˜é‡æ¨¡æ¿
- [ ] ç¼–å†™å¯åŠ¨è„šæœ¬
- [ ] é…ç½®è¿›ç¨‹ç®¡ç†ï¼ˆPM2ï¼‰
- [ ] ç¼–å†™Nginxé…ç½®ç¤ºä¾‹
- [ ] å®ç°æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] ç¼–å†™éƒ¨ç½²æ£€æŸ¥æ¸…å•

### **ğŸ”§ é«˜çº§åŠŸèƒ½æ£€æŸ¥ï¼ˆç¬¬äºŒ/ä¸‰é˜¶æ®µï¼‰**
- [ ] é…ç½®Redisç¼“å­˜ï¼ˆç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ· > 100æ—¶ï¼‰
- [ ] å®ç°é›†ç¾¤éƒ¨ç½²ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼šç”¨æˆ· > 1000æ—¶ï¼‰
- [ ] é…ç½®Puppeteerç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç¬¬äºŒé˜¶æ®µï¼šéœ€è¦UIæµ‹è¯•æ—¶ï¼‰
- [ ] å®ç°æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼ˆç¬¬äºŒé˜¶æ®µï¼šå¤§æ–‡ä»¶éœ€æ±‚æ—¶ï¼‰
- [ ] é…ç½®CDNé›†æˆï¼ˆç¬¬äºŒé˜¶æ®µï¼šå…¨çƒè®¿é—®æ—¶ï¼‰
- [ ] å®ç°é«˜çº§ç›‘æ§ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼šä¼ä¸šçº§éœ€æ±‚æ—¶ï¼‰

### **ğŸ“ æ–‡æ¡£å’Œé…ç½®æ£€æŸ¥**
- [ ] æ›´æ–°æµ‹è¯•è¿è¡ŒæŒ‡å—
- [ ] ç¼–å†™æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£
- [ ] ç¼–å†™æ•…éšœæ’é™¤æŒ‡å—
- [ ] æ›´æ–°APIæ–‡æ¡£
- [ ] ç¼–å†™è¿ç»´æ‰‹å†Œ
- [ ] éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§

### **ğŸ” è´¨é‡ä¿è¯æ£€æŸ¥**
- [ ] ä»£ç é™æ€åˆ†ææ£€æŸ¥
- [ ] å®‰å…¨æ¼æ´æ‰«æ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] å…¼å®¹æ€§æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] ç¾éš¾æ¢å¤æµ‹è¯•

### **ğŸ¯ ä¸Šçº¿å‡†å¤‡æ£€æŸ¥**
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®éªŒè¯
- [ ] æ•°æ®å¤‡ä»½ç­–ç•¥éªŒè¯
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡
- [ ] ä¸Šçº¿æ£€æŸ¥æ¸…å•
- [ ] å›¢é˜ŸåŸ¹è®­å’Œæ–‡æ¡£äº¤ä»˜
- [ ] ç”¨æˆ·ä½¿ç”¨æŒ‡å—

### **ğŸ”„ æŒç»­ä¼˜åŒ–æ£€æŸ¥**
- [ ] æ€§èƒ½ç›‘æ§æ•°æ®æ”¶é›†
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†æœºåˆ¶
- [ ] æŠ€æœ¯å€ºåŠ¡è¯„ä¼°
- [ ] å‡çº§è·¯å¾„è§„åˆ’
- [ ] å®‰å…¨æ›´æ–°æœºåˆ¶
- [ ] ä»£ç è´¨é‡æŒç»­æ”¹è¿›

---

## ğŸš€ **é¡¹ç›®å®Œæˆæ€»ç»“**

### **ğŸ‰ æ­å–œï¼é™„ä»¶ä¸Šä¼ åŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆå·²å…¨éƒ¨å®Œæˆï¼**

### **ğŸ“‹ å®Œæ•´åŠŸèƒ½æ¸…å•**
1. **é¡¹ç›®æ¦‚è¿°å’Œéœ€æ±‚åˆ†æ** âœ…
2. **æŠ€æœ¯æ¶æ„è®¾è®¡** âœ…
3. **åŸºç¡€è®¾æ–½æ­å»º** âœ…
4. **æ•°æ®åº“ç»“æ„æ‰©å±•** âœ…
5. **åç«¯APIå¼€å‘** âœ…
6. **æ–‡ä»¶å­˜å‚¨ç®¡ç†** âœ…
7. **å¤šæ¨¡æ€AIé›†æˆ** âœ…
8. **å‰ç«¯ç»„ä»¶å¼€å‘** âœ…
9. **æµ‹è¯•å’Œä¼˜åŒ–** âœ…

### **ğŸ”§ æŠ€æœ¯äº®ç‚¹æ€»ç»“**
- **å®Œæ•´çš„åç«¯æ¶æ„**: ä»æ–‡ä»¶ä¸Šä¼ åˆ°AIé›†æˆçš„å®Œæ•´æµç¨‹
- **æ™ºèƒ½æ–‡ä»¶å¤„ç†**: æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹çš„æ™ºèƒ½å¤„ç†
- **å¤šæ¨¡æ€AIæ”¯æŒ**: é›†æˆGeminiã€GPTã€Claudeä¸‰ç§ä¸»æµAIæ¨¡å‹
- **ç°ä»£åŒ–å‰ç«¯**: React + TypeScript + Tailwind CSSçš„å®Œæ•´ç»„ä»¶åº“
- **æ¸è¿›å¼æµ‹è¯•**: å•å…ƒæµ‹è¯•ã€APIé›†æˆæµ‹è¯•ï¼ˆå½“å‰ï¼‰+ ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- **åˆ†é˜¶æ®µä¼˜åŒ–**: åŸºç¡€ä¼˜åŒ–ï¼ˆå½“å‰ï¼‰+ Redisç¼“å­˜ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰+ é›†ç¾¤éƒ¨ç½²ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰

---

## âš ï¸ **æ‰€æœ‰æ¨¡å—å¾…ç¡®è®¤äº‹é¡¹æ€»è§ˆ**

### **éœ€è¦åç»­å¼€å‘æ—¶ç¡®è®¤çš„é—®é¢˜**

#### **1. åŸºç¡€è®¾æ–½æ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] ä¾èµ–åŒ…ç‰ˆæœ¬é€‰æ‹©æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] ç›®å½•ç»“æ„è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] é…ç½®æ–‡ä»¶ç®¡ç†ç­–ç•¥æ˜¯å¦åˆé€‚ï¼Ÿ

#### **2. åç«¯APIæ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] APIç«¯ç‚¹çš„åŠŸèƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»–ç«¯ç‚¹ï¼Ÿ
- [ ] ç«¯ç‚¹å‚æ•°è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ˜¯å¦å®Œå–„ï¼Ÿ

#### **3. æ–‡ä»¶å­˜å‚¨ç®¡ç†æ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] æŒ‰æ—¥æœŸç»„ç»‡æ–‡ä»¶çš„ç­–ç•¥æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] æ¸…ç†ç­–ç•¥å‚æ•°æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ€§èƒ½ä¼˜åŒ–ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒäº‘å­˜å‚¨ï¼Ÿ

#### **4. å¤šæ¨¡æ€AIé›†æˆæ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] é™„ä»¶å¤„ç†ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿ
- [ ] APIè°ƒç”¨é…ç½®æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ æµå¼å“åº”ï¼Ÿ

#### **5. å‰ç«¯ç»„ä»¶å¼€å‘æ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] ç»„ä»¶åº“çš„è®¾è®¡ç³»ç»Ÿæ˜¯å¦ç»Ÿä¸€ï¼Ÿ
- [ ] æ‹–æ‹½ä¸Šä¼ çš„äº¤äº’æ˜¯å¦è¶³å¤Ÿå‹å¥½ï¼Ÿ
- [ ] ç§»åŠ¨ç«¯é€‚é…æ˜¯å¦å®Œå–„ï¼Ÿ
- [ ] ç»„ä»¶æ‡’åŠ è½½ç­–ç•¥æ˜¯å¦åˆç†ï¼Ÿ

#### **6. æµ‹è¯•å’Œä¼˜åŒ–æ¨¡å— (4ä¸ªé—®é¢˜)**
- [ ] æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- [ ] æ€§èƒ½æµ‹è¯•æŒ‡æ ‡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] é›†ç¾¤é…ç½®æ˜¯å¦åˆç†ï¼Ÿ

**æ€»è®¡**: 24ä¸ªå¾…ç¡®è®¤é—®é¢˜ï¼Œå°†åœ¨åç»­å¼€å‘æ—¶é€ä¸€ç¡®è®¤

---

## ğŸš€ **ä¸‹ä¸€æ­¥å»ºè®®**

### **å¼€å‘é˜¶æ®µå»ºè®®**
1. **ä»£ç å®ç°**: æŒ‰ç…§æŠ€æœ¯æ–¹æ¡ˆé€æ­¥å®ç°å„ä¸ªæ¨¡å—
2. **é—®é¢˜ç¡®è®¤**: åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç¡®è®¤è®°å½•çš„å¾…ç¡®è®¤äº‹é¡¹
3. **æµ‹è¯•éªŒè¯**: ä½¿ç”¨æä¾›çš„æµ‹è¯•å¥—ä»¶éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
4. **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´æ€§èƒ½å‚æ•°
5. **éƒ¨ç½²ä¸Šçº¿**: å®Œæˆå¼€å‘å’Œæµ‹è¯•åéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### **æŠ€æœ¯é€‰å‹å»ºè®®**
1. **å‰ç«¯**: React 18 + TypeScript + Tailwind CSS
2. **åç«¯**: Node.js + Express + SQLite
3. **æ–‡ä»¶å¤„ç†**: Multer + Sharp + PDF-parse
4. **AIé›†æˆ**: Gemini + GPT + Claude APIs
5. **æµ‹è¯•**: Jest + React Testing Libraryï¼ˆå½“å‰ï¼‰+ Puppeteerï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
6. **æ€§èƒ½**: åŸºç¡€ä¼˜åŒ–ï¼ˆå½“å‰ï¼‰+ Redis + é›†ç¾¤ï¼ˆç¬¬äºŒ/ä¸‰é˜¶æ®µï¼‰

**ğŸŠ é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆå¼€å‘å®Œæˆï¼æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ï¼**

## ğŸ“‹ **é¡¹ç›®å®ŒæˆçŠ¶æ€**

### **âœ… æŠ€æœ¯æ–¹æ¡ˆå®Œæˆæƒ…å†µ** - ğŸ‰ **ç¬¬äº”é˜¶æ®µåœ†æ»¡å®Œæˆ**
1. **é¡¹ç›®æ¦‚è¿°å’Œéœ€æ±‚åˆ†æ** - âœ… 100%
2. **æŠ€æœ¯æ¶æ„è®¾è®¡** - âœ… 100%
3. **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½æ­å»º** - âœ… 100%
4. **ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“ç»“æ„æ‰©å±•** - âœ… 100%
5. **ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯APIå¼€å‘** - âœ… 100% *(æ‰€æœ‰æ ¸å¿ƒAPIå·²å®Œæˆ)*
6. **ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶å­˜å‚¨ç®¡ç†** - âœ… 100%
7. **ğŸ‰ç¬¬äº”é˜¶æ®µï¼šå¤šæ¨¡æ€AIé›†æˆ** - âœ… **100%** *(è¶…é¢å®Œæˆï¼šæµå¼API+å¤šè½®å¯¹è¯+Claudeé¢„ç•™)*
8. **ç¬¬å…­é˜¶æ®µï¼šå‰ç«¯ç»„ä»¶å¼€å‘** - â³ **å¾…å¼€å§‹**
9. **ç¬¬ä¸ƒé˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–** - â³ **å¾…å¼€å§‹**

### **ğŸ“Š æ€»ä½“çŠ¶æ€** - **åç«¯æ ¸å¿ƒåŠŸèƒ½100%å®Œæˆ**
- **æŠ€æœ¯æ–¹æ¡ˆå®Œæˆåº¦**: 100% 
- **åç«¯å®ç°å®Œæˆåº¦**: 100% *(é˜¶æ®µ1-5å…¨éƒ¨å®Œæˆ)*
- **æ–‡æ¡£çŠ¶æ€**: å®Œæ•´ä¸”ç»Ÿä¸€ï¼ŒåŒ…å«æŠ€æœ¯å®ç°å¯¹ç…§è¡¨
- **æµ‹è¯•éªŒè¯**: å…¨é¢é€šè¿‡ï¼Œæ‰€æœ‰åŠŸèƒ½å®é™…éªŒè¯
- **ä¸‹ä¸€æ­¥**: ğŸš€ **å‡†å¤‡è¿›å…¥ç¬¬å…­é˜¶æ®µå‰ç«¯å¼€å‘**

### **ğŸ† ç¬¬äº”é˜¶æ®µå…³é”®æˆå°±**
- âœ… **Geminiå¤šæ¨¡æ€** - Base64ç­–ç•¥ï¼Œæ”¯æŒå›¾ç‰‡+æ–‡æ¡£
- âœ… **GPTå¤šæ¨¡æ€** - ä¸‰å±‚ç­–ç•¥ï¼Œå›¾ç‰‡+æ–‡æ¡£è§£æ+æè¿°
- âœ… **æµå¼APIæ”¯æŒ** - å®Œç¾æ”¯æŒé™„ä»¶çš„æµå¼èŠå¤©
- âœ… **å¤šè½®å¯¹è¯ä¿®å¤** - è§£å†³é˜²é‡å¤é€»è¾‘é—®é¢˜
- âœ… **Claudeæ¥å£é¢„ç•™** - å®Œæ•´çš„å¤šæ¨¡æ€æ¥å£é¢„ç•™
- âœ… **å…¨é¢æµ‹è¯•éªŒè¯** - æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡å®é™…æµ‹è¯•
