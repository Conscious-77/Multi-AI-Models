# 文件上传功能缺失记录

## 问题描述
项目目前**没有实现文件上传/附件功能**，用户无法在聊天中上传图片、文档等文件。

## 详细分析

### 当前缺失的功能
- ❌ 文件上传API接口（如 `/api/upload`）
- ❌ 文件上传前端组件
- ❌ 文件处理中间件
- ❌ 文件存储逻辑
- ❌ 文件类型验证
- ❌ 文件大小限制

### 缺失的依赖包
- ❌ `multer` - 处理multipart/form-data
- ❌ `formidable` - 替代的文件上传处理库
- ❌ 相关类型定义文件

### 现有相关功能
- ✅ PDF生成功能（通过Agent工具）
- ✅ 静态文件服务（`/generated/*.pdf`）
- ✅ 文件下载功能

## 影响分析

### 功能限制
1. **无法使用多模态AI能力**：如Gemini的图片理解功能
2. **无法分析用户上传的文档**：如PDF、Word文档等
3. **用户体验受限**：只能纯文本对话

### 业务影响
- 降低了AI助手的实用性
- 无法充分利用现代AI模型的多模态能力
- 用户可能需要寻找其他支持文件上传的AI工具

## 解决方案优先级

### 高优先级（核心功能完成后）
- 实现基础文件上传功能
- 支持图片、PDF等常见格式
- 集成到聊天界面

### 中优先级
- 文件类型验证
- 文件大小限制
- 文件存储优化

### 低优先级
- 文件预览功能
- 批量上传
- 文件管理界面

## 技术实现建议

### 后端实现
```javascript
// 需要添加的依赖
npm install multer

// 需要添加的API
app.post('/api/upload', upload.single('file'), (req, res) => {
  // 文件上传处理逻辑
});
```

### 前端实现
```jsx
// 需要添加的文件上传组件
<input type="file" onChange={handleFileUpload} />
```

### 数据库考虑
- 是否需要存储文件元数据
- 文件与消息的关联关系

## 当前状态
- **状态**: 功能缺失，已记录
- **优先级**: 低（在核心多模型功能完成后考虑）
- **影响范围**: 用户体验，AI能力发挥

## 备注
- 此功能相对独立，不影响当前的多模型支持开发
- 可以在后续版本中作为增强功能添加
- 建议先完成核心功能，再考虑此功能

---

## 🆕 字段差异处理方案讨论 (2025-08-31)

### **问题背景**
在实现文件上传功能时，需要考虑不同AI模型的API字段差异：
- **Gemini**: `attached_files` + `content`
- **GPT**: `attach_files` + `context`
- **Claude**: 可能使用其他字段名

### **推荐解决方案：统一字段接口 + 内部转换**

#### **方案优势**
1. **前端友好**: 开发者只需要学习一套API接口
2. **后端可控**: 字段转换逻辑集中管理
3. **易于维护**: 新增字段和模型都很简单
4. **扩展性强**: 可以处理任意复杂的字段差异

#### **实现思路**
```javascript
// 前端统一使用
{
  message: "用户消息",
  attached_files: [...],  // 统一字段名
  content: "额外内容"     // 统一字段名
}

// 后端根据模型类型转换
if (model === 'gemini') {
  geminiRequest = {
    contents: [...],
    attached_files: attached_files,  // 保持原字段
    content: content                 // 保持原字段
  }
} else if (model === 'gpt') {
  gptRequest = {
    messages: [...],
    attach_files: attached_files,    // 字段名转换
    context: content                 // 字段名转换
  }
}
```

#### **需要修改的地方**
- **前端**: 无变化，继续使用统一字段
- **后端**: 在 `convertRequestForModel` 函数中添加字段转换逻辑
- **API接口**: 无变化，保持现有的 `/api/chat` 和 `/api/chat/stream`

#### **修改工作量评估**
- **核心逻辑**: 约20-30行代码
- **测试验证**: 约1-2小时
- **总体影响**: 很小，主要是内部字段转换

### **其他方案对比**

| 方案 | 前端复杂度 | 后端复杂度 | 维护性 | 扩展性 | 推荐度 |
|------|------------|------------|--------|--------|--------|
| **统一字段接口** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🥇 |
| **模型特定接口** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | 🥉 |
| **配置驱动映射** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🥈 |

### **实施建议**
1. 采用统一字段接口方案
2. 在现有的 `convertMessagesForModel` 基础上扩展
3. 保持前端API接口不变
4. 在字段转换函数中处理模型差异

---

- **创建时间**: 2024年12月
- **状态**: 已记录，待后续处理
- **最后更新**: 2025-08-31 (添加字段差异处理方案讨论)
